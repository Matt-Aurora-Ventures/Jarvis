#!/usr/bin/env bash
set -euo pipefail

if command -v python >/dev/null 2>&1; then
  PYTHON_BIN=python
elif command -v python3 >/dev/null 2>&1; then
  PYTHON_BIN=python3
elif command -v wsl >/dev/null 2>&1; then
  # Windows fallback: run the scan inside WSL.
  # Resolve repo root and convert to a WSL path without requiring cygpath.
  REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
  REPO_WSL=""

  if [[ "${REPO_ROOT}" == /mnt/* ]]; then
    REPO_WSL="${REPO_ROOT}"
  elif [[ "${REPO_ROOT}" =~ ^/[A-Za-z]/ ]]; then
    # MSYS-style path: /c/Users/... -> /mnt/c/Users/...
    REPO_WSL="/mnt${REPO_ROOT}"
  elif [[ "${REPO_ROOT}" =~ ^[A-Za-z]:[\\\\/] ]]; then
    # Windows path: C:\Users\... or C:/Users/... -> /mnt/c/Users/...
    REPO_WSL="$(wsl wslpath "${REPO_ROOT}" 2>/dev/null || echo "")"
  fi

  if [ -z "${REPO_WSL:-}" ]; then
    echo "ERROR: python not found and could not resolve repo path for WSL; cannot run secret scan." >&2
    exit 1
  fi
  wsl -e bash -lc "cd '${REPO_WSL}' && python3 scripts/secret_scan_staged.py"
  exit $?
else
  echo "ERROR: python not found; cannot run secret scan." >&2
  exit 1
fi

"$PYTHON_BIN" scripts/secret_scan_staged.py
