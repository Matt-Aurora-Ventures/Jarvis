---
phase: 02.1-backtesting-pipeline
plan: 03
subsystem: backtest-api-store-integration
tags: [backtest, api, zustand, ohlcv, memecoin, graduation, validation, metadata]
dependency-graph:
  requires: [02.1-01]
  provides:
    - enhanced backtest API with data-source routing (bluechip/memecoin/xstock)
    - all 18 strategies in STRATEGY_CONFIGS
    - backtestMeta Zustand state with persistence
    - getPresetWithMeta helper
  affects:
    - 02.1-04 (backtest results displayed with validation badges)
    - UI components consuming strategy presets
tech-stack:
  added: []
  patterns:
    - strategy-category routing (bluechip -> real OHLCV, memecoin -> graduation synthetic, xstock -> server synthetic)
    - batched async fetch with Promise.all (3 at a time for rate limit safety)
    - runtime metadata overlay on const presets via Zustand backtestMeta
key-files:
  created: []
  modified:
    - src/app/api/backtest/route.ts
    - src/stores/useSniperStore.ts
decisions:
  - id: data-source-routing
    decision: Route strategies to data sources by category (bluechip/memecoin/xstock_index) rather than per-strategy
    rationale: Clean separation -- bluechips have real on-chain data, memecoins need graduation-calibrated synthetic, xStocks have no on-chain history
  - id: meme-quick-only
    decision: Force quick mode for memecoin graduation data (ignore full/grid mode requests)
    rationale: Graduation candle sets are 24-72 candles (1-3 days) -- too short for walk-forward or grid search
  - id: backtest-meta-overlay
    decision: Use separate backtestMeta Record in Zustand rather than modifying const STRATEGY_PRESETS
    rationale: Const array is source of truth for defaults; runtime overlay via Zustand persist preserves backtest results across sessions without mutating the const
metrics:
  duration: ~8 minutes
  completed: 2026-02-10
---

# Phase 02.1 Plan 03: Backtest API + Store Integration Summary

**One-liner:** Enhanced backtest API routing 18 strategies to real OHLCV (blue chips), graduation-calibrated synthetic (memecoins), or server synthetic (xStocks), with Zustand backtestMeta overlay for persistent validation metadata.

## What Was Done

### Task 1: Enhanced Backtest API Route (commit dbcb353)

Rewrote the backtest API to route each strategy to the appropriate data source:

- **Strategy classification:** Added `STRATEGY_CATEGORY` map assigning all 18 strategies to `bluechip`, `memecoin`, or `xstock_index`
- **Blue chip routing:** `runBluechipStrategy()` calls `fetchTokenHistory()` per blue chip token with batched `Promise.all` (3 at a time for rate limit safety). Uses 3-tier fallback: DexScreener -> Birdeye -> synthetic
- **Memecoin routing:** `runMemecoinStrategy()` calls `generateMemeGraduationCandles(200)` producing 200 synthetic token datasets across 4 pattern archetypes (moon/pump_dump/slow_bleed/dead_on_arrival). Forces quick mode (walk-forward/grid not meaningful on 24-72 candle series)
- **xStock/index/prestock routing:** `runXstockIndexStrategy()` uses `generateServerCandles()` with per-strategy volatility profiles (1.5%-8% daily)
- **7 missing strategies added:** `elite`, `hybrid_b`, `let_it_ride`, `loose`, `genetic_best`, `genetic_v2`, `prestock_speculative` -- all 18 now in `STRATEGY_CONFIGS`
- **Validation fields:** Each result summary includes `validated` (true if real data used) and `dataSource` ('dexscreener'/'birdeye'/'synthetic')
- **Underperformer detection:** Response includes `underperformers` array of strategy IDs where win rate < 40% OR profit factor < 1.0
- **Type safety:** Replaced `error: any` with `error: unknown` + instanceof check

### Task 2: Backtest Validation Metadata in Zustand Store (commit 7c1f414)

Extended the Zustand store with persistent backtest metadata:

- **StrategyPreset interface:** Added optional `backtested`, `dataSource`, `underperformer` fields
- **BacktestMetaEntry type:** New exported type for runtime backtest results
- **backtestMeta state:** `Record<string, BacktestMetaEntry>` in Zustand store, initialized as `{}`
- **updatePresetBacktestResults action:** Accepts array of results, merges into backtestMeta state
- **Persistence:** Added `backtestMeta` to `partialize` for localStorage persistence
- **Migration:** Added backtestMeta migration in `onRehydrateStorage` (graceful upgrade from stores without it)
- **getPresetWithMeta() helper:** Exported function that merges const `STRATEGY_PRESETS` with runtime `backtestMeta` overlay -- returns original preset if no backtest data exists

## Deviations from Plan

None -- plan executed exactly as written.

## Verification Results

| Check | Result |
|-------|--------|
| `npx tsc --noEmit` | 0 errors |
| `npx next build` | Success (13/13 pages) |
| `fetchTokenHistory` in route.ts | Line 17 (import), line 335 (usage) |
| `generateMemeGraduationCandles` in route.ts | Line 17 (import), line 366 (usage) |
| All 18 strategies in STRATEGY_CONFIGS | 18 `strategyId:` entries confirmed |
| `validated` + `underperformers` in route.ts | Lines 264/347/378/402/484/488/498 |
| `backtestMeta` in useSniperStore.ts | State (776), init (1282), partialize (1345), migration (1390) |
| `updatePresetBacktestResults` in useSniperStore.ts | Interface (778), implementation (1283) |
| `getPresetWithMeta` in useSniperStore.ts | Exported function (1443) |

## Commits

| Hash | Message |
|------|---------|
| dbcb353 | feat(02.1-03): enhance backtest API with hardened data sources and all 18 strategies |
| 7c1f414 | feat(02.1-03): add backtest validation metadata to Zustand store |

## Next Phase Readiness

- All 18 strategies now produce validation results via the API with appropriate data sources
- BacktestPanel (from Plan 02) can now call the enhanced API and receive validated/dataSource/underperformers
- useBacktest hook's Zustand bridge (`updatePresetBacktestResults`) is now wired -- backtest results will persist
- getPresetWithMeta() is ready for UI components to display backtested vs estimated win rates
- No blockers for subsequent plans
