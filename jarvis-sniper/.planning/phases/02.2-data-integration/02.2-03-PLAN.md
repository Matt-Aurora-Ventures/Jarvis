---
phase: 02.2-data-integration
plan: 03
type: execute
wave: 2
depends_on: ["02.2-01"]
files_modified:
  - src/hooks/useTVScreener.ts
  - src/components/MarketStatus.tsx
  - src/components/GraduationFeed.tsx
  - src/app/api/backtest/continuous/route.ts
autonomous: false

must_haves:
  truths:
    - "Market hours indicator shows current phase (Pre-Market / Regular / After-Hours / Closed) with appropriate color coding in the UI"
    - "xStocks panel displays TV-enriched data when available (RSI badge, technical rating, momentum score)"
    - "Continuous backtesting API endpoint accepts a POST request and runs daily validation on latest data for all strategies"
    - "UI polling adapts to market hours: 60s during market hours, 5min off-hours"
  artifacts:
    - path: "src/hooks/useTVScreener.ts"
      provides: "React hook for fetching and polling TV screener data with market-hours-aware intervals"
      exports: ["useTVScreener"]
    - path: "src/components/MarketStatus.tsx"
      provides: "Visual market phase indicator component"
      exports: ["MarketStatus"]
    - path: "src/app/api/backtest/continuous/route.ts"
      provides: "POST endpoint for continuous daily backtesting"
      exports: ["POST"]
  key_links:
    - from: "src/hooks/useTVScreener.ts"
      to: "/api/tv-screener"
      via: "fetch polling"
      pattern: "fetch.*api/tv-screener"
    - from: "src/components/MarketStatus.tsx"
      to: "src/lib/tv-screener.ts"
      via: "imports getMarketPhase"
      pattern: "import.*getMarketPhase"
    - from: "src/components/GraduationFeed.tsx"
      to: "src/components/MarketStatus.tsx"
      via: "renders MarketStatus in header area"
      pattern: "<MarketStatus"
    - from: "src/app/api/backtest/continuous/route.ts"
      to: "src/lib/backtest-engine.ts"
      via: "imports BacktestEngine, strategy functions"
      pattern: "import.*from.*backtest-engine"
---

<objective>
Add market hours UI indicator, TV data polling hook, and continuous backtesting API route.

Purpose: Market hours awareness (DATA-02) lets users know when equity data is stale vs live. The polling hook powers all TV data display in the UI. Continuous backtesting (BACK-04) enables daily strategy validation to detect drift. Together these complete Phase 2.2.

Output: A `useTVScreener` hook, `MarketStatus` UI component wired into the graduation feed, and a `/api/backtest/continuous` POST endpoint for daily strategy validation.
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.2-data-integration/02.2-01-SUMMARY.md

Key existing files:
@src/lib/tv-screener.ts — TVStockData, getMarketPhase, getCachedTVData (from Plan 01)
@src/components/GraduationFeed.tsx — Main token scanner component (where MarketStatus will be placed)
@src/app/api/backtest/route.ts — Existing backtest API with strategy classification and execution
@src/lib/backtest-engine.ts — BacktestEngine, entry signals, walk-forward, grid search
@src/lib/historical-data.ts — fetchTokenHistory, generateMemeGraduationCandles
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TV data polling hook and Market Status component</name>
  <files>src/hooks/useTVScreener.ts, src/components/MarketStatus.tsx, src/components/GraduationFeed.tsx</files>
  <action>
**1. Create `src/hooks/useTVScreener.ts`**

A React hook that fetches from `/api/tv-screener` with market-hours-aware polling:

```typescript
import { useState, useEffect, useCallback, useRef } from 'react';
import type { TVStockData } from '@/lib/tv-screener';
import { getMarketPhase, type MarketPhase } from '@/lib/tv-screener';
```

State: `data: Record<string, TVStockData>`, `loading: boolean`, `error: string | null`, `lastUpdated: Date | null`, `marketPhase: MarketPhase`.

Polling logic:
- During market hours (PRE_MARKET, REGULAR, AFTER_HOURS): poll every 60 seconds
- During CLOSED: poll every 300 seconds (5 minutes)
- Use `setTimeout` chaining (not setInterval) so interval adapts dynamically
- Clear timeout on unmount

The `fetchData` callback:
- Calls `fetch('/api/tv-screener')`
- Parses JSON, checks `success` field
- Updates state with data, timestamp, current market phase
- On error, sets error string but does NOT clear existing data (stale is better than empty)

Return: `{ data, loading, error, lastUpdated, marketPhase, refetch }`

**2. Create `src/components/MarketStatus.tsx`**

A small presentational component showing market phase:

Props: `{ marketPhase: MarketPhase; lastUpdated: Date | null }`

Renders:
- A pill/badge with phase name and colored dot:
  - PRE_MARKET: amber/yellow dot, text "Pre-Market"
  - REGULAR: green dot, text "Market Open"
  - AFTER_HOURS: blue dot, text "After-Hours"
  - CLOSED: gray dot, text "Market Closed"
- Below the badge (small text): relative time since last update ("Updated 30s ago")
- Use Tailwind CSS for styling. Match the existing dark terminal aesthetic:
  - Background: `bg-zinc-800/50` or similar
  - Border: `border border-zinc-700`
  - Text: `text-zinc-300` for label, colored for phase dot
  - Rounded: `rounded-md` or `rounded-full` for the pill

Keep it compact — this goes in a header bar, not a large card.

**3. Wire MarketStatus into GraduationFeed.tsx**

In `src/components/GraduationFeed.tsx`:
- Import `useTVScreener` and `MarketStatus`
- Call `useTVScreener()` at the component level (alongside existing hooks)
- Add `<MarketStatus marketPhase={marketPhase} lastUpdated={lastUpdated} />` in the header area of the graduation feed (near the top, alongside any existing status indicators or filter controls)
- The TV data from the hook can also be used later to show RSI/rating badges on individual token cards, but for this task just wire the hook and display the market status. The detailed per-token TV enrichment can be done in a future pass.

Do NOT break any existing functionality in GraduationFeed. The market status is additive.
  </action>
  <verify>
Run `npx tsc --noEmit` — zero type errors.
Run `npm run build` — build succeeds (Next.js compilation passes).
Visually verify: the MarketStatus component renders in GraduationFeed.
  </verify>
  <done>
useTVScreener hook polls /api/tv-screener with adaptive intervals. MarketStatus component displays current phase with color-coded indicator. GraduationFeed shows market status in its header. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create continuous backtesting API route</name>
  <files>src/app/api/backtest/continuous/route.ts</files>
  <action>
Create `src/app/api/backtest/continuous/route.ts` as a Next.js App Router POST endpoint for daily continuous backtesting (requirement BACK-04).

**Imports:**
```typescript
import { NextResponse } from 'next/server';
import {
  BacktestEngine,
  meanReversionEntry,
  trendFollowingEntry,
  breakoutEntry,
  momentumEntry,
  squeezeBreakoutEntry,
  generateBacktestReport,
  type BacktestConfig,
  type BacktestResult,
} from '@/lib/backtest-engine';
import { fetchTokenHistory, generateMemeGraduationCandles } from '@/lib/historical-data';
```

**POST handler body:**

Accept optional body: `{ strategies?: string[], threshold?: number }`
- `strategies`: array of strategy IDs to test (default: all 18 known strategies from the existing backtest route)
- `threshold`: minimum acceptable win rate (default: 0.45 = 45%)

**Logic:**

1. Define the same strategy classification and config lookup as in `/api/backtest/route.ts` (the existing `STRATEGY_CONFIG_MAP` and `getStrategyCategory` logic). Import or replicate the strategy configs for all 18 presets.

2. For each strategy:
   - Determine category (bluechip, memecoin, xstock_index)
   - Fetch appropriate test data:
     - Bluechip: `fetchTokenHistory()` for representative tokens (SOL, JUP, RAY)
     - Memecoin: `generateMemeGraduationCandles()` with 50 patterns (reduced from 100 for speed)
     - xstock_index: Synthetic candles (same approach as existing backtest route)
   - Run backtest using `BacktestEngine`
   - Record result

3. After all strategies tested, build a drift report:
```typescript
interface ContinuousBacktestReport {
  timestamp: string;
  strategiesRun: number;
  results: Array<{
    strategyId: string;
    winRate: number;
    profitFactor: number;
    totalTrades: number;
    status: 'healthy' | 'degraded' | 'failing';
    // healthy: winRate >= threshold
    // degraded: winRate >= threshold * 0.8
    // failing: winRate < threshold * 0.8
  }>;
  alerts: string[];  // Strategies that dropped below threshold
  overallHealth: 'green' | 'yellow' | 'red';
  // green: all healthy, yellow: any degraded, red: any failing
}
```

4. Return the report as JSON.

**Performance considerations:**
- Set a 120-second timeout on the route (via AbortSignal or Next.js route config)
- Use `export const maxDuration = 120;` for Vercel compatibility
- Run strategies sequentially (not parallel) to avoid memory pressure
- Log progress to console for observability

**Error handling:**
- If individual strategy fails, log error and continue with others
- Return partial results with error notes in `alerts` array

This endpoint is designed to be called by a cron job or manual trigger, not by the UI polling loop. It is intentionally a POST (side-effectful: fetches fresh data, runs compute-heavy backtests).
  </action>
  <verify>
Run `npx tsc --noEmit` — zero type errors.
Verify the route exports a POST function.
Verify the route file is in the correct App Router path: `src/app/api/backtest/continuous/route.ts`
  </verify>
  <done>
Continuous backtesting endpoint at /api/backtest/continuous accepts POST, runs all strategies against latest data, classifies each as healthy/degraded/failing, and returns a drift report with alerts for strategies below threshold. Build passes cleanly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Phase 2.2 complete:
1. TradingView screener API route at /api/tv-screener returning real stock data
2. Enhanced equity scoring blending DexScreener + TradingView indicators
3. Market hours indicator showing Pre-Market/Regular/After-Hours/Closed
4. Continuous backtesting endpoint at /api/backtest/continuous
  </what-built>
  <how-to-verify>
1. Start dev server: `cd jarvis-sniper && npm run dev`
2. Open http://localhost:3001
3. Navigate to the xStocks view — verify the Market Status indicator shows current phase
4. Check browser network tab for /api/tv-screener calls (should see periodic fetches)
5. Open http://localhost:3001/api/tv-screener in a new tab — verify JSON response with stock data (RSI, MACD, price, etc.)
6. Open http://localhost:3001/api/xstocks?category=XSTOCK — verify response includes `tv_enhanced`, `tv_momentum` fields
7. Test continuous backtesting: `curl -X POST http://localhost:3001/api/backtest/continuous` — verify JSON drift report
8. Verify scores look reasonable: xStocks with TV data should have different scores than those without
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero errors
2. `npm run build` — production build succeeds
3. `/api/tv-screener` returns stock data with RSI, MACD, technical ratings
4. `/api/xstocks` includes tv_enhanced scoring breakdown
5. MarketStatus component visible in GraduationFeed header
6. Polling adapts: 60s during market hours, 5min when closed
7. `/api/backtest/continuous` returns drift report with strategy health classifications
</verification>

<success_criteria>
- Market hours indicator correctly shows PRE_MARKET / REGULAR / AFTER_HOURS / CLOSED based on US Eastern Time
- useTVScreener hook provides data to consuming components with adaptive polling
- Continuous backtesting endpoint runs all strategies and classifies health
- Full build passes (npm run build) with zero TypeScript errors
- Phase 2.2 requirements DATA-01, DATA-02, and BACK-04 are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-data-integration/02.2-03-SUMMARY.md`
</output>
