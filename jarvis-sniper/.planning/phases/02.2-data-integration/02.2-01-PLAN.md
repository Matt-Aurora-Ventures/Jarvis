---
phase: 02.2-data-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/tv-screener.ts
  - src/app/api/tv-screener/route.ts
autonomous: true

must_haves:
  truths:
    - "API route /api/tv-screener returns real TradingView indicator data (RSI, MACD, volume, SMA, technicalRating) for all mapped xStocks/index/commodity tickers"
    - "Symbol mapping correctly translates all ~50 xStocks tickers (AAPLx -> AAPL, SPYx -> SPY, etc.) including edge cases (Vx -> V, BRK.Bx -> BRK.B)"
    - "Responses are cached for 60 seconds to avoid excessive TradingView API calls"
    - "API gracefully degrades with empty data when TradingView is unreachable"
  artifacts:
    - path: "src/lib/tv-screener.ts"
      provides: "Symbol mapping, TVStockData type, TradingView scan payload builder, response parser"
      exports: ["TVStockData", "XSTOCKS_TO_TV_SYMBOL", "TV_COLUMNS", "fetchTVScreenerData", "MarketPhase", "getMarketPhase"]
    - path: "src/app/api/tv-screener/route.ts"
      provides: "GET endpoint returning TradingView stock data for all mapped xStocks tickers"
      exports: ["GET"]
  key_links:
    - from: "src/app/api/tv-screener/route.ts"
      to: "src/lib/tv-screener.ts"
      via: "imports fetchTVScreenerData, XSTOCKS_TO_TV_SYMBOL"
      pattern: "import.*from.*tv-screener"
    - from: "src/lib/tv-screener.ts"
      to: "https://scanner.tradingview.com/global/scan"
      via: "POST request with JSON payload"
      pattern: "scanner\\.tradingview\\.com"
---

<objective>
Create the TradingView screener API integration: symbol mapping library, data fetching with cache, and Next.js API route.

Purpose: This is the data foundation for Phase 2.2. Without real TradingView stock data, we cannot enrich equity scoring or detect market hours. The research (`.planning/research/TVSCREENER.md`) has already validated the approach: direct HTTP POST to TradingView's scan endpoint (no auth, no Python dependency).

Output: A working `/api/tv-screener` GET endpoint that returns structured `TVStockData` for all ~50 xStocks/index/commodity tickers, plus a reusable library module.
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/TVSCREENER.md

Key existing files:
@src/lib/xstocks-data.ts — Token registry with all xStocks/prestock/index/commodity tickers and mint addresses
@src/app/api/xstocks/route.ts — Current equity scoring API (DexScreener-only), uses calcEquityScore()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TradingView screener library module</name>
  <files>src/lib/tv-screener.ts</files>
  <action>
Create `src/lib/tv-screener.ts` with the following components:

**1. Symbol Mapping (`XSTOCKS_TO_TV_SYMBOL`)**

Build a `Record<string, string>` mapping every ticker from `xstocks-data.ts` to its TradingView symbol. Import `ALL_TOKENIZED_EQUITIES` from `@/lib/xstocks-data` and generate programmatically where possible (strip trailing 'x'), with special-case overrides for:
- `Vx` -> `V` (Visa)
- `MAx` -> `MA` (Mastercard)
- `BRK.Bx` -> `BRK.B` (Berkshire)
- `GMEx` -> `GME` (GameStop)
- `GOOGLx` -> `GOOGL` (note: 'L' is part of real ticker)

Also create a reverse map `TV_SYMBOL_TO_XSTOCKS` for looking up xStocks tickers from TV symbols.

Skip PRESTOCK tickers (SPACEX, OPENAI, ANTHROPIC, XAI, ANDURIL, KALSHI, POLYMARKET) since they are pre-IPO and not on TradingView.

**2. TVStockData Interface**

Export the `TVStockData` interface exactly as defined in TVSCREENER.md Section 6 (lines 407-452), with all 40+ fields for price, indicators, volume, performance, pre/post market data.

**3. TV_COLUMNS Array**

Export the column names array matching the research document's field list (lines 359-405). These are the columns requested from TradingView's scan API. Order matters — response `d` array values correspond 1:1 with this array.

**4. MarketPhase Type & getMarketPhase()**

Export `type MarketPhase = 'PRE_MARKET' | 'REGULAR' | 'AFTER_HOURS' | 'CLOSED'` and a `getMarketPhase(): MarketPhase` function based on US Eastern Time. Logic:
- Weekend (Sat/Sun) -> CLOSED
- 4:00 AM - 9:29 AM ET -> PRE_MARKET
- 9:30 AM - 3:59 PM ET -> REGULAR
- 4:00 PM - 7:59 PM ET -> AFTER_HOURS
- Otherwise -> CLOSED

**5. fetchTVScreenerData()**

Export an async function that:
- Builds the POST payload for `https://scanner.tradingview.com/global/scan` using the mapped tickers
- Includes tickers across NASDAQ, NYSE, and AMEX exchanges (some stocks could be on any)
- Sends fetch with 15-second AbortSignal timeout
- Sets headers: Content-Type, User-Agent (browser-like), Origin, Referer (both tradingview.com)
- Parses the response `data` array where each item has `{ s: "EXCHANGE:TICKER", d: [...values] }`
- Maps d array values to TVStockData fields using column index correspondence
- Returns `Record<string, TVStockData>` keyed by REAL ticker (AAPL, not AAPLx)
- On error, returns empty Record (never throws — callers handle empty data gracefully)

**6. In-Memory Cache**

Add a module-level cache with 60-second TTL:
```typescript
let cachedData: { data: Record<string, TVStockData>; timestamp: number } | null = null;
const CACHE_TTL = 60_000;

export async function getCachedTVData(): Promise<Record<string, TVStockData>> {
  if (cachedData && Date.now() - cachedData.timestamp < CACHE_TTL) {
    return cachedData.data;
  }
  const data = await fetchTVScreenerData();
  cachedData = { data, timestamp: Date.now() };
  return data;
}
```

Do NOT import pandas, tvscreener, or any Python. This is pure TypeScript using fetch().
  </action>
  <verify>
Run `npx tsc --noEmit` from the jarvis-sniper directory. Zero type errors related to tv-screener.ts.
Verify the file exports: TVStockData, XSTOCKS_TO_TV_SYMBOL, TV_SYMBOL_TO_XSTOCKS, TV_COLUMNS, MarketPhase, getMarketPhase, fetchTVScreenerData, getCachedTVData.
  </verify>
  <done>
tv-screener.ts exists, compiles cleanly, exports all required types and functions. Symbol mapping covers all non-PRESTOCK tickers from xstocks-data.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TradingView API route</name>
  <files>src/app/api/tv-screener/route.ts</files>
  <action>
Create `src/app/api/tv-screener/route.ts` as a Next.js App Router GET endpoint:

```typescript
import { NextResponse } from 'next/server';
import { getCachedTVData, XSTOCKS_TO_TV_SYMBOL, getMarketPhase } from '@/lib/tv-screener';
import type { TVStockData } from '@/lib/tv-screener';
```

**GET handler:**
1. Call `getCachedTVData()` to get all TV stock data (cache-aware)
2. Build a response that maps xStocks tickers to their TV data:
   - For each entry in XSTOCKS_TO_TV_SYMBOL, look up the real ticker in the TV data
   - Include both the xStocks ticker and the real ticker in the response for easy consumption
3. Include metadata: `marketPhase`, `count`, `timestamp`, `success` boolean
4. Return JSON structure:
```json
{
  "success": true,
  "marketPhase": "REGULAR",
  "count": 42,
  "timestamp": "2026-02-10T...",
  "data": {
    "AAPL": { ...TVStockData },
    "MSFT": { ...TVStockData }
  },
  "xstocksMap": {
    "AAPLx": "AAPL",
    "MSFTx": "MSFT"
  }
}
```
5. On error, return `{ success: false, error: "message", data: {}, xstocksMap: {} }` with status 200 (not 500 — callers should gracefully handle empty data, not fail on HTTP errors)
6. Add `Cache-Control: public, s-maxage=30, stale-while-revalidate=60` header

Test the endpoint works by verifying the route file compiles and follows Next.js App Router conventions (named export `GET`).
  </action>
  <verify>
Run `npx tsc --noEmit`. Zero errors.
Verify the route exports a `GET` function.
  </verify>
  <done>
/api/tv-screener route exists, compiles, exports GET handler. Returns TradingView data keyed by real ticker with xStocks mapping included. Graceful error handling returns empty data instead of 500.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors across the project
2. `src/lib/tv-screener.ts` exists and exports: TVStockData, XSTOCKS_TO_TV_SYMBOL, TV_SYMBOL_TO_XSTOCKS, TV_COLUMNS, MarketPhase, getMarketPhase, fetchTVScreenerData, getCachedTVData
3. `src/app/api/tv-screener/route.ts` exists and exports: GET
4. Symbol mapping covers all XSTOCK, INDEX, and COMMODITY tickers from xstocks-data.ts (skip PRESTOCK)
5. No Python dependencies introduced
</verification>

<success_criteria>
- TradingView screener library module compiles and exports all required types/functions
- API route at /api/tv-screener returns structured stock data with 60s cache
- Symbol mapping handles all ~50 non-PRESTOCK tickers including edge cases
- MarketPhase detection works correctly for US Eastern Time
- Build passes with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-data-integration/02.2-01-SUMMARY.md`
</output>
