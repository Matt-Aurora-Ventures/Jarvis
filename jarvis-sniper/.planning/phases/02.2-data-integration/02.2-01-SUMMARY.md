---
phase: "02.2"
plan: "01"
subsystem: "data-integration"
tags: ["tradingview", "screener", "api", "typescript", "market-data", "xstocks"]
dependency-graph:
  requires: ["02.1 (backtesting pipeline)"]
  provides: ["TradingView screener library", "TV API route /api/tv-screener", "symbol mapping xStocks<->TV", "market phase detection"]
  affects: ["02.2-02 (enhanced scoring)", "02.2-03 (UI integration)"]
tech-stack:
  added: []
  patterns: ["in-memory cache with TTL", "direct HTTP to third-party scan API", "graceful degradation on fetch failure"]
key-files:
  created:
    - "src/lib/tv-screener.ts"
    - "src/app/api/tv-screener/route.ts"
  modified: []
decisions:
  - id: "D-02.2-01-A"
    decision: "Direct HTTP POST to TradingView scan endpoint instead of Python tvscreener library"
    rationale: "No Python dependency, lower latency, simpler deployment; underlying API is just a POST endpoint"
  - id: "D-02.2-01-B"
    decision: "Send each ticker across NASDAQ, NYSE, and AMEX exchanges with dedup by first match"
    rationale: "Some tickers (BRK.B, NVO, AZN) are listed on different exchanges; querying all three and keeping first-by-market-cap ensures we find every ticker"
  - id: "D-02.2-01-C"
    decision: "API route returns 200 with empty data on failure instead of 500"
    rationale: "Callers can gracefully degrade to DexScreener-only scoring without error handling for HTTP status codes"
metrics:
  duration: "~6 minutes"
  completed: "2026-02-10"
---

# Phase 2.2 Plan 01: TradingView Screener Integration Summary

**One-liner:** Pure TypeScript TradingView scan API integration with 60-ticker symbol mapping, 45-column data fetch, 60s cache, and graceful degradation

## What Was Built

### 1. TradingView Screener Library (`src/lib/tv-screener.ts`)

**Symbol Mapping:**
- `XSTOCKS_TO_TV_SYMBOL`: Maps all 60 non-PRESTOCK tickers from the token registry to their real TradingView symbols
- `TV_SYMBOL_TO_XSTOCKS`: Reverse map for lookup
- Special-case handling for: `Vx`->`V`, `MAx`->`MA`, `BRK.Bx`->`BRK.B`, `GMEx`->`GME`, `GOOGLx`->`GOOGL`
- Dynamically generated from `ALL_TOKENIZED_EQUITIES`, so new tokens added to the registry are automatically included

**TVStockData Interface:**
- 45 fields covering price, volume, oscillators (RSI, MACD, Stochastic, Williams %R, CCI, ADX, Momentum, Money Flow), aggregate ratings (technical, oscillators, MA), moving averages (SMA20/50/200, EMA20/50), Bollinger bands, volatility (ATR, daily), performance (week/month/3M/YTD), fundamentals (market cap, sector), pre/post market data, VWAP, beta

**TV_COLUMNS Array:**
- 45 ordered column names matching TradingView scan API request format
- Response `d` array indices map 1:1 to this array

**Market Phase Detection:**
- `MarketPhase` type: `'PRE_MARKET' | 'REGULAR' | 'AFTER_HOURS' | 'CLOSED'`
- `getMarketPhase()` function using US Eastern Time with correct market schedule

**Data Fetching:**
- `fetchTVScreenerData()`: POST to `scanner.tradingview.com/global/scan` with 15s timeout
- Sends tickers across NASDAQ/NYSE/AMEX, deduplicates by first match (highest market cap)
- Never throws -- returns empty Record on failure
- `getCachedTVData()`: 60-second in-memory cache wrapper

### 2. API Route (`src/app/api/tv-screener/route.ts`)

- `GET /api/tv-screener` endpoint
- Calls `getCachedTVData()` for 60s cached TradingView data
- Returns JSON with: `success`, `marketPhase`, `count`, `timestamp`, `data` (keyed by real ticker), `xstocksMap` (xStocks ticker -> real ticker)
- `Cache-Control: public, s-maxage=30, stale-while-revalidate=60`
- Graceful error handling: returns 200 with empty data, never 500

## Commits

| # | Hash | Message | Files |
|---|------|---------|-------|
| 1 | `b2ff435` | feat(02.2-01): create TradingView screener library module | `src/lib/tv-screener.ts` |
| 2 | `aa42809` | feat(02.2-01): create TradingView API route endpoint | `src/app/api/tv-screener/route.ts` |

## Verification Results

| Check | Result |
|-------|--------|
| `npx tsc --noEmit` | Zero errors |
| TVStockData exported | Yes |
| XSTOCKS_TO_TV_SYMBOL exported | Yes (60 tickers) |
| TV_SYMBOL_TO_XSTOCKS exported | Yes (60 tickers) |
| TV_COLUMNS exported | Yes (45 columns) |
| MarketPhase exported | Yes |
| getMarketPhase exported | Yes |
| fetchTVScreenerData exported | Yes |
| getCachedTVData exported | Yes |
| GET route handler exported | Yes |
| No Python dependencies | Confirmed |

## Deviations from Plan

None -- plan executed exactly as written.

## Next Phase Readiness

Plan 02.2-02 (Enhanced Scoring) can now import from `@/lib/tv-screener` to:
- Enrich `calcEquityScore()` with TradingView indicators
- Add momentum, volume confirmation, and sector rotation scores
- Use `getMarketPhase()` for market-hours-aware behavior
