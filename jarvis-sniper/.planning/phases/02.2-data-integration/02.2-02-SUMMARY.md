---
phase: "02.2"
plan: "02"
subsystem: "data-integration"
tags: ["tradingview", "scoring", "momentum", "volume", "tdd", "equity-scoring", "xstocks"]
dependency-graph:
  requires: ["02.2-01 (TV screener library)"]
  provides: ["TV-enhanced equity scoring library", "momentum scoring", "volume confirmation scoring", "composite blended scoring in xStocks route"]
  affects: ["02.2-03 (UI integration)", "frontend consumers of /api/xstocks"]
tech-stack:
  added: []
  patterns: ["TDD red-green-refactor", "weighted composite scoring", "graceful fallback (TV null -> DexScreener-only)", "non-blocking data enrichment"]
key-files:
  created:
    - "src/lib/tv-scoring.ts"
    - "src/lib/__tests__/tv-scoring.test.ts"
  modified:
    - "src/app/api/xstocks/route.ts"
decisions:
  - id: "D-02.2-02-A"
    decision: "Weight normalization for momentum score: contributions scaled proportionally to available indicators"
    rationale: "When some TradingView indicators are null (e.g. no SMA200), the remaining indicators' contributions are scaled up proportionally so the baseline stays centered at 50"
  - id: "D-02.2-02-B"
    decision: "Standalone calcBaseEquityScore in tv-scoring.ts (copy of route's calcEquityScore)"
    rationale: "Scoring library needs to compute DexScreener-only base scores independently, without importing from the route module. Original kept in route.ts as legacy reference"
  - id: "D-02.2-02-C"
    decision: "Non-blocking TV data fetch with try/catch in API route"
    rationale: "TV data enrichment should never cause the xStocks endpoint to fail; on error, scoring gracefully falls back to DexScreener-only"
metrics:
  duration: "~10 minutes"
  completed: "2026-02-10"
---

# Phase 2.2 Plan 02: TradingView-Enhanced Equity Scoring Summary

**One-liner:** TDD-built scoring library blending TradingView momentum (RSI, MACD, SMA alignment, technical rating) and volume confirmation with DexScreener on-chain data at 40/35/25% weighting, wired into xStocks API route with graceful fallback

## What Was Built

### 1. TV Scoring Library (`src/lib/tv-scoring.ts`)

**calcMomentumScore(tv: TVStockData): number**
- Returns 0-100 momentum score, baseline 50
- Components: RSI (30% weight), MACD (25%), Technical Rating (25%), SMA Trend (20%)
- RSI zones: >70 overbought penalty (-15), 55-70 bullish (+10), 45-55 neutral (0), 30-45 weak (-5), <30 oversold reversal (+15)
- MACD: above signal = +12, below = -8
- Technical Rating: maps -1..+1 range to -15..+15
- SMA: perfect uptrend (price > SMA20 > SMA50 > SMA200) = +10, downtrend = -10
- Null indicators are skipped with proportional weight adjustment

**calcVolumeConfirmation(tv: TVStockData, dexVolume24h: number): { score, volumeRatio }**
- Returns 0-100 volume score and the volume ratio
- Relative volume: >2.0 = +20, >1.5 = +10, <0.5 = -15
- Tokenized interest: dexVolume/dollarVolume ratio with 3-tier scoring
- Zero TV volume guard returns neutral 50

**calcBaseEquityScore(token, pair): number**
- Standalone copy of the original DexScreener-only scoring from xstocks route
- Trading Activity (0-30), Price Momentum (0-30), Market Quality (0-20), Asset Class Bonus (0-20)

**calcTVEnhancedScore(tv | null, dexPair, token): number**
- Composite score: 40% DexScreener base + 35% momentum + 25% volume confirmation
- Falls back to DexScreener-only when TV data is null
- Clamped to 10-100

**calcTVEnhancedScoreDetailed(...): TVEnhancedScore**
- Returns full breakdown: composite, momentum, volumeConfirmation, baseEquityScore, hasTVData

### 2. Unit Tests (`src/lib/__tests__/tv-scoring.test.ts`)

15 test cases across 4 describe blocks:

**calcMomentumScore (5 tests):**
- Bullish setup -> score > 70
- Bearish setup -> score < 35
- Neutral setup -> score 40-60
- Missing data (all null) -> returns 50
- Overbought penalty (RSI > 70) -> score <= 60

**calcVolumeConfirmation (4 tests):**
- Volume surge -> score > 65
- Low volume -> score < 40
- High tokenized interest -> bonus applied (score > 60)
- Zero TV volume -> neutral 50

**calcTVEnhancedScore (3 tests):**
- With TV data -> different score than without
- Without TV data -> valid DexScreener-only fallback (10-100)
- Composite weighting verified (40/35/25 blend)

**calcTVEnhancedScoreDetailed (3 tests):**
- Returns full TVEnhancedScore with hasTVData=true
- Returns hasTVData=false when null
- Clamps to 10-100 range on edge cases

### 3. xStocks API Route Update (`src/app/api/xstocks/route.ts`)

- Added imports: getCachedTVData, XSTOCKS_TO_TV_SYMBOL, calcTVEnhancedScoreDetailed, TVStockData
- TV data fetch: non-blocking getCachedTVData() after DexScreener batch fetch with try/catch
- Token mapping: replaced calcEquityScore with calcTVEnhancedScoreDetailed for composite scoring
- New response fields: tv_enhanced (boolean), tv_momentum (number), tv_volume_confirmation (number), tv_base_score (number)
- Original calcEquityScore kept with "Legacy" comment for backward compatibility reference
- Response shape fully backward compatible (graduations[] with score field preserved)

## Verification Results

1. `npx vitest run src/lib/__tests__/tv-scoring.test.ts` -- 15/15 tests pass
2. `npx vitest run` -- 94/94 tests pass across 8 test files
3. `npx tsc --noEmit` -- zero TypeScript errors
4. xStocks route includes tv_enhanced, tv_momentum, tv_volume_confirmation, tv_base_score fields
5. Fallback behavior preserved: null TV data -> DexScreener-only scoring

## Deviations from Plan

None -- plan executed exactly as written.

## Commits

| Hash | Message |
|------|---------|
| 97f5137 | feat(02.2-02): add TradingView-enhanced equity scoring library with tests |
| 5e61f0f | feat(02.2-02): wire TV-enhanced scoring into xStocks API route |

## Next Phase Readiness

Plan 02.2-03 (UI integration) can proceed. The API now returns TV-enhanced scoring breakdown fields that the UI can display:
- `tv_enhanced`: boolean flag indicating whether TV data was available
- `tv_momentum`: 0-100 momentum score for display/sorting
- `tv_volume_confirmation`: 0-100 volume score
- `tv_base_score`: the DexScreener-only component for comparison
