---
phase: 02.2-data-integration
plan: 02
type: tdd
wave: 2
depends_on: ["02.2-01"]
files_modified:
  - src/lib/tv-scoring.ts
  - src/lib/__tests__/tv-scoring.test.ts
  - src/app/api/xstocks/route.ts
autonomous: true

must_haves:
  truths:
    - "calcEquityScore() uses both on-chain DexScreener data AND off-chain TradingView indicators (RSI, MACD, technical rating, volume, SMA alignment) when TV data is available"
    - "Equity scores are demonstrably different (and more accurate) with TV data vs without — momentum alignment, volume confirmation, and technical ratings all contribute"
    - "When TradingView data is unavailable, scoring falls back gracefully to DexScreener-only (current behavior preserved)"
    - "Scoring functions have unit tests proving correct behavior for bullish, bearish, neutral, and missing-data scenarios"
  artifacts:
    - path: "src/lib/tv-scoring.ts"
      provides: "TradingView-enhanced scoring functions: calcMomentumScore, calcVolumeConfirmation, calcTVEnhancedScore"
      exports: ["calcMomentumScore", "calcVolumeConfirmation", "calcTVEnhancedScore", "TVEnhancedScore"]
    - path: "src/lib/__tests__/tv-scoring.test.ts"
      provides: "Unit tests for TV scoring functions"
      contains: "describe.*calcMomentumScore"
    - path: "src/app/api/xstocks/route.ts"
      provides: "Enhanced equity scoring using both DexScreener and TradingView data"
      contains: "calcTVEnhancedScore"
  key_links:
    - from: "src/app/api/xstocks/route.ts"
      to: "src/lib/tv-scoring.ts"
      via: "imports calcTVEnhancedScore"
      pattern: "import.*from.*tv-scoring"
    - from: "src/app/api/xstocks/route.ts"
      to: "src/lib/tv-screener.ts"
      via: "imports getCachedTVData, XSTOCKS_TO_TV_SYMBOL"
      pattern: "import.*from.*tv-screener"
    - from: "src/lib/tv-scoring.ts"
      to: "src/lib/tv-screener.ts"
      via: "imports TVStockData type"
      pattern: "import.*TVStockData.*from.*tv-screener"
---

<objective>
Create TradingView-enhanced equity scoring functions and wire them into the xStocks API route.

Purpose: The current `calcEquityScore()` in the xstocks route uses only DexScreener on-chain data (volume, liquidity, price change, buy/sell ratio). Adding TradingView indicators (RSI, MACD, SMA alignment, technical rating, relative volume) produces cross-referenced scores that better reflect actual stock market conditions. This fulfills requirement DATA-01.

Output: A tested `tv-scoring.ts` library with momentum, volume confirmation, and composite scoring. The xstocks route is updated to fetch TV data and blend it into equity scores.
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/TVSCREENER.md (Section 7: Scoring Enhancement)
@.planning/phases/02.2-data-integration/02.2-01-SUMMARY.md

Key existing files:
@src/app/api/xstocks/route.ts — Current calcEquityScore() function (lines 49-141) and GET handler
@src/lib/tv-screener.ts — TVStockData type, getCachedTVData(), XSTOCKS_TO_TV_SYMBOL (from Plan 01)
@src/lib/xstocks-data.ts — TokenizedEquity type
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TV scoring library with tests (TDD)</name>
  <files>src/lib/tv-scoring.ts, src/lib/__tests__/tv-scoring.test.ts</files>
  <action>
**This is a TDD task. Write tests first, then implement.**

**RED phase — Write failing tests first:**

Create `src/lib/__tests__/tv-scoring.test.ts` with test cases for three scoring functions. Use vitest (already configured in the project). Import types from `@/lib/tv-screener`.

Test cases for `calcMomentumScore(tv: TVStockData)`:
1. **Bullish setup** (RSI ~60, MACD above signal, price above SMA20/50/200, positive technical rating) -> score > 70
2. **Bearish setup** (RSI ~25, MACD below signal, price below SMAs, negative rating) -> score < 35
3. **Neutral setup** (RSI ~50, MACD near signal, mixed SMA alignment) -> score between 40-60
4. **Missing data** (all indicators null) -> returns 50 (neutral baseline)
5. **Overbought** (RSI > 70) -> applies penalty (score < 60 even with other bullish signals)

Test cases for `calcVolumeConfirmation(tv: TVStockData, dexVolume24h: number)`:
1. **Volume surge** (relativeVolume > 2.0, decent dexVolume) -> score > 65
2. **Low volume** (relativeVolume < 0.5, minimal dexVolume) -> score < 40
3. **High tokenized interest** (dexVolume / realDollarVolume > 0.01) -> bonus applied
4. **Zero TV volume** -> returns neutral 50

Test cases for `calcTVEnhancedScore(tv: TVStockData | null, dexPair: any, token: TokenizedEquity)`:
1. **With TV data** -> returns score different from DexScreener-only baseline
2. **Without TV data (null)** -> returns score from original calcEquityScore logic (fallback)
3. **Composite weighting** -> momentum (35%), volume (25%), original equity score (40%) blend

Create mock TVStockData objects for each scenario. Use `describe` blocks for each function.

**GREEN phase — Implement to pass:**

Create `src/lib/tv-scoring.ts` with:

**calcMomentumScore(tv: TVStockData): number**
Returns 0-100. Baseline 50. Components:
- RSI (30% weight): >70 overbought penalty (-15), 55-70 bullish (+10), <30 oversold reversal (+15), 30-45 weak (-5)
- MACD (25% weight): macdLevel > macdSignal = +12, else -8
- Technical Rating (25% weight): rating * 15 (maps -1..+1 to -15..+15)
- SMA Trend (20% weight): perfect uptrend (price > SMA20 > SMA50 > SMA200) = +10, downtrend (price < SMA20 < SMA50) = -10

If any indicator is null, skip that component (adjust baseline proportionally).

**calcVolumeConfirmation(tv: TVStockData, dexVolume24h: number): { score: number; volumeRatio: number }**
Returns score 0-100 and the volumeRatio. Baseline 50.
- Relative volume: >2.0 = +20, >1.5 = +10, <0.5 = -15
- Tokenized interest: (dexVolume24h / (tv.volume * tv.price)) > 0.01 = +15, > 0.001 = +5, < 0.0001 = -10
- Guard against division by zero (tv.volume * tv.price could be 0)

**calcTVEnhancedScore(tv: TVStockData | null, dexPair: any, token: TokenizedEquity): number**
The composite function:
- If `tv` is null: fall back to the original `calcEquityScore(token, dexPair)` logic (copy/import the existing scoring logic as `calcBaseEquityScore`)
- If `tv` is available: blend three components:
  - Original equity score from DexScreener data: 40% weight
  - Momentum score from TV data: 35% weight
  - Volume confirmation: 25% weight
- Clamp result to 10-100

Also export:
```typescript
export interface TVEnhancedScore {
  composite: number;
  momentum: number;
  volumeConfirmation: number;
  baseEquityScore: number;
  hasTVData: boolean;
}
```

And a detailed version: `calcTVEnhancedScoreDetailed(...)` that returns the full `TVEnhancedScore` object (used by the UI to show breakdown).

**REFACTOR phase:**
Ensure all tests pass. Clean up any duplication between the original `calcEquityScore` in xstocks/route.ts and the new `calcBaseEquityScore` in tv-scoring.ts.
  </action>
  <verify>
Run `npx vitest run src/lib/__tests__/tv-scoring.test.ts` — all tests pass.
Run `npx tsc --noEmit` — zero type errors.
  </verify>
  <done>
tv-scoring.ts exports calcMomentumScore, calcVolumeConfirmation, calcTVEnhancedScore, calcTVEnhancedScoreDetailed, TVEnhancedScore. All unit tests pass. Functions handle null TV data gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire TV-enhanced scoring into xStocks API route</name>
  <files>src/app/api/xstocks/route.ts</files>
  <action>
Update the existing xStocks API route to use TradingView-enhanced scoring:

**1. Add imports at the top:**
```typescript
import { getCachedTVData, XSTOCKS_TO_TV_SYMBOL } from '@/lib/tv-screener';
import { calcTVEnhancedScore, calcTVEnhancedScoreDetailed } from '@/lib/tv-scoring';
import type { TVStockData } from '@/lib/tv-screener';
```

**2. In the GET handler, after fetching DexScreener pair data, add TV data fetch:**

After the DexScreener batch fetch loop (around line 196), add:
```typescript
// Fetch TradingView data (cached, non-blocking)
let tvData: Record<string, TVStockData> = {};
try {
  tvData = await getCachedTVData();
} catch {
  // TV data is a nice-to-have, not a requirement
}
```

**3. Update the graduation mapping to use enhanced scoring:**

In the `tokens.map()` block (around line 199), replace the `score: calcEquityScore(token, pair)` line with:
```typescript
const tvTicker = XSTOCKS_TO_TV_SYMBOL[token.ticker];
const tvStock = tvTicker ? tvData[tvTicker] ?? null : null;
const scoreDetails = calcTVEnhancedScoreDetailed(tvStock, pair, token);
```

Then use `scoreDetails.composite` as the score and include the breakdown in the graduation object:
```typescript
score: scoreDetails.composite,
// ... existing fields ...
// Add new TV-enhanced fields
tv_enhanced: scoreDetails.hasTVData,
tv_momentum: scoreDetails.momentum,
tv_volume_confirmation: scoreDetails.volumeConfirmation,
tv_base_score: scoreDetails.baseEquityScore,
```

**4. Keep the original `calcEquityScore` function in the file** (do not delete it) for backward compatibility, but it is no longer called in the main path. Add a comment: `// Legacy: kept for reference. Active scoring uses calcTVEnhancedScore from tv-scoring.ts`

**5. Do NOT change the response shape** beyond adding the new `tv_*` fields. The `graduations` array structure must remain compatible with existing frontend consumers.
  </action>
  <verify>
Run `npx tsc --noEmit` — zero type errors.
Run `npx vitest run` — all existing and new tests pass.
Verify that the xstocks route still exports a GET function and the response includes `graduations[]` with `score` field.
  </verify>
  <done>
xStocks API route fetches TV data via getCachedTVData(), blends it into scoring via calcTVEnhancedScore, and includes TV-specific breakdown fields (tv_momentum, tv_volume_confirmation, tv_enhanced) in the response. Falls back to DexScreener-only scoring when TV data is unavailable. Build passes cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run src/lib/__tests__/tv-scoring.test.ts` — all tests pass (momentum, volume confirmation, composite scoring)
2. `npx tsc --noEmit` — zero errors across entire project
3. xStocks API response includes `tv_enhanced`, `tv_momentum`, `tv_volume_confirmation` fields
4. When TV data is unavailable (fetch fails), scores still return valid numbers (DexScreener-only fallback)
5. Scoring produces meaningfully different results with TV data vs without (verified in tests)
</verification>

<success_criteria>
- TV-enhanced scoring functions are tested with 10+ test cases covering bullish, bearish, neutral, and missing-data scenarios
- xStocks API route uses blended scoring (40% DexScreener + 35% momentum + 25% volume confirmation)
- Graceful fallback: TV failure results in DexScreener-only scoring (existing behavior preserved)
- All scores clamped to 10-100 range
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-data-integration/02.2-02-SUMMARY.md`
</output>
