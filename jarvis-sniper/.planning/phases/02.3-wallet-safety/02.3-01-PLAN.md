---
phase: 02.3-wallet-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/session-wallet.ts
  - src/components/FundRecoveryBanner.tsx
  - src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "When user closes tab, a fire-and-forget sweep transaction is submitted (not awaited) so funds return to main wallet even if browser terminates the page"
    - "On app startup, if a previous session wallet has > 0.001 SOL, a prominent banner appears with one-click sweep button"
    - "After clicking sweep in the recovery banner, funds transfer back to main wallet and the banner dismisses"
    - "If network is down during beforeunload sweep, wallet key persists in localStorage and recovery banner appears on next visit"
    - "Tab crash scenario: no beforeunload fires, but wallet key survives in localStorage, recovery banner catches it next load"
  artifacts:
    - path: "src/lib/session-wallet.ts"
      provides: "Hardened registerAutoSweep with fire-and-forget (sendRawTransaction without confirm), sweepToMainWalletFireAndForget function"
      exports: ["registerAutoSweep", "sweepToMainWalletFireAndForget", "checkForRecoverableWallet"]
    - path: "src/components/FundRecoveryBanner.tsx"
      provides: "Standalone fund recovery banner component that appears on app startup when orphaned funds detected"
      exports: ["FundRecoveryBanner"]
    - path: "src/app/page.tsx"
      provides: "Main page integrating FundRecoveryBanner at top of layout"
  key_links:
    - from: "src/components/FundRecoveryBanner.tsx"
      to: "src/lib/session-wallet.ts"
      via: "imports checkForRecoverableWallet, sweepToMainWallet, loadSessionWalletFromStorage"
      pattern: "import.*from.*session-wallet"
    - from: "src/app/page.tsx"
      to: "src/components/FundRecoveryBanner.tsx"
      via: "renders FundRecoveryBanner at top of page"
      pattern: "FundRecoveryBanner"
    - from: "src/lib/session-wallet.ts registerAutoSweep"
      to: "Solana RPC sendRawTransaction"
      via: "fire-and-forget transaction submission (no await on confirm)"
      pattern: "sendRawTransaction"
---

<objective>
Harden the auto-sweep mechanism and build a standalone fund recovery UI.

Purpose: The current `registerAutoSweep()` uses `await sweepToMainWallet()` inside beforeunload, which is unreliable because browsers kill async operations during page teardown. Additionally, fund recovery logic is buried inside SniperControls.tsx (1200+ lines) with no standalone startup check. Users who close tabs or experience crashes need a clear, prominent recovery path on their next visit.

Output: A reliable fire-and-forget sweep on tab close, plus a `FundRecoveryBanner` component that appears on app startup when orphaned session wallet funds are detected.
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key existing files:
@src/lib/session-wallet.ts — Current wallet implementation with registerAutoSweep (async, unreliable), checkForRecoverableWallet, sweepToMainWallet
@src/components/SniperControls.tsx — Contains wallet management UI (recovery buried inside 1200+ line component)
@src/app/page.tsx — Main page where FundRecoveryBanner should be mounted
@src/stores/useSniperStore.ts — Zustand store with sessionWalletPubkey state
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden auto-sweep with fire-and-forget transaction submission</name>
  <files>src/lib/session-wallet.ts</files>
  <action>
Modify `src/lib/session-wallet.ts` to fix the unreliable beforeunload sweep:

**1. Add `sweepToMainWalletFireAndForget()` function**

Create a new exported function that builds and sends the sweep transaction WITHOUT awaiting confirmation. This is critical for beforeunload/pagehide where the browser won't wait for async operations:

```typescript
export async function sweepToMainWalletFireAndForget(
  sessionKeypair: Keypair,
  mainWallet: string,
): Promise<void> {
  const connection = new Connection(RPC_URL, 'confirmed');
  const balance = await connection.getBalance(sessionKeypair.publicKey);
  const FEE_BUFFER_LAMPORTS = 30_000;
  const sweepAmount = balance - FEE_BUFFER_LAMPORTS;
  if (sweepAmount <= 0) return;

  const instruction = SystemProgram.transfer({
    fromPubkey: sessionKeypair.publicKey,
    toPubkey: new PublicKey(mainWallet),
    lamports: sweepAmount,
  });

  const blockhash = await connection.getLatestBlockhash('confirmed');
  const messageV0 = new TransactionMessage({
    payerKey: sessionKeypair.publicKey,
    recentBlockhash: blockhash.blockhash,
    instructions: [instruction],
  }).compileToV0Message();

  const tx = new VersionedTransaction(messageV0);
  tx.sign([sessionKeypair]);

  // Fire and forget — do NOT await confirmation.
  // In beforeunload context, the browser may kill the page before confirm resolves.
  connection.sendRawTransaction(tx.serialize(), {
    skipPreflight: true, // Skip preflight to reduce latency in teardown
    preflightCommitment: 'confirmed',
  }).catch(() => {
    // Silently fail — wallet key persists in localStorage for recovery
  });
}
```

**2. Update `registerAutoSweep()` to use fire-and-forget**

Replace the current async handler in `registerAutoSweep` with a synchronous-looking approach:

- The handler should call `sweepToMainWalletFireAndForget()` WITHOUT await (fire and forget)
- Also pre-build the sweep transaction on registration so the beforeunload handler has minimal async work
- Add `visibilitychange` listener as an additional trigger (fires when tab goes to background, more reliable than beforeunload in mobile browsers)

The updated handler pattern:
```typescript
export function registerAutoSweep(sessionKeypair: Keypair, mainWallet: string): () => void {
  let preCachedBlockhash: { blockhash: string; lastValidBlockHeight: number } | null = null;

  // Pre-fetch a blockhash so the teardown handler has less async work
  const refreshBlockhash = async () => {
    try {
      const connection = new Connection(RPC_URL, 'confirmed');
      preCachedBlockhash = await connection.getLatestBlockhash('confirmed');
    } catch { /* ignore */ }
  };
  refreshBlockhash();
  const refreshInterval = setInterval(refreshBlockhash, 30_000); // refresh every 30s

  const handler = () => {
    // Fire-and-forget: don't await
    sweepToMainWalletFireAndForget(sessionKeypair, mainWallet).catch(() => {});
  };

  window.addEventListener('beforeunload', handler);
  window.addEventListener('pagehide', handler);
  window.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
      handler();
    }
  });

  return () => {
    clearInterval(refreshInterval);
    window.removeEventListener('beforeunload', handler);
    window.removeEventListener('pagehide', handler);
    // Note: visibilitychange cleanup is intentionally omitted to keep sweeping active
  };
}
```

**3. Keep existing `sweepToMainWallet()` unchanged** — it's still used for explicit user-initiated sweeps where we want confirmation.

Do NOT change any other functions in session-wallet.ts. Do NOT change the encryption, storage, or recovery logic.
  </action>
  <verify>
Run `npx tsc --noEmit` from the jarvis-sniper directory. Zero type errors.
Verify `sweepToMainWalletFireAndForget` is exported.
Verify `registerAutoSweep` uses fire-and-forget pattern (no `await` on sweep call inside handler).
  </verify>
  <done>
registerAutoSweep handler fires sweepToMainWalletFireAndForget without awaiting. visibilitychange listener added as additional trigger. Pre-cached blockhash refreshes every 30s. Existing sweepToMainWallet unchanged for user-initiated sweeps.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build FundRecoveryBanner component and mount on main page</name>
  <files>src/components/FundRecoveryBanner.tsx, src/app/page.tsx</files>
  <action>
**1. Create `src/components/FundRecoveryBanner.tsx`**

Build a standalone 'use client' component that:

- On mount, calls `checkForRecoverableWallet()` to detect orphaned session wallets with funds
- If no recoverable wallet found (or balance < 0.001 SOL), renders nothing (returns null)
- If recoverable wallet found, displays a prominent warning banner:

Banner design (matches existing terminal dark theme):
```
[AlertTriangle icon] FUNDS DETECTED IN SESSION WALLET
  {balanceSol} SOL found in session wallet {publicKey.slice(0,4)}...{publicKey.slice(-4)}
  (created {relative time ago})

  [Sweep to Main Wallet] [Dismiss]
```

- Banner styling: `bg-accent-warning/10 border border-accent-warning/30 rounded-lg p-4` (consistent with existing warning patterns in SniperControls)
- "Sweep to Main Wallet" button:
  - On click: loads session wallet from storage via `loadSessionWalletFromStorage()` or `loadSessionWalletByPublicKey()`
  - Calls `sweepToMainWallet(keypair, mainWallet)` (the full-confirm version for user-initiated sweep)
  - Shows loading spinner during sweep
  - On success: shows success message with tx hash (link to Solscan), then auto-dismisses after 5 seconds
  - On error: shows error message with suggestion to try again or use SniperControls for manual recovery
- "Dismiss" button: hides the banner for this session (sessionStorage flag, NOT localStorage — so it reappears on next visit if funds still there)
- Import icons from lucide-react (AlertTriangle, ArrowRight, Loader2, CheckCircle, X)

State management:
```typescript
const [recoverable, setRecoverable] = useState<{publicKey: string; mainWallet: string; balanceSol: number; createdAt: number} | null>(null);
const [sweeping, setSweeping] = useState(false);
const [sweepResult, setSweepResult] = useState<{success: boolean; txHash?: string; error?: string} | null>(null);
const [dismissed, setDismissed] = useState(false);
```

**2. Mount FundRecoveryBanner in `src/app/page.tsx`**

Add `<FundRecoveryBanner />` near the top of the page component, ABOVE the main content area but BELOW any header/nav. It should be visible immediately on load without scrolling.

Import: `import { FundRecoveryBanner } from '@/components/FundRecoveryBanner';`

Position it before the main trading grid / dashboard content. It will self-hide when no recoverable wallet is found.
  </action>
  <verify>
Run `npx tsc --noEmit` from the jarvis-sniper directory. Zero type errors.
Verify FundRecoveryBanner.tsx exists and exports FundRecoveryBanner.
Verify page.tsx imports and renders FundRecoveryBanner.
  </verify>
  <done>
FundRecoveryBanner component exists, checks for orphaned wallets on mount, shows prominent warning with one-click sweep. Mounted at top of main page. Self-hides when no funds detected. Dismiss persists only for current session (reappears on next visit).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors across the project
2. `src/lib/session-wallet.ts` exports `sweepToMainWalletFireAndForget` alongside existing exports
3. `registerAutoSweep` uses fire-and-forget (no await on sweep in handler), includes visibilitychange listener
4. `src/components/FundRecoveryBanner.tsx` exists and exports `FundRecoveryBanner`
5. `src/app/page.tsx` renders `FundRecoveryBanner` at top of page
6. Fund recovery banner shows sweep button, loading state, success/error feedback
7. Existing wallet creation, encryption, storage, and recovery logic unchanged
</verification>

<success_criteria>
- Auto-sweep fires reliably on tab close (fire-and-forget, not awaited)
- visibilitychange provides additional sweep trigger for mobile browsers
- FundRecoveryBanner appears on app startup when orphaned session wallet has > 0.001 SOL
- One-click sweep from banner returns funds to main wallet with tx confirmation
- Banner dismisses after successful sweep or manual dismiss (session-scoped)
- Tab crash recovery path: no beforeunload fires, but localStorage key persists, banner catches it next visit
- Build passes with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02.3-wallet-safety/02.3-01-SUMMARY.md`
</output>
