---
phase: 02.3-wallet-safety
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/useSniperStore.ts
  - src/components/SniperControls.tsx
autonomous: true

must_haves:
  truths:
    - "Each asset class (memecoin, bluechip, xstock, index, prestock) can have its own maxConsecutiveLosses and maxDailyLossSol limits"
    - "When memecoin circuit breaker trips (e.g., 3 consecutive memecoin losses), blue chip and xstock trading continue unaffected"
    - "Per-asset breakers auto-reset after a configurable cooldown period (e.g., 15 minutes) without requiring manual intervention"
    - "The circuit breaker UI section in SniperControls shows per-asset breaker status and allows per-class limit configuration"
    - "Global breaker remains as a backstop: if total daily loss across ALL classes exceeds global limit, everything halts"
  artifacts:
    - path: "src/stores/useSniperStore.ts"
      provides: "PerAssetBreakerConfig type, perAssetBreakerConfig in SniperConfig, cooldown auto-reset logic in closePosition, per-asset limit checking"
      exports: ["PerAssetBreakerConfig", "AssetClassBreaker", "CircuitBreakerState"]
    - path: "src/components/SniperControls.tsx"
      provides: "Per-asset circuit breaker status display and per-class limit configuration UI"
  key_links:
    - from: "src/stores/useSniperStore.ts closePosition"
      to: "perAssetBreakerConfig"
      via: "reads per-asset limits from config when checking trip conditions"
      pattern: "perAssetBreakerConfig"
    - from: "src/stores/useSniperStore.ts snipeToken guard"
      to: "circuitBreaker.perAsset"
      via: "checks per-asset breaker status AND cooldown expiry before allowing snipe"
      pattern: "perAsset.*tripped|cooldown"
    - from: "src/components/SniperControls.tsx"
      to: "src/stores/useSniperStore.ts"
      via: "reads/writes perAssetBreakerConfig and displays per-asset breaker status"
      pattern: "perAssetBreakerConfig|circuitBreaker"
---

<objective>
Add configurable per-asset-class circuit breaker limits with auto-cooldown reset.

Purpose: The current circuit breaker uses the same global `maxConsecutiveLosses` and `maxDailyLossSol` for all asset classes. This means 3 memecoin losses halt blue chip trading too. Per-asset limits with cooldowns let memecoins (high volatility, high loss rate) have tighter limits while blue chips (lower volatility) get more room. Auto-cooldown prevents manual reset friction.

Output: Configurable per-class loss limits, auto-cooldown timers on tripped breakers, and UI controls to view/configure per-asset breaker settings.
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key existing files:
@src/stores/useSniperStore.ts — Zustand store with CircuitBreakerState, AssetClassBreaker, closePosition logic, snipeToken guard
@src/components/SniperControls.tsx — Circuit breaker toggle and global limit controls (around line 1080+)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add per-asset breaker config and cooldown logic to store</name>
  <files>src/stores/useSniperStore.ts</files>
  <action>
Modify `src/stores/useSniperStore.ts` to add configurable per-asset limits and auto-cooldown:

**1. Add `PerAssetBreakerConfig` interface (near `AssetClassBreaker`)**

```typescript
export interface PerAssetBreakerConfig {
  /** Max consecutive losses for this asset class (0 = use global default) */
  maxConsecutiveLosses: number;
  /** Max daily loss in SOL for this asset class (0 = use global default) */
  maxDailyLossSol: number;
  /** Cooldown in minutes after breaker trips before auto-reset (0 = no auto-reset, manual only) */
  cooldownMinutes: number;
}
```

**2. Add `perAssetBreakerConfig` to `SniperConfig` interface**

Add a new field after the existing circuit breaker fields:
```typescript
/** Per-asset-class circuit breaker overrides. Missing keys fall back to global limits. */
perAssetBreakerConfig: Record<AssetType, PerAssetBreakerConfig>;
```

**3. Add `cooldownUntil` field to `AssetClassBreaker` interface**

```typescript
export interface AssetClassBreaker {
  tripped: boolean;
  reason: string;
  trippedAt: number;
  consecutiveLosses: number;
  dailyLossSol: number;
  dailyResetAt: number;
  /** Timestamp when cooldown expires and breaker auto-resets (0 = no cooldown active) */
  cooldownUntil: number;
}
```

Update `makeDefaultAssetBreaker()` to include `cooldownUntil: 0`.

**4. Set default per-asset config in `DEFAULT_CONFIG`**

```typescript
perAssetBreakerConfig: {
  memecoin:  { maxConsecutiveLosses: 3, maxDailyLossSol: 0.3, cooldownMinutes: 15 },
  bluechip:  { maxConsecutiveLosses: 5, maxDailyLossSol: 1.0, cooldownMinutes: 30 },
  xstock:    { maxConsecutiveLosses: 4, maxDailyLossSol: 0.5, cooldownMinutes: 20 },
  index:     { maxConsecutiveLosses: 4, maxDailyLossSol: 0.5, cooldownMinutes: 20 },
  prestock:  { maxConsecutiveLosses: 3, maxDailyLossSol: 0.3, cooldownMinutes: 15 },
},
```

**5. Update `closePosition` per-asset trip logic**

In the section that checks per-asset trip conditions (around line 1047), modify to use per-asset config instead of global config:

```typescript
// Check per-asset trip conditions (isolate losses by asset class)
const assetCfg = cfg.perAssetBreakerConfig?.[posAssetType];
const assetMaxLosses = assetCfg?.maxConsecutiveLosses || cfg.maxConsecutiveLosses;
const assetMaxDailyLoss = assetCfg?.maxDailyLossSol || cfg.maxDailyLossSol;
const assetCooldownMs = (assetCfg?.cooldownMinutes || 0) * 60_000;

if (cfg.circuitBreakerEnabled && !ab.tripped) {
  if (assetMaxLosses > 0 && ab.consecutiveLosses >= assetMaxLosses) {
    ab.tripped = true;
    ab.reason = `${ab.consecutiveLosses} consecutive ${posAssetType} losses`;
    ab.trippedAt = now;
    ab.cooldownUntil = assetCooldownMs > 0 ? now + assetCooldownMs : 0;
  }
  if (assetMaxDailyLoss > 0 && ab.dailyLossSol >= assetMaxDailyLoss) {
    ab.tripped = true;
    ab.reason = `${posAssetType} daily loss ${ab.dailyLossSol.toFixed(3)} >= ${assetMaxDailyLoss} SOL`;
    ab.trippedAt = now;
    ab.cooldownUntil = assetCooldownMs > 0 ? now + assetCooldownMs : 0;
  }
}
```

**6. Update snipeToken guard to check cooldown expiry**

In the `snipeToken` / auto-snipe guard section (around line 1102-1104), add cooldown auto-reset logic:

```typescript
// Guard: circuit breaker tripped (global or per-asset)
if (state.circuitBreaker.tripped) return;
const assetBreaker = state.circuitBreaker.perAsset[state.assetFilter];
if (assetBreaker?.tripped) {
  // Check cooldown expiry — auto-reset if cooldown has passed
  if (assetBreaker.cooldownUntil > 0 && Date.now() >= assetBreaker.cooldownUntil) {
    // Auto-reset this asset's breaker (cooldown expired)
    set((s) => {
      const cb = { ...s.circuitBreaker, perAsset: { ...s.circuitBreaker.perAsset } };
      cb.perAsset[s.assetFilter] = {
        ...makeDefaultAssetBreaker(),
        dailyLossSol: assetBreaker.dailyLossSol, // preserve daily accumulator
        dailyResetAt: assetBreaker.dailyResetAt,
      };
      return { circuitBreaker: cb };
    });
    // Don't return — allow the snipe to proceed after reset
  } else {
    return; // Still in cooldown, block the snipe
  }
}
```

**7. Update Zustand persist migration**

In the `migrate` function (around line 1352), add migration for the new config field:

```typescript
// Migrate perAssetBreakerConfig (added in Phase 2.3 hardening)
if (!state.config.perAssetBreakerConfig) {
  state.config.perAssetBreakerConfig = DEFAULT_CONFIG.perAssetBreakerConfig;
}
// Migrate cooldownUntil on existing per-asset breakers
for (const k of Object.keys(cbDefault.perAsset) as AssetType[]) {
  const ab = (state.circuitBreaker.perAsset as any)[k];
  if (ab && typeof ab.cooldownUntil === 'undefined') {
    ab.cooldownUntil = 0;
  }
}
```

Do NOT modify the global breaker logic — it remains as a backstop across all asset classes. Do NOT change position types, budget logic, or strategy presets.
  </action>
  <verify>
Run `npx tsc --noEmit` from the jarvis-sniper directory. Zero type errors.
Verify `PerAssetBreakerConfig` is exported from the store.
Verify `AssetClassBreaker` now includes `cooldownUntil` field.
Verify `DEFAULT_CONFIG.perAssetBreakerConfig` has entries for all 5 asset types.
Grep for `cooldownUntil` to confirm it's used in closePosition and snipeToken guard.
  </verify>
  <done>
Per-asset breaker configs with independent maxConsecutiveLosses, maxDailyLossSol, and cooldownMinutes for each asset class. Auto-cooldown resets breaker when timer expires. Global breaker unchanged as backstop. Zustand migration handles existing state.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add per-asset circuit breaker UI to SniperControls</name>
  <files>src/components/SniperControls.tsx</files>
  <action>
Modify `src/components/SniperControls.tsx` to display per-asset circuit breaker status and allow per-class limit configuration.

**1. Add per-asset breaker status display**

In the Circuit Breaker section of SniperControls (find the section that shows the global breaker toggle and limits), add a new subsection below the global controls:

**Per-Asset Breaker Status Panel:**
- Show a compact grid/list of all 5 asset types
- For each asset type, show:
  - Asset name (icon + label: e.g., "Memecoin", "Blue Chip")
  - Status indicator: green dot = OK, red dot = TRIPPED, yellow dot = COOLDOWN
  - Consecutive losses count: `{ab.consecutiveLosses} / {limit}`
  - Daily loss: `{ab.dailyLossSol.toFixed(3)} / {limit} SOL`
  - If tripped with cooldown: show countdown timer "Resets in {minutes}m {seconds}s"
  - If tripped without cooldown: show "Manual reset required"
- Use a 5-column mini-grid on desktop, 2-column on mobile
- Styling: small text (text-[10px] or text-[11px]), compact spacing to fit terminal aesthetic

**2. Add per-class limit configuration**

Below the status panel, add an expandable "Per-Asset Limits" section (collapsed by default, toggle with ChevronDown/Up):

For each asset type, show 3 inline number inputs:
- Max Losses: number input (min 0, max 20, step 1)
- Max Daily Loss: number input (min 0, max 10, step 0.1) with "SOL" suffix
- Cooldown: number input (min 0, max 120, step 5) with "min" suffix

Wire inputs to `store.config.perAssetBreakerConfig[assetType]` via store's `setConfig` or direct `set()`.

Use a compact table/grid layout:
```
Asset        | Max Losses | Daily Limit | Cooldown
Memecoin     | [3]        | [0.3] SOL   | [15] min
Blue Chip    | [5]        | [1.0] SOL   | [30] min
xStock       | [4]        | [0.5] SOL   | [20] min
Index        | [4]        | [0.5] SOL   | [20] min
PreStock     | [3]        | [0.3] SOL   | [15] min
```

**3. Add per-asset reset buttons**

Next to each tripped asset breaker, show a small "Reset" button that clears just that asset's breaker:
```typescript
const resetAssetBreaker = (assetType: AssetType) => {
  useSniperStore.setState((s) => {
    const cb = { ...s.circuitBreaker, perAsset: { ...s.circuitBreaker.perAsset } };
    cb.perAsset[assetType] = makeDefaultAssetBreaker();
    return { circuitBreaker: cb };
  });
};
```

Import `makeDefaultAssetBreaker` — if it's not exported, export it from the store file (add `export` to the existing function declaration).

**4. Cooldown countdown timer**

For tripped breakers with active cooldowns, use a small `useEffect` with `setInterval` to update a countdown display every second:
```typescript
const [now, setNow] = useState(Date.now());
useEffect(() => {
  const id = setInterval(() => setNow(Date.now()), 1000);
  return () => clearInterval(id);
}, []);
```

Then for each breaker: if `ab.tripped && ab.cooldownUntil > now`, show `Math.ceil((ab.cooldownUntil - now) / 60000)` minutes remaining.

Keep the implementation compact. The entire per-asset section should add no more than ~100-150 lines to SniperControls.tsx.
  </action>
  <verify>
Run `npx tsc --noEmit` from the jarvis-sniper directory. Zero type errors.
Verify the per-asset breaker status section renders for all 5 asset types.
Verify the per-class limit inputs are wired to store.config.perAssetBreakerConfig.
Verify cooldown countdown displays for tripped breakers.
  </verify>
  <done>
Per-asset circuit breaker status visible in SniperControls with OK/TRIPPED/COOLDOWN indicators. Per-class limit configuration available in expandable section. Per-asset reset buttons work. Cooldown countdown timer shows remaining time. All 5 asset types displayed.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors across the project
2. `PerAssetBreakerConfig` exported from store with maxConsecutiveLosses, maxDailyLossSol, cooldownMinutes
3. `AssetClassBreaker` includes cooldownUntil field
4. `closePosition` uses per-asset config limits (not just global)
5. `snipeToken` guard auto-resets expired cooldowns
6. SniperControls shows per-asset breaker status with countdown timers
7. Per-class limits configurable via UI inputs
8. Per-asset reset buttons clear individual breakers
9. Global breaker unchanged as backstop
10. Zustand migration handles existing state without data loss
</verification>

<success_criteria>
- Memecoin consecutive losses do NOT disable blue chip or xstock trading
- Each asset class has independent maxConsecutiveLosses, maxDailyLossSol, cooldownMinutes
- Tripped per-asset breakers auto-reset after cooldown expires
- UI shows real-time per-asset breaker status with countdown timers
- Per-class limits configurable without code changes
- Global breaker still halts everything if total losses exceed global limits
- Build passes with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02.3-wallet-safety/02.3-02-SUMMARY.md`
</output>
