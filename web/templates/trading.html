<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvis Perps</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg:       #0a0d14;
            --bg2:      #0f1520;
            --card:     #111827;
            --card2:    #151d2e;
            --border:   #1c2640;
            --ink:      #e2e8f0;
            --muted:    #5a6a85;
            --green:    #14f195;
            --green2:   #0ecf7e;
            --red:      #f04d4d;
            --gold:     #fbbf24;
            --blue:     #3b82f6;
            --purple:   #8b5cf6;
            --mono:     "IBM Plex Mono", monospace;
            --sans:     "Space Grotesk", system-ui, sans-serif;
            --radius:   12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--sans);
            background: var(--bg);
            color: var(--ink);
            min-height: 100vh;
            font-size: 14px;
        }

        /* ── SCROLLBAR ──────────────────────────────────── */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* ── NAV ────────────────────────────────────────── */
        nav {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 0 24px;
            height: 52px;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-logo {
            font-family: var(--mono);
            font-size: 16px;
            font-weight: 700;
            color: var(--green);
            letter-spacing: 3px;
            white-space: nowrap;
        }

        .ticker-strip {
            display: flex;
            gap: 6px;
            flex: 1;
            overflow: hidden;
        }

        .ticker-chip {
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 4px 10px;
            font-family: var(--mono);
            font-size: 11px;
            white-space: nowrap;
            transition: border-color .2s;
            cursor: pointer;
        }

        .ticker-chip:hover { border-color: var(--muted); }
        .ticker-chip.active { border-color: var(--green); background: #14f1950a; }

        .ticker-chip .t-sym  { color: var(--muted); font-weight: 600; }
        .ticker-chip .t-price { color: var(--ink); font-weight: 600; }
        .ticker-chip .t-chg   { font-size: 10px; }
        .ticker-chip .t-chg.up   { color: var(--green); }
        .ticker-chip .t-chg.down { color: var(--red); }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        /* ── ARM BADGE ─────────────────────────────────── */
        .arm-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: 8px;
            font-family: var(--mono);
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
            border: 1px solid var(--border);
            background: var(--bg2);
            color: var(--muted);
            cursor: pointer;
            transition: all .2s;
            text-transform: uppercase;
        }

        .arm-badge.armed    { border-color: #14f19560; background: #14f19515; color: var(--green); }
        .arm-badge.prepared { border-color: #fbbf2460; background: #fbbf2415; color: var(--gold); }
        .arm-badge.disarmed { border-color: #f04d4d40; background: #f04d4d10; color: var(--red); }
        .arm-badge.down     { border-color: var(--border); color: var(--muted); }

        .btn-wallet {
            padding: 5px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--muted);
            font-family: var(--mono);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all .15s;
        }

        .btn-wallet:hover { border-color: var(--green); color: var(--green); }
        .btn-wallet.connected { border-color: var(--green); color: var(--green); background: #14f1950a; }

        /* ── PAGE LAYOUT ────────────────────────────────── */
        .page { padding: 16px 20px 40px; max-width: 1640px; margin: 0 auto; }

        /* ── MAIN GRID: chart | signal+order ────────────── */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 12px;
            margin-bottom: 12px;
        }

        /* ── CARD ───────────────────────────────────────── */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }

        .card-header {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            color: var(--muted);
            padding: 14px 16px 0;
        }

        .card-body { padding: 12px 16px 16px; }

        /* ── CHART CARD ─────────────────────────────────── */
        .chart-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .chart-toolbar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
        }

        .market-tabs { display: flex; gap: 3px; }

        .tab {
            padding: 5px 12px;
            border-radius: 6px;
            border: 1px solid transparent;
            background: transparent;
            color: var(--muted);
            font-family: var(--mono);
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all .15s;
        }

        .tab:hover { color: var(--ink); background: var(--bg2); }
        .tab.active { border-color: var(--green); background: #14f19512; color: var(--green); }

        .chart-price-area {
            margin-left: auto;
            text-align: right;
        }

        .chart-big-price {
            font-family: var(--mono);
            font-size: 20px;
            font-weight: 700;
            color: var(--ink);
        }

        .chart-sub {
            font-family: var(--mono);
            font-size: 10px;
            color: var(--muted);
        }

        #price-chart { height: 340px; width: 100%; }

        /* ── RIGHT SIDEBAR ──────────────────────────────── */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* ── RUNNER STATUS CARD ─────────────────────────── */
        .runner-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .runner-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--muted);
            flex-shrink: 0;
        }

        .runner-dot.healthy  { background: var(--green); box-shadow: 0 0 6px var(--green); }
        .runner-dot.degraded { background: var(--gold); box-shadow: 0 0 6px var(--gold); }
        .runner-dot.down     { background: var(--red); }

        .runner-info { flex: 1; }
        .runner-info .runner-label {
            font-family: var(--mono);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .runner-info .runner-sub {
            font-size: 10px;
            color: var(--muted);
            margin-top: 2px;
        }

        .btn-runner {
            padding: 5px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg2);
            color: var(--muted);
            font-family: var(--mono);
            font-size: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all .15s;
        }

        .btn-runner:hover { border-color: var(--green); color: var(--green); }
        .btn-runner.stop { border-color: var(--red); color: var(--red); }
        .btn-runner.stop:hover { background: #f04d4d15; }

        /* ── AI SIGNAL CARD ─────────────────────────────── */
        .signal-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px 16px;
        }

        .signal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .signal-title {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            color: var(--muted);
        }

        .signal-stale {
            font-family: var(--mono);
            font-size: 9px;
            color: var(--muted);
            padding: 2px 6px;
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        .signal-direction {
            font-family: var(--mono);
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .signal-direction.long  { color: var(--green); }
        .signal-direction.short { color: var(--red); }
        .signal-direction.none  { color: var(--muted); }

        .signal-conf-bar {
            height: 4px;
            background: var(--bg2);
            border-radius: 2px;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .signal-conf-fill {
            height: 100%;
            border-radius: 2px;
            transition: width .4s ease;
        }

        .signal-meta {
            display: flex;
            gap: 12px;
            font-family: var(--mono);
            font-size: 10px;
            color: var(--muted);
        }

        .signal-meta span { white-space: nowrap; }

        /* ── ORDER PANEL ────────────────────────────────── */
        .order-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
        }

        .order-card .card-header { padding: 0; margin-bottom: 4px; }

        .direction-toggle {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }

        .dir-btn {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg2);
            color: var(--muted);
            font-family: var(--mono);
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all .15s;
        }

        #dir-long.active  { border-color: var(--green); background: #14f19512; color: var(--green); }
        #dir-short.active { border-color: var(--red);   background: #f04d4d12; color: var(--red); }

        .field-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--muted);
            letter-spacing: 0.4px;
            margin-bottom: 4px;
        }

        .field-group { display: flex; flex-direction: column; }

        input[type="number"], input[type="text"], select {
            font-family: var(--mono);
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg2);
            color: var(--ink);
            font-size: 12px;
            width: 100%;
            outline: none;
            transition: border-color .15s;
        }

        input:focus, select:focus { border-color: var(--blue); }

        input[type="range"] {
            width: 100%;
            accent-color: var(--green);
            height: 3px;
            cursor: pointer;
        }

        .leverage-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        .leverage-tag {
            font-family: var(--mono);
            font-size: 13px;
            font-weight: 700;
            color: var(--green);
        }

        .notional-display {
            font-family: var(--mono);
            font-size: 10px;
            color: var(--muted);
            text-align: right;
            margin-top: 2px;
        }

        .tpsl-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .tpsl-input-wrap { position: relative; }
        .tpsl-input-wrap input { padding-right: 24px; }
        .tpsl-pct {
            position: absolute;
            right: 8px; top: 50%;
            transform: translateY(-50%);
            color: var(--muted);
            font-family: var(--mono);
            font-size: 10px;
            pointer-events: none;
        }

        .btn-open {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: var(--green);
            color: #000;
            font-family: var(--mono);
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all .15s;
            margin-top: 4px;
        }

        .btn-open:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-open:active { transform: translateY(0); }
        .btn-open:disabled { background: var(--muted); cursor: not-allowed; transform: none; }
        .btn-open.short { background: var(--red); color: #fff; }

        /* ── POSITIONS ──────────────────────────────────── */
        .positions-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px 16px;
            margin-bottom: 12px;
        }

        .pos-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .pos-header h3 {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            color: var(--muted);
        }

        .pos-count {
            font-family: var(--mono);
            font-size: 11px;
            color: var(--green);
            font-weight: 700;
        }

        .positions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .positions-table th {
            text-align: left;
            padding: 6px 10px;
            font-family: var(--mono);
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            color: var(--muted);
            border-bottom: 1px solid var(--border);
        }

        .positions-table td {
            padding: 10px 10px;
            font-family: var(--mono);
            font-size: 12px;
            border-bottom: 1px solid #1c264022;
        }

        .positions-table tr:last-child td { border-bottom: none; }
        .positions-table tr:hover td { background: #ffffff03; }

        .side-long  { color: var(--green); font-weight: 700; }
        .side-short { color: var(--red); font-weight: 700; }
        .pnl-pos { color: var(--green); font-weight: 600; }
        .pnl-neg { color: var(--red); font-weight: 600; }

        .btn-close-pos {
            padding: 4px 10px;
            border-radius: 5px;
            border: 1px solid var(--red);
            background: transparent;
            color: var(--red);
            font-family: var(--mono);
            font-size: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: background .15s;
        }

        .btn-close-pos:hover { background: #f04d4d15; }

        .empty-state {
            text-align: center;
            padding: 24px;
            color: var(--muted);
            font-family: var(--mono);
            font-size: 11px;
        }

        /* ── BOTTOM GRID ────────────────────────────────── */
        .bottom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        /* ── AUDIT LOG ──────────────────────────────────── */
        .audit-list {
            list-style: none;
            max-height: 240px;
            overflow-y: auto;
        }

        .audit-item {
            display: flex;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid #1c264022;
            font-family: var(--mono);
            font-size: 10px;
            line-height: 1.5;
        }

        .audit-item:last-child { border-bottom: none; }

        .audit-time {
            color: var(--muted);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .audit-msg { color: var(--ink); word-break: break-word; }

        /* ── PERFORMANCE ────────────────────────────────── */
        .perf-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .perf-stat {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .perf-stat .perf-val {
            font-family: var(--mono);
            font-size: 18px;
            font-weight: 700;
        }

        .perf-stat .perf-label {
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 0.5px;
            color: var(--muted);
            text-transform: uppercase;
            margin-top: 2px;
        }

        .source-list {
            margin-top: 10px;
        }

        .source-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-family: var(--mono);
            font-size: 10px;
        }

        .source-name { color: var(--muted); }
        .source-stat { color: var(--ink); font-weight: 600; }

        /* ── SNIPER / CONSOLE ───────────────────────────── */
        .tab-bar {
            display: flex;
            gap: 3px;
            margin-bottom: 12px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .tab-btn {
            padding: 4px 10px;
            border-radius: 5px;
            border: none;
            background: transparent;
            color: var(--muted);
            font-family: var(--mono);
            font-size: 10px;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: 0.5px;
        }

        .tab-btn.active { background: var(--bg2); color: var(--ink); }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        .sniper-form { display: flex; flex-direction: column; gap: 8px; }

        .btn-snipe {
            padding: 8px;
            border-radius: 6px;
            border: none;
            background: var(--gold);
            color: #000;
            font-family: var(--mono);
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: opacity .15s;
        }

        .btn-snipe:hover { opacity: 0.88; }
        .btn-snipe:disabled { background: var(--muted); cursor: not-allowed; }

        .btn-sentiment {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--blue);
            background: transparent;
            color: var(--blue);
            font-family: var(--mono);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-sentiment:hover { background: #3b82f610; }

        .sentiment-result {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            font-size: 11px;
            display: none;
        }

        .sentiment-score {
            font-family: var(--mono);
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            margin: 6px 0;
        }

        .console-out {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            font-family: var(--mono);
            font-size: 10px;
            height: 240px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.7;
        }

        .log-info    { color: var(--muted); }
        .log-success { color: var(--green); }
        .log-error   { color: var(--red); }
        .log-warn    { color: var(--gold); }

        .spin {
            display: inline-block;
            width: 10px; height: 10px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin .7s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ── ARM MODAL ──────────────────────────────────── */
        .modal-overlay {
            display: none;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active { display: flex; }

        .modal-box {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px;
            width: 380px;
            max-width: 90vw;
            text-align: center;
        }

        .modal-box h2 {
            font-family: var(--mono);
            font-size: 16px;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 12px;
            letter-spacing: 1px;
        }

        .modal-box p {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .modal-box .challenge-display {
            font-family: var(--mono);
            font-size: 14px;
            font-weight: 700;
            color: var(--ink);
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 16px;
            user-select: all;
        }

        .modal-btns {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .modal-btns button {
            padding: 10px 24px;
            border-radius: 8px;
            font-family: var(--mono);
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            border: 1px solid var(--border);
            transition: all .15s;
        }

        .btn-modal-cancel {
            background: var(--bg2);
            color: var(--muted);
        }

        .btn-modal-confirm {
            background: var(--green);
            color: #000;
            border-color: var(--green) !important;
        }

        .btn-modal-confirm:hover { opacity: 0.9; }

        /* ── MOBILE ─────────────────────────────────────── */
        @media (max-width: 1100px) {
            .main-grid { grid-template-columns: 1fr; }
            .bottom-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 640px) {
            .ticker-strip { display: none; }
            nav { gap: 8px; padding: 0 12px; }
            .page { padding: 12px; }
        }
    

        .prototype-banner {
            background: rgba(245, 158, 11, 0.12);
            border-bottom: 1px solid rgba(245, 158, 11, 0.45);
            color: #fbbf24;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.2px;
            padding: 8px 12px;
            text-align: center;
        }
</style>
</head>
<body>

<div class="prototype-banner">
    PROTOTYPE SURFACE ONLY. Canonical production UI is jarvis-sniper.
</div>


<!-- ── NAV ─────────────────────────────────────────────── -->
<nav>
    <div class="nav-logo">JARVIS</div>
    <div class="ticker-strip" id="ticker-strip">
        <div class="ticker-chip active" id="ticker-SOL-USD" onclick="setMarket('SOL-USD', this)">
            <span class="t-sym">SOL</span>
            <span class="t-price">--</span>
        </div>
        <div class="ticker-chip" id="ticker-BTC-USD" onclick="setMarket('BTC-USD', this)">
            <span class="t-sym">BTC</span>
            <span class="t-price">--</span>
        </div>
        <div class="ticker-chip" id="ticker-ETH-USD" onclick="setMarket('ETH-USD', this)">
            <span class="t-sym">ETH</span>
            <span class="t-price">--</span>
        </div>
    </div>
    <div class="nav-right">
        <div class="arm-badge disarmed" id="nav-arm" onclick="handleArmClick()">DISARMED</div>
        <button class="btn-wallet" id="wallet-btn" onclick="connectWallet()">Connect Wallet</button>
    </div>
</nav>

<!-- ── ARM MODAL ────────────────────────────────────────── -->
<div class="modal-overlay" id="arm-modal">
    <div class="modal-box">
        <h2 id="arm-modal-title">ARM LIVE TRADING</h2>
        <p id="arm-modal-desc">This will enable the runner to execute real trades on Jupiter Perps. Confirm the challenge below to arm.</p>
        <div class="challenge-display" id="arm-challenge">--</div>
        <div class="modal-btns">
            <button class="btn-modal-cancel" onclick="closeArmModal()">Cancel</button>
            <button class="btn-modal-confirm" id="arm-confirm-btn" onclick="confirmArm()">CONFIRM ARM</button>
        </div>
    </div>
</div>

<div class="page">

<!-- ── MAIN GRID ────────────────────────────────────────── -->
<div class="main-grid">

    <!-- Chart Card -->
    <div class="chart-card">
        <div class="chart-toolbar">
            <div class="market-tabs">
                <button class="tab active" data-market="SOL-USD" onclick="setMarket('SOL-USD', this)">SOL</button>
                <button class="tab" data-market="BTC-USD" onclick="setMarket('BTC-USD', this)">BTC</button>
                <button class="tab" data-market="ETH-USD" onclick="setMarket('ETH-USD', this)">ETH</button>
            </div>
            <div class="chart-price-area">
                <div class="chart-big-price" id="chart-price">$--</div>
                <div class="chart-sub" id="chart-sub"></div>
            </div>
        </div>
        <div id="price-chart"></div>
    </div>

    <!-- Right Sidebar -->
    <div class="sidebar">

        <!-- Runner Status -->
        <div class="runner-card" id="runner-card">
            <div class="runner-dot down" id="runner-dot"></div>
            <div class="runner-info">
                <div class="runner-label" id="runner-label">Runner Offline</div>
                <div class="runner-sub" id="runner-sub">Not running</div>
            </div>
            <button class="btn-runner" id="runner-btn" onclick="toggleRunner()">START</button>
        </div>

        <!-- AI Signal -->
        <div class="signal-card" id="signal-card">
            <div class="signal-header">
                <div class="signal-title">AI Signal</div>
                <div class="signal-stale" id="signal-age">--</div>
            </div>
            <div class="signal-direction none" id="signal-dir">NO SIGNAL</div>
            <div class="signal-conf-bar">
                <div class="signal-conf-fill" id="signal-conf-fill" style="width: 0%; background: var(--muted);"></div>
            </div>
            <div class="signal-meta" id="signal-meta">
                <span>Waiting for runner...</span>
            </div>
        </div>

        <!-- Order Panel -->
        <div class="order-card">
            <div class="card-header">Open Position</div>

            <div class="direction-toggle">
                <button class="dir-btn active" id="dir-long" onclick="setDirection('long')">LONG</button>
                <button class="dir-btn" id="dir-short" onclick="setDirection('short')">SHORT</button>
            </div>

            <div class="field-group">
                <div class="field-label">COLLATERAL (USD)</div>
                <input type="number" id="collateral" value="100" min="10" max="50000" step="10" oninput="updateNotional()">
            </div>

            <div class="field-group">
                <div class="leverage-row">
                    <div class="field-label">LEVERAGE</div>
                    <div class="leverage-tag" id="lev-display">10x</div>
                </div>
                <input type="range" id="leverage" min="1" max="50" value="10" oninput="updateNotional()">
                <div class="notional-display" id="notional-display">Notional: $1,000</div>
            </div>

            <div class="tpsl-row">
                <div class="field-group">
                    <div class="field-label">TAKE PROFIT</div>
                    <div class="tpsl-input-wrap">
                        <input type="number" id="tp-pct" value="10" min="1" max="500">
                        <span class="tpsl-pct">%</span>
                    </div>
                </div>
                <div class="field-group">
                    <div class="field-label">STOP LOSS</div>
                    <div class="tpsl-input-wrap">
                        <input type="number" id="sl-pct" value="5" min="1" max="99">
                        <span class="tpsl-pct">%</span>
                    </div>
                </div>
            </div>

            <button class="btn-open" id="open-btn" onclick="openPosition()">OPEN LONG SOL</button>
        </div>

    </div><!-- /sidebar -->

</div><!-- /main-grid -->

<!-- ── OPEN POSITIONS ───────────────────────────────────── -->
<div class="positions-section">
    <div class="pos-header">
        <h3>Open Positions</h3>
        <span class="pos-count" id="pos-count"></span>
    </div>
    <div id="positions-container">
        <div class="empty-state">No open positions</div>
    </div>
</div>

<!-- ── BOTTOM GRID ──────────────────────────────────────── -->
<div class="bottom-grid">

    <!-- Audit Log -->
    <div class="card">
        <div class="card-header">Audit Log</div>
        <div class="card-body">
            <ul class="audit-list" id="audit-list">
                <li class="audit-item">
                    <span class="audit-time">--:--</span>
                    <span class="audit-msg" style="color:var(--muted)">Waiting for events...</span>
                </li>
            </ul>
        </div>
    </div>

    <!-- Performance -->
    <div class="card">
        <div class="card-header">Performance</div>
        <div class="card-body">
            <div class="perf-grid" id="perf-grid">
                <div class="perf-stat">
                    <div class="perf-val" id="perf-wr" style="color:var(--muted)">--</div>
                    <div class="perf-label">Win Rate</div>
                </div>
                <div class="perf-stat">
                    <div class="perf-val" id="perf-trades" style="color:var(--muted)">--</div>
                    <div class="perf-label">Total Trades</div>
                </div>
                <div class="perf-stat">
                    <div class="perf-val" id="perf-pnl" style="color:var(--muted)">--</div>
                    <div class="perf-label">Avg P&L</div>
                </div>
                <div class="perf-stat">
                    <div class="perf-val" id="perf-total" style="color:var(--muted)">--</div>
                    <div class="perf-label">Total P&L</div>
                </div>
            </div>
            <div class="source-list" id="source-list"></div>
        </div>
    </div>

    <!-- Spot / Sentiment / Console -->
    <div class="card">
        <div class="card-body" style="padding-top:14px;">
            <div class="tab-bar">
                <button class="tab-btn active" onclick="switchTab(this, 'pane-console')">CONSOLE</button>
                <button class="tab-btn" onclick="switchTab(this, 'pane-sniper')">SNIPER</button>
                <button class="tab-btn" onclick="switchTab(this, 'pane-sentiment')">SENTIMENT</button>
            </div>

            <div id="pane-console" class="tab-pane active">
                <div class="console-out" id="console-out">
                    <span class="log-info">[system] Jarvis Perps loaded</span>
                </div>
            </div>

            <div id="pane-sniper" class="tab-pane">
                <div class="sniper-form">
                    <div class="field-label">TOKEN ADDRESS</div>
                    <input type="text" id="snipe-token" placeholder="Solana mint address...">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                        <div class="field-group">
                            <div class="field-label">AMOUNT (SOL)</div>
                            <input type="number" id="snipe-amount" value="0.1" min="0.01" step="0.01">
                        </div>
                        <div class="field-group">
                            <div class="field-label">SLIPPAGE (%)</div>
                            <input type="number" id="snipe-slippage" value="1.0" min="0.1" step="0.1">
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                        <div class="field-group">
                            <div class="field-label">TP (%)</div>
                            <input type="number" id="snipe-tp" value="50" min="5">
                        </div>
                        <div class="field-group">
                            <div class="field-label">SL (%)</div>
                            <input type="number" id="snipe-sl" value="20" min="5">
                        </div>
                    </div>
                    <button class="btn-snipe" onclick="executeSnipe()">SNIPE</button>
                </div>
            </div>

            <div id="pane-sentiment" class="tab-pane">
                <div class="sniper-form">
                    <div class="field-label">TOKEN ADDRESS</div>
                    <input type="text" id="sent-token" placeholder="Any Solana token mint...">
                    <button class="btn-sentiment" onclick="loadSentiment()">Analyze Sentiment</button>
                    <div class="sentiment-result" id="sentiment-result">
                        <div class="field-label" id="sent-symbol"></div>
                        <div class="sentiment-score" id="sent-score"></div>
                        <div style="font-size:11px;color:var(--muted);line-height:1.6;" id="sent-analysis"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div><!-- /bottom-grid -->
</div><!-- /page -->

<script>
// ═══════════════════════════════════════════════════════════
//  STATE
// ═══════════════════════════════════════════════════════════
let currentMarket    = 'SOL-USD';
let currentDirection = 'long';
let walletPubkey     = null;
let chart            = null;
let candleSeries     = null;
let priceHistory     = {};   // market -> [{time, open, high, low, close}]
let lastPrices       = {};   // market -> price
let prevPrices       = {};
let positionLines    = [];
let armState         = { stage: 'disarmed', challenge: '' };
let runnerHealth     = 'down';

// ═══════════════════════════════════════════════════════════
//  CONSOLE
// ═══════════════════════════════════════════════════════════
const consoleEl = document.getElementById('console-out');
function log(msg, type = 'info') {
    const ts = new Date().toTimeString().slice(0, 8);
    const line = document.createElement('div');
    line.className = 'log-' + type;
    line.textContent = `[${ts}] ${msg}`;
    consoleEl.prepend(line);
    if (consoleEl.children.length > 150) consoleEl.removeChild(consoleEl.lastChild);
}
function clearConsole() { consoleEl.innerHTML = ''; }

// ═══════════════════════════════════════════════════════════
//  CHART — Candlestick with historical data
// ═══════════════════════════════════════════════════════════
function initChart() {
    const container = document.getElementById('price-chart');
    chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: 340,
        layout: {
            background: { type: 'solid', color: '#111827' },
            textColor: '#5a6a85',
            fontSize: 11,
        },
        grid: {
            vertLines: { color: '#1c264030' },
            horzLines: { color: '#1c264030' },
        },
        crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
        rightPriceScale: { borderColor: '#1c2640', scaleMargins: { top: 0.1, bottom: 0.1 } },
        timeScale: { borderColor: '#1c2640', timeVisible: true, secondsVisible: false },
    });

    candleSeries = chart.addCandlestickSeries({
        upColor: '#14f195',
        downColor: '#f04d4d',
        borderUpColor: '#14f195',
        borderDownColor: '#f04d4d',
        wickUpColor: '#14f19580',
        wickDownColor: '#f04d4d80',
    });

    window.addEventListener('resize', () => {
        chart.applyOptions({ width: container.clientWidth });
    });
}

async function loadHistory(market) {
    try {
        const resp = await fetch(`/api/perps/history/${market}`);
        const data = await resp.json();
        if (data.candles && data.candles.length > 0) {
            priceHistory[market] = data.candles;
            if (market === currentMarket) {
                candleSeries.setData(data.candles);
                chart.timeScale().fitContent();
            }
            log(`Loaded ${data.candles.length} candles for ${market}`, 'info');
        }
    } catch(e) {
        log(`History load failed for ${market}: ${e.message}`, 'warn');
    }
}

function addLiveCandlePoint(market, price) {
    if (!priceHistory[market]) priceHistory[market] = [];
    const t = Math.floor(Date.now() / 1000);
    // Round to 5-minute candle
    const candleTime = t - (t % 300);
    const arr = priceHistory[market];

    if (arr.length > 0 && arr[arr.length - 1].time === candleTime) {
        const c = arr[arr.length - 1];
        c.high = Math.max(c.high, price);
        c.low = Math.min(c.low, price);
        c.close = price;
    } else {
        arr.push({ time: candleTime, open: price, high: price, low: price, close: price });
    }

    if (arr.length > 500) arr.shift();

    if (market === currentMarket) {
        candleSeries.update(arr[arr.length - 1]);
    }
}

function switchChartMarket(market) {
    const arr = priceHistory[market];
    if (arr && arr.length > 0) {
        candleSeries.setData([...arr]);
        chart.timeScale().fitContent();
    } else {
        candleSeries.setData([]);
        loadHistory(market);
    }
    clearPositionLines();
}

function clearPositionLines() {
    positionLines.forEach(l => { try { candleSeries.removePriceLine(l); } catch(e) {} });
    positionLines = [];
}

// ═══════════════════════════════════════════════════════════
//  MARKET / DIRECTION
// ═══════════════════════════════════════════════════════════
function setMarket(market, el) {
    currentMarket = market;
    // Update tabs
    document.querySelectorAll('.market-tabs .tab').forEach(t => t.classList.remove('active'));
    if (el && el.classList.contains('tab')) el.classList.add('active');
    else document.querySelector(`.tab[data-market="${market}"]`)?.classList.add('active');
    // Update ticker chips
    document.querySelectorAll('.ticker-chip').forEach(c => c.classList.remove('active'));
    document.getElementById('ticker-' + market)?.classList.add('active');

    switchChartMarket(market);
    updateChartPriceDisplay();
    updateOpenButton();
}

function updateChartPriceDisplay() {
    const price = lastPrices[currentMarket];
    document.getElementById('chart-price').textContent = price ? '$' + fmtPrice(currentMarket, price) : '$--';
}

function fmtPrice(m, p) {
    if (m === 'BTC-USD') return p.toLocaleString('en-US', { maximumFractionDigits: 0 });
    return p.toFixed(2);
}

function setDirection(dir) {
    currentDirection = dir;
    document.getElementById('dir-long').classList.toggle('active', dir === 'long');
    document.getElementById('dir-short').classList.toggle('active', dir === 'short');
    updateOpenButton();
}

function updateOpenButton() {
    const btn = document.getElementById('open-btn');
    const mkt = currentMarket.split('-')[0];
    if (currentDirection === 'long') {
        btn.textContent = `OPEN LONG ${mkt}`;
        btn.className = 'btn-open';
    } else {
        btn.textContent = `OPEN SHORT ${mkt}`;
        btn.className = 'btn-open short';
    }
}

function updateNotional() {
    const c = parseFloat(document.getElementById('collateral').value) || 0;
    const l = parseInt(document.getElementById('leverage').value) || 1;
    document.getElementById('lev-display').textContent = l + 'x';
    document.getElementById('notional-display').textContent =
        'Notional: $' + (c * l).toLocaleString('en-US', {maximumFractionDigits: 0});
}

function switchTab(tabEl, paneId) {
    const parent = tabEl.closest('.card');
    parent.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    parent.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    tabEl.classList.add('active');
    document.getElementById(paneId).classList.add('active');
}

// ═══════════════════════════════════════════════════════════
//  WALLET CONNECT
// ═══════════════════════════════════════════════════════════
async function connectWallet() {
    const btn = document.getElementById('wallet-btn');
    if (walletPubkey) {
        try { (window.phantom?.solana || window.backpack?.solana)?.disconnect(); } catch(e) {}
        walletPubkey = null;
        btn.textContent = 'Connect Wallet';
        btn.classList.remove('connected');
        log('Wallet disconnected', 'warn');
        return;
    }
    const provider = window.phantom?.solana ?? window.backpack?.solana;
    if (!provider) {
        log('No Solana wallet found. Install Phantom or Backpack.', 'error');
        return;
    }
    try {
        btn.innerHTML = '<span class="spin"></span>';
        const resp = await provider.connect();
        walletPubkey = resp.publicKey.toString();
        btn.textContent = walletPubkey.slice(0, 4) + '...' + walletPubkey.slice(-4);
        btn.classList.add('connected');
        log(`Wallet: ${walletPubkey.slice(0, 8)}...`, 'success');
    } catch(e) {
        btn.textContent = 'Connect Wallet';
        log('Connect cancelled: ' + e.message, 'warn');
    }
}

// ═══════════════════════════════════════════════════════════
//  PRICES
// ═══════════════════════════════════════════════════════════
async function fetchPrices() {
    try {
        const data = await fetch('/api/perps/prices').then(r => r.json());
        ['SOL-USD', 'BTC-USD', 'ETH-USD'].forEach(m => {
            const d = data[m];
            if (!d || d.error) return;
            const price = d.price;
            prevPrices[m] = lastPrices[m] || price;
            lastPrices[m] = price;
            addLiveCandlePoint(m, price);

            // Ticker chip
            const chip = document.getElementById('ticker-' + m);
            if (chip) {
                const sym = m.split('-')[0];
                const chg = prevPrices[m] ? ((price - prevPrices[m]) / prevPrices[m] * 100) : 0;
                const dir = chg >= 0 ? 'up' : 'down';
                const arrow = chg >= 0 ? '+' : '';
                chip.querySelector('.t-price').textContent = '$' + fmtPrice(m, price);
                // Only update change element if it exists, otherwise create it
                let chgEl = chip.querySelector('.t-chg');
                if (!chgEl) {
                    chgEl = document.createElement('span');
                    chgEl.className = 't-chg';
                    chip.appendChild(chgEl);
                }
                chgEl.className = 't-chg ' + dir;
                chgEl.textContent = arrow + Math.abs(chg).toFixed(2) + '%';
            }
        });
        updateChartPriceDisplay();
    } catch(e) {}
}

// ═══════════════════════════════════════════════════════════
//  RUNNER STATUS + ARM STATE
// ═══════════════════════════════════════════════════════════
async function fetchStatus() {
    try {
        const d = await fetch('/api/perps/status').then(r => r.json());
        runnerHealth = d.health || 'down';

        // Runner dot + label
        const dot = document.getElementById('runner-dot');
        const label = document.getElementById('runner-label');
        const sub = document.getElementById('runner-sub');
        const btn = document.getElementById('runner-btn');

        dot.className = 'runner-dot ' + runnerHealth;
        const labels = { healthy: 'Runner Active', degraded: 'Runner Degraded', down: 'Runner Offline' };
        label.textContent = labels[runnerHealth] || 'Runner Offline';

        if (runnerHealth === 'healthy' || runnerHealth === 'degraded') {
            const hb = d.heartbeat_age_seconds;
            sub.textContent = hb != null ? `Heartbeat: ${hb}s ago` : 'PID: ' + (d.runner?.pid || '?');
            btn.textContent = 'STOP';
            btn.className = 'btn-runner stop';
        } else {
            sub.textContent = 'Not running';
            btn.textContent = 'START';
            btn.className = 'btn-runner';
        }

        // ARM state
        const arm = d.arm || {};
        armState.stage = arm.stage || 'disarmed';
        const navArm = document.getElementById('nav-arm');
        navArm.className = 'arm-badge ' + armState.stage;
        const armLabels = { armed: 'ARMED', prepared: 'PREPARING...', disarmed: 'DISARMED' };
        navArm.textContent = armLabels[armState.stage] || 'DISARMED';

        // Stats in runner sub
        if (d.stats) {
            const trades = d.stats.trades_today || 0;
            const pnl = d.stats.realized_pnl_today || 0;
            if (trades > 0) {
                sub.textContent += ` | ${trades} trades | $${pnl.toFixed(0)} P&L`;
            }
        }

        document.getElementById('pos-count').textContent =
            d.positions_count > 0 ? d.positions_count : '';

    } catch(e) {}
}

// ═══════════════════════════════════════════════════════════
//  RUNNER START / STOP
// ═══════════════════════════════════════════════════════════
async function toggleRunner() {
    const btn = document.getElementById('runner-btn');
    const isRunning = runnerHealth === 'healthy' || runnerHealth === 'degraded';
    const endpoint = isRunning ? '/api/perps/runner/stop' : '/api/perps/runner/start';

    btn.disabled = true;
    btn.innerHTML = '<span class="spin"></span>';

    try {
        const resp = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const data = await resp.json();
        if (data.ok) {
            log(data.message, 'success');
            setTimeout(fetchStatus, 1500);
        } else {
            log('Runner error: ' + data.error, 'error');
        }
    } catch(e) {
        log('Runner error: ' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = isRunning ? 'STOP' : 'START';
    }
}

// ═══════════════════════════════════════════════════════════
//  ARM / DISARM
// ═══════════════════════════════════════════════════════════
function handleArmClick() {
    if (armState.stage === 'armed') {
        if (confirm('Disarm live trading?')) disarmTrading();
    } else {
        prepareArm();
    }
}

async function prepareArm() {
    try {
        const resp = await fetch('/api/perps/arm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ step: 'prepare', actor: 'web_ui' }),
        });
        const data = await resp.json();
        if (data.ok && data.challenge) {
            armState.challenge = data.challenge;
            document.getElementById('arm-challenge').textContent = data.challenge;
            document.getElementById('arm-modal').classList.add('active');
            log('Arm challenge received — confirm to go live', 'warn');
        } else {
            log('Arm prepare failed: ' + (data.error || 'unknown'), 'error');
        }
    } catch(e) {
        log('Arm error: ' + e.message, 'error');
    }
}

async function confirmArm() {
    const btn = document.getElementById('arm-confirm-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spin"></span>';
    try {
        const resp = await fetch('/api/perps/arm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ step: 'confirm', challenge: armState.challenge, actor: 'web_ui' }),
        });
        const data = await resp.json();
        if (data.ok) {
            log('ARMED — live trading enabled', 'success');
            closeArmModal();
            setTimeout(fetchStatus, 500);
        } else {
            log('Arm confirm failed: ' + (data.reason || data.error), 'error');
        }
    } catch(e) {
        log('Arm error: ' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'CONFIRM ARM';
    }
}

async function disarmTrading() {
    try {
        const resp = await fetch('/api/perps/disarm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason: 'web_ui_disarm', actor: 'web_ui' }),
        });
        const data = await resp.json();
        if (data.ok) {
            log('DISARMED — live trading disabled', 'warn');
            setTimeout(fetchStatus, 500);
        }
    } catch(e) {
        log('Disarm error: ' + e.message, 'error');
    }
}

function closeArmModal() {
    document.getElementById('arm-modal').classList.remove('active');
}

// ═══════════════════════════════════════════════════════════
//  AI SIGNAL
// ═══════════════════════════════════════════════════════════
async function fetchSignal() {
    try {
        const d = await fetch('/api/perps/signal').then(r => r.json());
        const dirEl = document.getElementById('signal-dir');
        const ageEl = document.getElementById('signal-age');
        const fillEl = document.getElementById('signal-conf-fill');
        const metaEl = document.getElementById('signal-meta');

        if (d.error === 'no_signal_available' || !d.market) {
            dirEl.textContent = 'NO SIGNAL';
            dirEl.className = 'signal-direction none';
            ageEl.textContent = '--';
            fillEl.style.width = '0%';
            metaEl.innerHTML = '<span>Waiting for runner...</span>';
            return;
        }

        const dir = (d.direction || d.side || '').toLowerCase();
        const market = d.market || '?';
        const conf = Math.min(1, Math.max(0, d.confidence || 0));

        dirEl.textContent = (dir === 'long' ? 'LONG' : dir === 'short' ? 'SHORT' : 'FLAT') + ' ' + market;
        dirEl.className = 'signal-direction ' + (dir === 'long' ? 'long' : dir === 'short' ? 'short' : 'none');

        const confPct = Math.round(conf * 100);
        fillEl.style.width = confPct + '%';
        fillEl.style.background = dir === 'long' ? 'var(--green)' : dir === 'short' ? 'var(--red)' : 'var(--muted)';

        const age = d.age_seconds || 0;
        ageEl.textContent = age < 60 ? `${age}s ago` : `${Math.floor(age / 60)}m ago`;
        ageEl.style.color = d.stale ? 'var(--red)' : 'var(--muted)';

        // Sources
        let metaHtml = `<span>Conf: ${confPct}%</span>`;
        if (d.sources) {
            for (const [k, v] of Object.entries(d.sources)) {
                metaHtml += `<span>${k}: ${typeof v === 'number' ? v.toFixed(2) : v}</span>`;
            }
        }
        if (d.event) metaHtml += `<span>${d.event}</span>`;
        metaEl.innerHTML = metaHtml;

    } catch(e) {}
}

// ═══════════════════════════════════════════════════════════
//  POSITIONS
// ═══════════════════════════════════════════════════════════
async function fetchPositions() {
    try {
        const d = await fetch('/api/perps/positions').then(r => r.json());
        const positions = d.positions || [];
        const container = document.getElementById('positions-container');
        document.getElementById('pos-count').textContent = positions.length > 0 ? positions.length : '';

        if (positions.length === 0) {
            container.innerHTML = '<div class="empty-state">No open positions</div>';
            clearPositionLines();
            return;
        }

        clearPositionLines();

        // Entry price lines on chart
        positions.forEach(pos => {
            if (pos.market === currentMarket && pos.entry_price) {
                positionLines.push(candleSeries.createPriceLine({
                    price: pos.entry_price,
                    color: '#fbbf24',
                    lineWidth: 1,
                    lineStyle: LightweightCharts.LineStyle.Dashed,
                    axisLabelVisible: true,
                    title: 'Entry',
                }));
            }
        });

        container.innerHTML = `
            <table class="positions-table">
                <thead><tr>
                    <th>Market</th><th>Side</th><th>Collateral</th><th>Lev</th>
                    <th>Entry</th><th>Current</th><th>P&L</th><th>TP/SL</th><th>Source</th><th></th>
                </tr></thead>
                <tbody>${positions.map(posRow).join('')}</tbody>
            </table>`;
    } catch(e) {
        document.getElementById('positions-container').innerHTML =
            `<div class="empty-state" style="color:var(--red)">Error: ${e.message}</div>`;
    }
}

function posRow(pos) {
    const side = (pos.side || 'long').toLowerCase();
    const sideClass = side === 'long' ? 'side-long' : 'side-short';
    const sideLabel = side === 'long' ? 'LONG' : 'SHORT';
    const coll = pos.collateral_usd ? '$' + pos.collateral_usd.toFixed(0) : '--';
    const lev = pos.leverage ? pos.leverage + 'x' : '--';
    const entry = pos.entry_price ? '$' + fmtPrice(pos.market, pos.entry_price) : '--';
    const cur = lastPrices[pos.market] || pos.current_price;
    const curStr = cur ? '$' + fmtPrice(pos.market, cur) : '--';

    let pnlHtml = '--';
    if (pos.entry_price && cur && pos.collateral_usd) {
        const pct = side === 'long'
            ? (cur - pos.entry_price) / pos.entry_price * 100
            : (pos.entry_price - cur) / pos.entry_price * 100;
        const usd = pct / 100 * pos.collateral_usd * (pos.leverage || 1);
        const cls = usd >= 0 ? 'pnl-pos' : 'pnl-neg';
        const sign = usd >= 0 ? '+' : '';
        pnlHtml = `<span class="${cls}">${sign}$${usd.toFixed(2)} (${sign}${pct.toFixed(1)}%)</span>`;
    }

    const tp = pos.take_profit_pct ? '+' + pos.take_profit_pct + '%' : '--';
    const sl = pos.stop_loss_pct ? '-' + pos.stop_loss_pct + '%' : '--';
    const pda = pos.pda || pos.idempotency_key || '';

    return `<tr>
        <td>${pos.market || '--'}</td>
        <td class="${sideClass}">${sideLabel}</td>
        <td>${coll}</td><td>${lev}</td><td>${entry}</td><td>${curStr}</td>
        <td>${pnlHtml}</td>
        <td style="color:var(--muted);font-size:10px;">${tp} / ${sl}</td>
        <td style="color:var(--muted);font-size:10px;">${pos.source || '--'}</td>
        <td><button class="btn-close-pos" onclick="closePosition('${pda}')">Close</button></td>
    </tr>`;
}

// ═══════════════════════════════════════════════════════════
//  AUDIT LOG
// ═══════════════════════════════════════════════════════════
async function fetchAudit() {
    try {
        const d = await fetch('/api/perps/audit').then(r => r.json());
        const events = (d.events || []).slice(-15).reverse();
        const list = document.getElementById('audit-list');

        if (events.length === 0) {
            list.innerHTML = '<li class="audit-item"><span class="audit-time">--:--</span><span class="audit-msg" style="color:var(--muted)">No events yet</span></li>';
            return;
        }

        list.innerHTML = events.map(ev => {
            const ts = ev.timestamp ? new Date(ev.timestamp * 1000).toTimeString().slice(0, 8) : '--:--';
            const event = ev.event || ev.action || ev.type || 'event';
            const market = ev.market || '';
            const reason = ev.reason || ev.trigger || '';
            let msg = event;
            if (market) msg += ` ${market}`;
            if (reason) msg += ` — ${reason}`;
            if (ev.pnl_pct != null) msg += ` (${ev.pnl_pct > 0 ? '+' : ''}${ev.pnl_pct.toFixed(1)}%)`;
            return `<li class="audit-item"><span class="audit-time">${ts}</span><span class="audit-msg">${msg}</span></li>`;
        }).join('');
    } catch(e) {}
}

// ═══════════════════════════════════════════════════════════
//  PERFORMANCE
// ═══════════════════════════════════════════════════════════
async function fetchPerformance() {
    try {
        const d = await fetch('/api/perps/performance').then(r => r.json());

        const wr = document.getElementById('perf-wr');
        const trades = document.getElementById('perf-trades');
        const avg = document.getElementById('perf-pnl');
        const total = document.getElementById('perf-total');

        if (d.total_trades > 0) {
            wr.textContent = d.win_rate + '%';
            wr.style.color = d.win_rate >= 55 ? 'var(--green)' : d.win_rate >= 45 ? 'var(--gold)' : 'var(--red)';
            trades.textContent = d.total_trades;
            trades.style.color = 'var(--ink)';
            avg.textContent = (d.avg_pnl_pct >= 0 ? '+' : '') + d.avg_pnl_pct + '%';
            avg.style.color = d.avg_pnl_pct >= 0 ? 'var(--green)' : 'var(--red)';
            total.textContent = '$' + (d.total_pnl_usd >= 0 ? '+' : '') + d.total_pnl_usd.toFixed(0);
            total.style.color = d.total_pnl_usd >= 0 ? 'var(--green)' : 'var(--red)';

            // Source breakdown
            const srcList = document.getElementById('source-list');
            if (d.sources && Object.keys(d.sources).length > 0) {
                srcList.innerHTML = Object.entries(d.sources).map(([name, s]) =>
                    `<div class="source-row">
                        <span class="source-name">${name}</span>
                        <span class="source-stat">${s.win_rate}% (${s.trades} trades)</span>
                    </div>`
                ).join('');
            }
        } else {
            wr.textContent = '--';
            wr.style.color = 'var(--muted)';
            trades.textContent = '0';
            trades.style.color = 'var(--muted)';
        }
    } catch(e) {}
}

// ═══════════════════════════════════════════════════════════
//  OPEN / CLOSE POSITION
// ═══════════════════════════════════════════════════════════
async function openPosition() {
    const collateral = parseFloat(document.getElementById('collateral').value);
    const leverage   = parseInt(document.getElementById('leverage').value);
    const tp         = parseFloat(document.getElementById('tp-pct').value);
    const sl         = parseFloat(document.getElementById('sl-pct').value);

    if (!collateral || collateral < 10) { log('Collateral must be >= $10', 'error'); return; }
    if (leverage < 1 || leverage > 50) { log('Leverage: 1-50x', 'error'); return; }
    if (!tp || tp < 1) { log('TP must be > 1%', 'error'); return; }
    if (!sl || sl < 1) { log('SL must be > 1%', 'error'); return; }

    const notional = collateral * leverage;
    const mkt = currentMarket.split('-')[0];

    if (!confirm(`Open ${currentDirection.toUpperCase()} ${mkt} ${leverage}x\nCollateral: $${collateral}  Notional: $${notional}\nTP: +${tp}%  SL: -${sl}%`)) return;

    const btn = document.getElementById('open-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spin"></span> Queuing...';

    try {
        const resp = await fetch('/api/perps/open', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ market: currentMarket, side: currentDirection, collateral_usd: collateral, leverage, tp_pct: tp, sl_pct: sl }),
        });
        const data = await resp.json();
        if (data.ok) {
            log(`Position queued: ${data.idempotency_key.slice(0, 8)}...`, 'success');
            setTimeout(fetchPositions, 2000);
        } else {
            log('Queue error: ' + data.error, 'error');
        }
    } catch(e) {
        log('Network error: ' + e.message, 'error');
    } finally {
        btn.disabled = false;
        updateOpenButton();
    }
}

async function closePosition(pdaOrKey) {
    if (!confirm('Close this position?')) return;
    try {
        const resp = await fetch('/api/perps/close', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                position_pda: pdaOrKey.length > 40 ? pdaOrKey : '',
                idempotency_key: pdaOrKey.length <= 40 ? pdaOrKey : '',
                slippage_bps: 300,
            }),
        });
        const data = await resp.json();
        if (data.ok) {
            log('Close queued: ' + data.idempotency_key.slice(0, 8) + '...', 'success');
            setTimeout(fetchPositions, 2000);
        } else {
            log('Close error: ' + data.error, 'error');
        }
    } catch(e) { log('Network error: ' + e.message, 'error'); }
}

// ═══════════════════════════════════════════════════════════
//  SPOT SNIPER
// ═══════════════════════════════════════════════════════════
async function executeSnipe() {
    const token = document.getElementById('snipe-token').value.trim();
    const amount = parseFloat(document.getElementById('snipe-amount').value);
    const tp = parseFloat(document.getElementById('snipe-tp').value);
    const sl = parseFloat(document.getElementById('snipe-sl').value);
    const slip = parseFloat(document.getElementById('snipe-slippage').value);

    if (!token) { log('Enter token address', 'error'); return; }
    if (!amount || amount <= 0) { log('Amount must be > 0', 'error'); return; }
    if (!confirm(`Snipe ${amount} SOL into ${token.slice(0,8)}...?\nTP: ${tp}%  SL: ${sl}%`)) return;

    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="spin"></span>';

    try {
        const resp = await fetch('/api/trade/buy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token_address: token, amount_sol: amount, tp_percent: tp, sl_percent: sl, slippage_bps: Math.round(slip * 100) }),
        });
        const data = await resp.json();
        if (data.success || data.ok) {
            log(`Snipe sent! ${(data.tx_hash || 'queued').slice(0, 8)}`, 'success');
        } else {
            log('Snipe failed: ' + (data.error || 'unknown'), 'error');
        }
    } catch(e) { log('Network error: ' + e.message, 'error'); }
    finally { btn.disabled = false; btn.textContent = 'SNIPE'; }
}

// ═══════════════════════════════════════════════════════════
//  SENTIMENT
// ═══════════════════════════════════════════════════════════
async function loadSentiment() {
    const token = document.getElementById('sent-token').value.trim();
    if (!token) { log('Enter token address', 'error'); return; }

    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="spin"></span> Analyzing...';

    try {
        const resp = await fetch('/api/token/sentiment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token_address: token }),
        });
        const data = await resp.json();
        if (!data.success) { log('Sentiment error: ' + data.error, 'error'); return; }

        const s = data.sentiment || {};
        document.getElementById('sent-symbol').textContent = s.symbol || token.slice(0, 8) + '...';
        const scoreEl = document.getElementById('sent-score');
        const score = s.score != null ? s.score : '--';
        scoreEl.textContent = typeof score === 'number' ? score.toFixed(1) : score;
        if (typeof score === 'number') {
            scoreEl.style.color = score >= 70 ? 'var(--green)' : score >= 40 ? 'var(--gold)' : 'var(--red)';
        }
        document.getElementById('sent-analysis').textContent = s.analysis || 'No analysis.';
        document.getElementById('sentiment-result').style.display = 'block';
        log(`Sentiment: ${s.symbol || 'token'}`, 'success');
    } catch(e) { log('Network error: ' + e.message, 'error'); }
    finally { btn.disabled = false; btn.textContent = 'Analyze Sentiment'; }
}

// ═══════════════════════════════════════════════════════════
//  POLLING
// ═══════════════════════════════════════════════════════════
function startPolling() {
    // Load historical candles first
    ['SOL-USD', 'BTC-USD', 'ETH-USD'].forEach(m => loadHistory(m));

    // Then start live polling
    fetchPrices();
    fetchStatus();
    fetchPositions();
    fetchSignal();
    fetchAudit();
    fetchPerformance();

    setInterval(fetchPrices, 2000);
    setInterval(fetchStatus, 5000);
    setInterval(fetchPositions, 10000);
    setInterval(fetchSignal, 5000);
    setInterval(fetchAudit, 15000);
    setInterval(fetchPerformance, 30000);
}

// ═══════════════════════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════════════════════
initChart();
updateNotional();
updateOpenButton();
startPolling();
log('Jarvis Perps initialized — loading market data...', 'info');
</script>
</body>
</html>
