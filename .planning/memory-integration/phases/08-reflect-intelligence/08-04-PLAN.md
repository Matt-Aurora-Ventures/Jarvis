---
phase: 08-reflect-intelligence
plan: 04
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - core/memory/patterns.py
  - core/memory/reflect.py
  - core/memory/__init__.py
autonomous: true

must_haves:
  truths:
    - "Weekly pattern reports generate actionable insights"
    - "Pattern reports show win rates, top tokens, strategy performance"
    - "Contradiction detection flags conflicting facts for review"
    - "Weekly summaries saved to bank/weekly_summaries/ directory"
  artifacts:
    - path: "core/memory/patterns.py"
      provides: "Weekly pattern analysis and insights"
      min_lines: 150
      exports: ["generate_weekly_summary", "detect_patterns"]
    - path: "~/.lifeos/memory/bank/weekly_summaries/"
      provides: "Weekly summary markdown files"
  key_links:
    - from: "core/memory/patterns.py"
      to: "core/memory/database.py"
      via: "SQL aggregates for statistics"
      pattern: "cursor\\.execute"
    - from: "core/memory/patterns.py"
      to: "core/memory/summarize.py"
      via: "LLM for insight extraction"
      pattern: "synthesize.*insights|anthropic"
---

<objective>
Create weekly pattern analysis and contradiction detection. Generate actionable pattern reports with win rates, top performers, and strategy effectiveness. Detect contradictory facts and flag them for review.

Purpose: Surface non-obvious insights from accumulated memory and catch inconsistencies that could mislead decision-making.

Output:
- `core/memory/patterns.py` with generate_weekly_summary() and detect_contradictions()
- Weekly summary files in bank/weekly_summaries/
- Contradiction tracking in reflect state
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/memory-integration/PROJECT.md
@.planning/memory-integration/STATE.md
@.planning/memory-integration/phases/08-reflect-intelligence/08-RESEARCH.md
@.planning/memory-integration/phases/08-reflect-intelligence/08-01-SUMMARY.md
@core/memory/database.py
@core/memory/summarize.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create patterns module with weekly summary</name>
  <files>core/memory/patterns.py</files>
  <action>
Create `core/memory/patterns.py` with:

1. **generate_weekly_summary() -> Dict[str, Any]**
   - Calculate week boundaries (Monday-Sunday, last complete week)
   - Query aggregate statistics from database:

   a. **Trade outcomes:**
   ```sql
   SELECT
       COUNT(*) as total_trades,
       SUM(CASE WHEN content LIKE '+%' OR content LIKE '%profit%' THEN 1 ELSE 0 END) as wins,
       SUM(CASE WHEN content LIKE '-%' OR content LIKE '%loss%' THEN 1 ELSE 0 END) as losses
   FROM facts
   WHERE source = 'treasury_trading'
   AND context LIKE '%trade_outcome%'
   AND timestamp >= ? AND timestamp < ?
   ```

   b. **Top performing tokens:**
   ```sql
   SELECT
       em.entity_name,
       COUNT(*) as mention_count,
       SUM(CASE WHEN f.content LIKE '+%' OR f.content LIKE '%profit%' THEN 1 ELSE 0 END) as wins
   FROM entity_mentions em
   JOIN facts f ON em.fact_id = f.id
   WHERE em.entity_type = 'token'
   AND f.timestamp >= ? AND f.timestamp < ?
   GROUP BY em.entity_name
   ORDER BY wins DESC
   LIMIT 10
   ```

   c. **Strategy performance:**
   ```sql
   SELECT
       em.entity_name as strategy,
       COUNT(*) as trades,
       SUM(CASE WHEN f.content LIKE '+%' THEN 1 ELSE 0 END) as wins
   FROM entity_mentions em
   JOIN facts f ON em.fact_id = f.id
   WHERE em.entity_type = 'strategy'
   AND f.source = 'treasury_trading'
   AND f.timestamp >= ? AND f.timestamp < ?
   GROUP BY em.entity_name
   ORDER BY wins DESC
   ```

   d. **Activity by source:**
   ```sql
   SELECT source, COUNT(*) as count
   FROM facts
   WHERE timestamp >= ? AND timestamp < ?
   GROUP BY source
   ORDER BY count DESC
   ```

2. Build stats text and call LLM for pattern insights:
   ```python
   prompt = f"""Analyze this week's data and extract 3-5 actionable insights:

   {stats_text}

   Focus on:
   1. What worked: High win rate tokens/strategies
   2. What failed: Underperformers
   3. Emerging patterns: (e.g., "tokens with dev Twitter succeed 70%")
   4. Recommendations for next week

   Be specific with percentages and examples.
   """
   ```

3. Write weekly summary to markdown:
   - Directory: ~/.lifeos/memory/bank/weekly_summaries/
   - Filename: {year}-W{week:02d}.md (e.g., 2026-W04.md)
   - Content structure:
     ```markdown
     # Weekly Summary: Week {N}, {year}

     **Period:** {start_date} to {end_date}

     ## Statistics
     {stats_text}

     ## Pattern Insights
     {llm_insights}

     _Generated: {timestamp}_
     ```

4. Return: {week: "2026-W04", summary_path: "...", stats: {...}}

Import anthropic for LLM synthesis.
  </action>
  <verify>
```bash
cd c:/Users/lucid/OneDrive/Desktop/Projects/Jarvis
python -c "
from core.memory.patterns import generate_weekly_summary
import inspect
sig = inspect.signature(generate_weekly_summary)
print(f'generate_weekly_summary signature: {sig}')
print('Function exists and is importable')
"
```
  </verify>
  <done>
generate_weekly_summary() exists, queries aggregate stats, uses LLM for insights, saves markdown to weekly_summaries/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add contradiction detection</name>
  <files>core/memory/patterns.py, core/memory/reflect.py</files>
  <action>
Add `detect_contradictions()` to `core/memory/patterns.py`:

1. **detect_contradictions() -> List[Dict[str, Any]]**
   - Rule-based contradiction detection:

   a. **Conflicting preferences:**
   ```sql
   SELECT
       p1.id as id1, p2.id as id2,
       p1.user_id, p1.key,
       p1.value as value1, p2.value as value2,
       p1.confidence as conf1, p2.confidence as conf2
   FROM preferences p1
   JOIN preferences p2 ON p1.user_id = p2.user_id AND p1.key = p2.key
   WHERE p1.id < p2.id
   AND p1.value != p2.value
   AND p1.confidence > 0.4 AND p2.confidence > 0.4
   ```

   b. **Entity type conflicts:**
   ```sql
   SELECT
       e1.id as id1, e2.id as id2,
       e1.name, e1.type as type1, e2.type as type2
   FROM entities e1
   JOIN entities e2 ON LOWER(e1.name) = LOWER(e2.name)
   WHERE e1.id < e2.id
   AND e1.type != e2.type
   ```

2. Return list of contradiction dicts:
   ```python
   [
       {
           "type": "preference_conflict",
           "id1": 1, "id2": 2,
           "reason": "User X has conflicting preferences for Y: 'A' vs 'B'",
           "detected_at": datetime.utcnow().isoformat()
       },
       ...
   ]
   ```

3. Log warnings for detected contradictions

4. Add to reflect.py:
   - Create `add_contradiction_detection()` function that calls detect_contradictions()
   - Store contradictions in reflect_state.json under "contradictions" key
   - Only flag new contradictions (compare with previous state)

5. Integrate into reflect_daily():
   ```python
   # Step 7: Detect contradictions
   contradictions = detect_contradictions()
   if contradictions:
       logger.warning(f"Detected {len(contradictions)} contradictions - flagged for review")
   ```

Handle edge case: Empty results (no contradictions) returns empty list.
  </action>
  <verify>
```bash
cd c:/Users/lucid/OneDrive/Desktop/Projects/Jarvis
python -c "
from core.memory.patterns import detect_contradictions
result = detect_contradictions()
print(f'Contradictions found: {len(result)}')
print('detect_contradictions works')
"
```
  </verify>
  <done>
detect_contradictions() exists, finds conflicting preferences and entity types, returns list of contradiction dicts.
  </done>
</task>

<task type="auto">
  <name>Task 3: Export and integrate pattern functions</name>
  <files>core/memory/__init__.py, core/memory/reflect.py</files>
  <action>
1. Update `core/memory/__init__.py` to export:
   - generate_weekly_summary
   - detect_contradictions

2. Integrate contradiction detection into reflect_daily():
   ```python
   from core.memory.patterns import detect_contradictions

   # After other reflect steps...

   # Step 7: Detect contradictions
   contradictions = detect_contradictions()
   if contradictions:
       logger.warning(f"Detected {len(contradictions)} contradictions - flagged for review")
       # Store in reflect state for visibility
       state["contradictions"] = contradictions
   ```

3. Update return stats:
   - contradictions_found: len(contradictions)

4. Test the full integration:
```python
from core.memory import generate_weekly_summary, detect_contradictions
from core.memory.reflect import reflect_daily

# Test weekly summary (will work even with minimal data)
result = generate_weekly_summary()
print(f"Weekly summary result: {result}")

# Test contradiction detection
contradictions = detect_contradictions()
print(f"Contradictions: {len(contradictions)}")

# Test full reflect flow
reflect_result = reflect_daily()
print(f"Reflect status: {reflect_result.get('status')}")
print(f"Contradictions in result: {reflect_result.get('contradictions_found', 0)}")
```

5. Verify weekly_summaries directory is created:
```python
from core.memory.config import get_config
config = get_config()
summaries_dir = config.memory_dir / "bank" / "weekly_summaries"
print(f"Weekly summaries dir exists: {summaries_dir.exists()}")
```
  </action>
  <verify>
```bash
cd c:/Users/lucid/OneDrive/Desktop/Projects/Jarvis
python -c "
from core.memory import generate_weekly_summary, detect_contradictions
from core.memory.reflect import reflect_daily
import inspect

# Verify exports
print('generate_weekly_summary importable:', callable(generate_weekly_summary))
print('detect_contradictions importable:', callable(detect_contradictions))

# Verify integration
source = inspect.getsource(reflect_daily)
assert 'detect_contradictions' in source, 'Missing contradiction detection'
print('All pattern functions integrated')
"
```
  </verify>
  <done>
Pattern functions exported from core.memory. Contradiction detection integrated into reflect_daily(). Weekly summaries directory created on first run.
  </done>
</task>

</tasks>

<verification>
All verification steps must pass:

1. core/memory/patterns.py exists with generate_weekly_summary() and detect_contradictions()
2. Both functions importable from core.memory
3. Weekly summary creates markdown file in bank/weekly_summaries/
4. Contradiction detection finds conflicting preferences/entities
5. reflect_daily() includes contradiction detection step
</verification>

<success_criteria>
- Weekly pattern reports show win rates, top tokens, strategy effectiveness
- LLM synthesizes 3-5 actionable insights from aggregate data
- Contradiction detection finds preference conflicts and entity type mismatches
- All detected contradictions logged and stored in reflect state
- Requirements REF-006 and REF-007 satisfied
</success_criteria>

<output>
After completion, create `.planning/memory-integration/phases/08-reflect-intelligence/08-04-SUMMARY.md`
</output>
