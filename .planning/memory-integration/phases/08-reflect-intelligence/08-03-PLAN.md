---
phase: 08-reflect-intelligence
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - core/memory/reflect.py
autonomous: true

must_haves:
  truths:
    - "Preference confidence scores evolve based on evidence"
    - "Confirmations increase confidence by +0.1 (max 0.95)"
    - "Contradictions decrease confidence by -0.15 (min 0.1)"
    - "Logs older than 30 days move to archives directory"
    - "Archived logs can be optionally compressed after 90 days"
  artifacts:
    - path: "core/memory/reflect.py"
      provides: "evolve_preference_confidence() and archive_old_logs()"
      exports: ["evolve_preference_confidence", "archive_old_logs"]
  key_links:
    - from: "core/memory/reflect.py"
      to: "preferences table"
      via: "UPDATE preferences SET confidence"
      pattern: "UPDATE preferences"
    - from: "core/memory/reflect.py"
      to: "~/.lifeos/memory/memory/archives/"
      via: "shutil.move for archival"
      pattern: "shutil\\.move"
---

<objective>
Add preference confidence evolution and log archival to daily reflection. Preferences strengthen with confirmations, weaken with contradictions. Logs older than 30 days move to archives.

Purpose: Make Jarvis smarter by learning which preferences are stable vs uncertain, and keep the workspace manageable by archiving old logs.

Output:
- `evolve_preference_confidence()` function in reflect.py
- `archive_old_logs()` function in reflect.py
- Integration into reflect_daily() flow
- archives/ directory for old logs
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/memory-integration/PROJECT.md
@.planning/memory-integration/STATE.md
@.planning/memory-integration/phases/08-reflect-intelligence/08-RESEARCH.md
@.planning/memory-integration/phases/08-reflect-intelligence/08-01-SUMMARY.md
@core/memory/database.py
@core/memory/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement preference confidence evolution</name>
  <files>core/memory/reflect.py</files>
  <action>
Add `evolve_preference_confidence()` function to `core/memory/reflect.py`:

1. **evolve_preference_confidence(since_time: datetime) -> Dict[str, Any]**
   - Query preference-related facts from period:
     ```sql
     SELECT id, content, context, timestamp
     FROM facts
     WHERE source = 'preference_tracking'
     AND timestamp >= ?
     ```
   - Parse preference facts using regex pattern:
     ```python
     # Pattern: "User {user} preference: {key}={value} (confirmed|contradicted)"
     match = re.search(
         r"User (\w+) preference: (\w+)=(\w+) \((confirmed|contradicted)\)",
         fact['content']
     )
     ```
   - For each matched preference:
     a. Get current preference from database:
        ```sql
        SELECT id, confidence, evidence_count, value
        FROM preferences
        WHERE user_id = ? AND key = ?
        ```
     b. Apply confidence update:
        - Confirmed: new_confidence = min(0.95, old_confidence + 0.1)
        - Contradicted: new_confidence = max(0.1, old_confidence - 0.15)
        - If contradicted and new_confidence < 0.3: flip preference to new value, reset confidence to 0.5
     c. Update database:
        ```sql
        UPDATE preferences
        SET confidence = ?, evidence_count = evidence_count + 1, last_updated = ?
        WHERE user_id = ? AND key = ?
        ```
     d. Log the evolution: "Evolved {user}.{key}: {old} -> {new} (confirmed/contradicted)"

2. Return stats: {preferences_evolved: N, flips: M}

3. Handle edge cases:
   - Non-matching facts (skip with debug log)
   - Missing preferences in database (skip with warning)
   - Preference already at bounds (log and skip update)

Confidence bounds from Phase 6 decisions:
- Start: 0.5 (neutral)
- Confirmation: +0.1 (max 0.95)
- Contradiction: -0.15 (min 0.1)
- Flip threshold: <0.3 confidence
  </action>
  <verify>
```bash
cd c:/Users/lucid/OneDrive/Desktop/Projects/Jarvis
python -c "
from core.memory.reflect import evolve_preference_confidence
import inspect
sig = inspect.signature(evolve_preference_confidence)
print(f'evolve_preference_confidence signature: {sig}')
print('Function exists and is importable')
"
```
  </verify>
  <done>
evolve_preference_confidence() exists, parses preference facts, applies confidence bounds, and returns evolution stats.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement log archival system</name>
  <files>core/memory/reflect.py</files>
  <action>
Add `archive_old_logs()` function to `core/memory/reflect.py`:

1. **archive_old_logs(archive_after_days: int = 30, compress_after_days: int = 90) -> Dict[str, int]**
   - Get logs directory from config: config.memory_dir / "memory"
   - Create archives directory: logs_dir / "archives"
   - Calculate cutoff date: datetime.utcnow() - timedelta(days=archive_after_days)

2. Archive phase (>30 days):
   - Iterate over logs_dir/*.md files
   - Parse date from filename (YYYY-MM-DD.md format)
   - If file_date < cutoff_date:
     - Move to archives/ directory using shutil.move()
     - Count archived files

3. Compression phase (>90 days, optional):
   - Iterate over archives/*.md files
   - If file_date < compress_threshold (90 days):
     - Compress to .md.gz using gzip
     - Delete uncompressed .md file
     - Count compressed files

4. Return stats: {archived: N, compressed: M}

5. Handle edge cases:
   - Files without date in name (skip with debug log)
   - Archives directory doesn't exist (create it)
   - Permission errors (log and continue)
   - memory.md file (skip - it's core memory, not daily log)

Example file handling:
```python
import shutil
import gzip
from pathlib import Path

for log_file in logs_dir.glob("*.md"):
    # Skip memory.md (core memory)
    if log_file.name == "memory.md":
        continue

    try:
        file_date = datetime.strptime(log_file.stem, "%Y-%m-%d")
    except ValueError:
        continue  # Not a date-stamped file

    if file_date < cutoff_date:
        archive_path = archive_dir / log_file.name
        shutil.move(str(log_file), str(archive_path))
        archived_count += 1
```
  </action>
  <verify>
```bash
cd c:/Users/lucid/OneDrive/Desktop/Projects/Jarvis
python -c "
from core.memory.reflect import archive_old_logs
import inspect
sig = inspect.signature(archive_old_logs)
print(f'archive_old_logs signature: {sig}')
print('Function exists and is importable')
"
```
  </verify>
  <done>
archive_old_logs() exists, moves logs >30 days to archives/, optionally compresses logs >90 days, returns stats.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate into reflect_daily and test</name>
  <files>core/memory/reflect.py</files>
  <action>
1. Update reflect_daily() to call both functions after entity updates:
   ```python
   # Step 5: Evolve preference confidence
   pref_stats = evolve_preference_confidence(yesterday_start)
   logger.info(f"Preference evolution: {pref_stats}")

   # Step 6: Archive old logs
   archive_stats = archive_old_logs(archive_after_days=30)
   logger.info(f"Log archival: {archive_stats}")
   ```

2. Add to return stats dict:
   - preferences_evolved: pref_stats.get("preferences_evolved", 0)
   - logs_archived: archive_stats.get("archived", 0)

3. Test the full flow:
```python
from core.memory.reflect import evolve_preference_confidence, archive_old_logs
from datetime import datetime, timedelta

# Test preference evolution (may have no results if no preference facts)
since = datetime.utcnow() - timedelta(days=7)
pref_result = evolve_preference_confidence(since)
print(f"Preference result: {pref_result}")

# Test log archival (will create archives dir)
archive_result = archive_old_logs(archive_after_days=30)
print(f"Archive result: {archive_result}")

# Verify archives directory exists
from core.memory.config import get_config
config = get_config()
archives_dir = config.memory_dir / "memory" / "archives"
print(f"Archives directory exists: {archives_dir.exists()}")
```

4. Fix any issues found during testing
  </action>
  <verify>
```bash
cd c:/Users/lucid/OneDrive/Desktop/Projects/Jarvis
python -c "
from core.memory.reflect import reflect_daily
import inspect

# Verify both functions are called
source = inspect.getsource(reflect_daily)
assert 'evolve_preference_confidence' in source, 'Missing preference evolution'
assert 'archive_old_logs' in source, 'Missing log archival'
print('Both functions integrated into reflect_daily')

# Run a quick test
result = reflect_daily()
print(f'reflect_daily status: {result.get(\"status\")}')
"
```
  </verify>
  <done>
reflect_daily() calls evolve_preference_confidence() and archive_old_logs(). Return stats include preference and archival counts. Archives directory created when needed.
  </done>
</task>

</tasks>

<verification>
All verification steps must pass:

1. evolve_preference_confidence() exists and handles confidence bounds
2. archive_old_logs() exists and creates archives directory
3. Both functions integrated into reflect_daily()
4. Return stats include preference_evolved and logs_archived counts
5. Archives directory exists at ~/.lifeos/memory/memory/archives/
</verification>

<success_criteria>
- Preference confidence evolution uses correct bounds (+0.1 confirm, -0.15 contradict, 0.1-0.95 range)
- Preference flips when confidence drops below 0.3
- Logs >30 days move to archives/
- Logs >90 days optionally compress to .gz
- Requirements REF-004 and REF-005 satisfied
</success_criteria>

<output>
After completion, create `.planning/memory-integration/phases/08-reflect-intelligence/08-03-SUMMARY.md`
</output>
