---
phase: 07-retain-recall-functions
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - core/memory/entity_profiles.py
  - core/memory/__init__.py
autonomous: true

must_haves:
  truths:
    - "Token profiles exist as markdown files in bank/entities/tokens/"
    - "User profiles exist as markdown files in bank/entities/users/"
    - "Strategy profiles exist as markdown files in bank/entities/strategies/"
    - "get_entity_profile() returns profile content or None if not exists"
    - "update_entity_profile() appends new facts and updates summary"
  artifacts:
    - path: "core/memory/entity_profiles.py"
      provides: "Entity profile CRUD operations"
      exports: ["get_entity_profile", "update_entity_profile", "create_entity_profile", "get_entity_summary"]
  key_links:
    - from: "core/memory/entity_profiles.py"
      to: "core/memory/config.py"
      via: "MemoryConfig.entities_dir for profile path"
      pattern: "get_config\\(\\)"
    - from: "core/memory/entity_profiles.py"
      to: "core/memory/database.py"
      via: "DatabaseManager for entities table"
      pattern: "get_db\\(\\)"
---

<objective>
Create the entity profile system for managing markdown-based entity knowledge in bank/entities/.

Purpose: Entity profiles provide persistent, human-readable summaries of tokens, users, and strategies that Jarvis has learned about. These profiles are updated as new facts are stored and can be queried to provide context for decisions.

Output:
- core/memory/entity_profiles.py with profile CRUD operations
- Exports added to core/memory/__init__.py
- Integration with existing entities table in SQLite
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/memory-integration/ROADMAP.md
@.planning/memory-integration/phases/07-retain-recall-functions/07-RESEARCH.md

# Phase 6 foundations
@core/memory/config.py - Provides MemoryConfig with entities_dir paths
@core/memory/workspace.py - Created bank/entities/tokens/, users/, strategies/ directories
@core/memory/schema.py - entities table with name, type, summary, metadata
@core/memory/retain.py - get_or_create_entity() for entity creation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create entity profile management module</name>
  <files>core/memory/entity_profiles.py</files>
  <action>
    Create core/memory/entity_profiles.py for markdown entity profile management:

    1. Implement get_entity_type_dir() helper:
       ```python
       def get_entity_type_dir(entity_type: str) -> Path:
           """Get directory for entity type (tokens, users, strategies, other)"""
           config = get_config()
           type_dirs = {
               "token": config.entities_dir / "tokens",
               "user": config.entities_dir / "users",
               "strategy": config.entities_dir / "strategies",
               "other": config.entities_dir,
           }
           return type_dirs.get(entity_type, config.entities_dir)
       ```

    2. Implement get_entity_profile():
       ```python
       def get_entity_profile(entity_name: str) -> Optional[Dict[str, Any]]:
           """
           Get entity profile from markdown file and database.

           Returns:
               Dict with keys: name, type, summary, metadata, profile_content, facts_count
               None if entity doesn't exist
           """
       ```
       - First check entities table for type and summary
       - Then read markdown file from appropriate directory
       - Sanitize entity_name for filesystem (replace @, $, special chars)

    3. Implement create_entity_profile():
       ```python
       def create_entity_profile(
           entity_name: str,
           entity_type: str,  # token, user, strategy, other
           summary: str = "",
           metadata: Optional[Dict[str, Any]] = None,
       ) -> bool:
       ```
       - Create markdown file with template header
       - Insert/update entities table
       - Template format:
         ```markdown
         # {entity_name}

         **Type:** {entity_type}
         **Created:** {date}

         ## Summary
         {summary}

         ## Facts
         <!-- Facts are appended here by update_entity_profile -->

         ## Metadata
         {metadata as yaml}
         ```

    4. Implement update_entity_profile():
       ```python
       def update_entity_profile(
           entity_name: str,
           new_fact: str,
           update_summary: bool = False,
           new_summary: Optional[str] = None,
       ) -> bool:
       ```
       - Append new fact with timestamp to ## Facts section
       - Optionally update ## Summary section
       - Update entities.summary in database if new_summary provided

    5. Use thread-safe file operations (open with proper locking context)

    6. Handle entity names with special characters (@KR8TIV -> KR8TIV.md)

    Do NOT use external markdown parser - use simple string operations.
    Do NOT create duplicate files for same entity (normalize names).
  </action>
  <verify>
    ```python
    # Test entity profile creation
    from core.memory.entity_profiles import create_entity_profile, get_entity_profile
    from pathlib import Path

    # Create token profile
    result = create_entity_profile(
        entity_name="@KR8TIV",
        entity_type="token",
        summary="Community token from KR8TIV creator",
        metadata={"mint": "test123", "launch_date": "2026-01-01"}
    )
    assert result == True

    # Verify file exists
    from core.memory import get_config
    config = get_config()
    profile_path = config.entities_dir / "tokens" / "KR8TIV.md"
    assert profile_path.exists()

    # Get profile
    profile = get_entity_profile("@KR8TIV")
    assert profile is not None
    assert profile["name"] == "@KR8TIV"
    assert profile["type"] == "token"

    print("Entity profile creation working!")
    ```
  </verify>
  <done>create_entity_profile() and get_entity_profile() work correctly with markdown files and database</done>
</task>

<task type="auto">
  <name>Task 2: Add entity profile update and summary functions</name>
  <files>core/memory/entity_profiles.py, core/memory/__init__.py</files>
  <action>
    Add update functionality and convenience functions to entity_profiles.py:

    1. Implement update_entity_profile() (from Task 1 spec):
       - Read existing file
       - Find ## Facts section
       - Append new fact with timestamp: `- [{timestamp}] {fact}`
       - Write back file
       - Update database summary if new_summary provided

    2. Implement get_entity_summary():
       ```python
       def get_entity_summary(entity_name: str) -> Optional[str]:
           """Get just the summary string for an entity (fast lookup)"""
           # Query entities table summary column
       ```

    3. Implement list_entities():
       ```python
       def list_entities(
           entity_type: Optional[str] = None,
           limit: int = 100,
       ) -> List[Dict[str, Any]]:
           """List all known entities, optionally filtered by type"""
       ```

    4. Implement get_entity_facts():
       ```python
       def get_entity_facts(
           entity_name: str,
           k: int = 10,
       ) -> List[Dict[str, Any]]:
           """Get facts mentioning this entity from entity_mentions table"""
       ```

    5. Add hook for automatic profile updates when facts are stored:
       ```python
       def on_fact_stored(fact_id: int, content: str, entities: List[str]) -> None:
           """Called after retain_fact() to update entity profiles"""
           for entity in entities:
               update_entity_profile(entity, content)
       ```

    6. Export all functions in core/memory/__init__.py:
       - get_entity_profile
       - create_entity_profile
       - update_entity_profile
       - get_entity_summary
       - list_entities
       - get_entity_facts

    Do NOT integrate on_fact_stored with retain.py yet - that's for integration testing.
    Do NOT rewrite existing facts section - append only.
  </action>
  <verify>
    ```python
    # Test entity profile update
    from core.memory import update_entity_profile, get_entity_summary, get_entity_facts, list_entities

    # Update profile with new fact
    result = update_entity_profile(
        entity_name="@KR8TIV",
        new_fact="Traded KR8TIV with +15% profit on bags.fm graduation"
    )
    assert result == True

    # Get summary
    summary = get_entity_summary("@KR8TIV")
    assert summary is not None

    # List entities
    entities = list_entities(entity_type="token")
    assert len(entities) >= 1

    print("Entity profile update working!")
    ```
  </verify>
  <done>update_entity_profile() appends facts, get_entity_summary() returns summaries, list_entities() works</done>
</task>

</tasks>

<verification>
1. Import test: `from core.memory import get_entity_profile, create_entity_profile, update_entity_profile, get_entity_summary`
2. Profile creation: Creates markdown file in correct directory
3. Profile retrieval: Returns dict with name, type, summary, profile_content
4. Profile update: Appends facts to ## Facts section
5. Entity listing: list_entities() returns all known entities
6. Files created in: ~/.lifeos/memory/bank/entities/{tokens,users,strategies}/
</verification>

<success_criteria>
- Markdown profiles created in correct directories by entity type
- get_entity_profile() returns complete profile data
- update_entity_profile() appends without overwriting
- Database entities table stays in sync with markdown files
- Entity names with special characters (@, $) handled correctly
</success_criteria>

<output>
After completion, create `.planning/memory-integration/phases/07-retain-recall-functions/07-02-SUMMARY.md`
</output>
