---
phase: 02-open-claw-and-jupiter-perps-repair
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified: [bots/jupiter_perps/client.py, bots/jupiter_perps/reconciliation.py, bots/jupiter_perps/runner.py]
autonomous: true
requirements: [jupiter-perps-repair]

must_haves:
  truths:
    - "Anchor IDL is utilized to derive PDA interactions for Jupiter perps securely."
    - "Event-Sourced Reconciliation Loop continuously cleanses stalled positions."
    - "Transaction signing is managed through isolated KeyManager loops, not raw OS environments."
  artifacts:
    - path: "bots/jupiter_perps/reconciliation.py"
      provides: "Event loop for fixing split-brain databases"
    - path: "bots/jupiter_perps/client.py"
      provides: "Anchor API execution client"
      exports: ["derive_position_pda", "JupiterPerpsAnchorClient"]
  key_links: []
---

<objective>
Fix the broken Jupiter Perps trading system by upgrading it to use the Anchor IDL against the Native Perps Contract, and implementing the PDA Keeper reconciliation loop.

Purpose: REST Perps APIs are non-functional; direct on-chain interaction is the only safe method. We must also stop the bot from freezing by accurately tracking PDAs because "Keepers" are responsible for filling the request, leading to database desyncs.
Output: Repaired jupiter bots utilizing `anchorpy` and tracking up to 9 open PDAs.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-open-claw-and-jupiter-perps-repair/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Anchor Client for Jupiter Perps</name>
  <files>bots/jupiter_perps/client.py</files>
  <action>
    Create the `derive_position_pda(wallet, custody, collateral)` function using `solders` and the standard Jupiter Perps program ID `PERPHjGBqRHArX4DySjwM6UJHiR3sWAatqfdBS2qQJu`.
    Construct an async placeholder class that prepares the payload instructions required to send `PositionRequest` PDAs.
  </action>
  <verify>Run the script locally to derive a mock PDA for a phantom wallet address avoiding RPC timeouts.</verify>
  <done>Anchor PDA derivation is mathematically correct and generates valid Solders public keys.</done>
</task>

<task type="auto">
  <name>Task 2: Build the DB Reconciliation Loop</name>
  <files>bots/jupiter_perps/reconciliation.py</files>
  <action>
    Implement `reconciliation_loop()`. It should loop over the 9 possible PDA states (iterating custody/collateral pairs).
    It pulls on-chain truths via `rpc.get_account_info()`. If the on-chain data does not match the mocked local DB memory record of the `PositionRequest` (especially after the 45s expire window), it purges the local record.
  </action>
  <verify>Write a mock sync test looping over expected local arrays vs mock RPC responses verifying dead positions are deleted.</verify>
  <done>Local limits block capital drain, mapping 1:1 to actual chain truth.</done>
</task>

<task type="auto">
  <name>Task 3: Construct the Runner loop Integration</name>
  <files>bots/jupiter_perps/runner.py</files>
  <action>
    Implement an overarching pipeline inside the bot runner.
    Use `KeyManager` from `core.security.key_manager` for wallet instances to maintain architectural integrity.
    Pass metrics through `OpenClawSDK`, trigger client transaction build, and emit the event so the reconciliation loop can track the state until the off-chain keeper fulfills it.
  </action>
  <verify>Check syntax via `python -m py_compile bots/jupiter_perps/runner.py`</verify>
  <done>The runner fully orchestrates the intelligence gate into the execution gate asynchronously.</done>
</task>

</tasks>

<verification>
- [ ] Pytest / Syntax verification passes cleanly indicating proper Async use and object matching across `solders` and `anchorpy`.
- [ ] No `requests.get` to `api.jup.ag` is used for Perpetuals data; strictly RPC level operations.
</verification>

<success_criteria>
- The bot correctly mimics the "Two-transaction keeper model" of Jupiter without freezing.
- Anchor configurations are decoupled natively.
</success_criteria>

<output>
After completion, create `.planning/phases/02-open-claw-and-jupiter-perps-repair/02-02-SUMMARY.md`
</output>
