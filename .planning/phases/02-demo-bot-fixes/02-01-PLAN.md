---
phase: 2
plan: 1
wave: 1
name: Demo Bot Fixes & Code Refactoring
status: pending
created: 2026-01-24
---

# Phase 2.1: /demo Bot Fixes & Code Refactoring

**Goal:** Fix all /demo trading bot execution failures and refactor 391.5KB monolithic file

**Requirements:** REQ-002, REQ-007
**Priority:** P0
**Estimated Effort:** 2-3 weeks

---

## Problem Statement

Current state (from CONCERNS.md and user report):
- **tg_bot/handlers/demo.py**: 391.5KB (~10,000 lines) monolithic file
- **Trade execution failures** reported by user
- **Message handler NOT registered** in tg_bot/bot.py:181 (confirmed in user's PRD)
- Multiple execution paths (lines 354, 405, 486, 648, 7383, 8910, 9154, 9328)
- **bots/treasury/trading.py**: 3,754 lines with 65+ functions
- No comprehensive error handling
- No integration tests

**Critical Impact:**
- Users cannot execute trades (blocker for launch)
- Code unmaintainable (10K lines impossible to debug)
- High bug risk (any change could break something)

---

## Solution Design

### Target Architecture

**Break demo.py into 5 logical modules:**

1. **demo_core.py** (~200 lines) - Main handler and routing
2. **demo_trading.py** (~300 lines) - Buy/sell execution logic
3. **demo_ui.py** (~250 lines) - UI generation and button handling
4. **demo_sentiment.py** (~300 lines) - Sentiment hub integration
5. **demo_orders.py** (~250 lines) - Stop-loss/take-profit order management

**Break trading.py into 5 logical modules:**

1. **trading_core.py** (~400 lines) - Main trading orchestrator
2. **trading_execution.py** (~500 lines) - Jupiter/bags.fm execution
3. **trading_positions.py** (~400 lines) - Position management
4. **trading_risk.py** (~300 lines) - Risk management and limits
5. **trading_analytics.py** (~300 lines) - PnL tracking and reporting

**Fix Critical Issues:**
1. Register message handler in tg_bot/bot.py
2. Add comprehensive error handling to all execution paths
3. Implement retry logic with exponential backoff
4. Add integration tests for all trading flows

---

## Implementation Plan

### Task 1: Analyze Current Implementation
**Owner:** scout agent
**Effort:** 2 days

**Steps:**
1. Read entire demo.py and create call graph
2. Identify all execution paths (confirmed: 354, 405, 486, 648, 7383, 8910, 9154, 9328)
3. Map function dependencies
4. Identify duplicate code
5. Create refactoring plan

**Deliverables:**
- `demo_call_graph.png` - Visual function dependencies
- `execution_paths.md` - All trading execution paths documented
- `refactoring_design.md` - Module breakdown plan

**Verification:**
- All execution paths identified
- No orphaned functions
- Clear module boundaries defined

---

### Task 2: Register Message Handler (CRITICAL FIX)
**Owner:** spark agent
**Effort:** 1 hour

**Steps:**
1. Open tg_bot/bot.py
2. Add message handler registration (line ~181):
   ```python
   from telegram.ext import MessageHandler, filters
   from tg_bot.handlers.demo import demo_message_handler

   # In register_handlers():
   app.add_handler(
       MessageHandler(
           filters.TEXT & ~filters.COMMAND,
           demo_message_handler
       ),
       group=1
   )
   ```
3. Test handler receives messages
4. Verify buy flow works end-to-end

**Deliverables:**
- tg_bot/bot.py updated with handler registration
- Integration test for message handling

**Verification:**
- [ ] Message handler registered
- [ ] Buy flow works (user can input token address)
- [ ] Integration test passes

---

### Task 3: Extract demo_core.py Module
**Owner:** kraken agent
**Effort:** 1 day

**Steps:**
1. Create tg_bot/handlers/demo/demo_core.py
2. Extract main handler function
3. Extract routing logic (command → handler mapping)
4. Extract state management (awaiting_token, etc.)
5. Update imports

**Deliverables:**
- `tg_bot/handlers/demo/demo_core.py` (~200 lines)
- `tg_bot/handlers/demo/__init__.py` - Module exports
- Tests for routing logic

**Verification:**
- demo_core.py <250 lines
- All routing tests pass
- No circular dependencies

---

### Task 4: Extract demo_trading.py Module
**Owner:** kraken agent
**Effort:** 2 days

**Steps:**
1. Create tg_bot/handlers/demo/demo_trading.py
2. Extract buy execution logic
3. Extract sell execution logic
4. Extract swap execution (_execute_swap_with_fallback)
5. Add comprehensive error handling
6. Add retry logic (3 attempts, exponential backoff)

**Deliverables:**
- `tg_bot/handlers/demo/demo_trading.py` (~300 lines)
- Error handling for all execution paths
- Retry logic implemented
- Unit tests for trading functions

**Verification:**
- demo_trading.py <350 lines
- All execution paths have try/catch
- Retry logic tested
- 100% trade execution success rate in tests

---

### Task 5: Extract demo_ui.py Module
**Owner:** kraken agent
**Effort:** 1 day

**Steps:**
1. Create tg_bot/handlers/demo/demo_ui.py
2. Extract all UI generation functions
3. Extract button handlers
4. Extract message formatting
5. Standardize UI components

**Deliverables:**
- `tg_bot/handlers/demo/demo_ui.py` (~250 lines)
- Reusable UI components
- Tests for UI generation

**Verification:**
- demo_ui.py <300 lines
- UI components reusable
- All buttons render correctly

---

### Task 6: Extract demo_sentiment.py Module
**Owner:** kraken agent
**Effort:** 1 day

**Steps:**
1. Create tg_bot/handlers/demo/demo_sentiment.py
2. Extract sentiment hub integration
3. Extract Grok AI data fetching
4. Extract treasury activation display
5. Extract bags.fm graduation monitoring

**Deliverables:**
- `tg_bot/handlers/demo/demo_sentiment.py` (~300 lines)
- Integration with sentiment_report.py
- Tests for sentiment fetching

**Verification:**
- demo_sentiment.py <350 lines
- Sentiment data fetches successfully
- Treasury data displays correctly

---

### Task 7: Extract demo_orders.py Module
**Owner:** kraken agent
**Effort:** 1 day

**Steps:**
1. Create tg_bot/handlers/demo/demo_orders.py
2. Extract stop-loss management
3. Extract take-profit management
4. Extract order monitoring service
5. Extract ladder exit logic

**Deliverables:**
- `tg_bot/handlers/demo/demo_orders.py` (~250 lines)
- Order monitoring service
- Tests for TP/SL execution

**Verification:**
- demo_orders.py <300 lines
- TP/SL orders execute correctly
- Ladder exits work

---

### Task 8: Refactor trading.py (Treasury Bot)
**Owner:** kraken agent
**Effort:** 3 days

**Steps:**
1. Create bots/treasury/trading/ directory
2. Break into 5 modules:
   - `trading_core.py` - Main orchestrator
   - `trading_execution.py` - Jupiter/bags.fm execution
   - `trading_positions.py` - Position management
   - `trading_risk.py` - Risk management
   - `trading_analytics.py` - PnL tracking
3. Update all imports across codebase
4. Run full test suite

**Deliverables:**
- 5 new modules in bots/treasury/trading/
- Old trading.py archived
- All tests passing

**Verification:**
- No files >1000 lines
- All treasury functionality works
- Test suite passes

---

### Task 9: Add Comprehensive Error Handling
**Owner:** kraken agent
**Effort:** 2 days

**Steps:**
1. Audit all execution paths (354, 405, 486, 648, 7383, 8910, 9154, 9328)
2. Add try/catch blocks around:
   - API calls (Jupiter, bags.fm, Solana RPC)
   - Database operations
   - File I/O
   - WebSocket operations
3. Add specific error types:
   - `TradeExecutionError`
   - `InsufficientFundsError`
   - `SlippageExceededError`
   - `RPCError`
4. Add user-friendly error messages
5. Add error recovery logic (retry, fallback)

**Deliverables:**
- Custom error classes in core/errors.py
- Error handling in all execution paths
- User-friendly error messages
- Error recovery mechanisms

**Verification:**
- All execution paths have error handling
- Errors display clearly to users
- Recovery mechanisms work

---

### Task 10: Integration Testing
**Owner:** arbiter agent
**Effort:** 3 days

**Steps:**
1. Create integration test suite:
   - `test_demo_buy_flow.py` - End-to-end buy
   - `test_demo_sell_flow.py` - End-to-end sell
   - `test_demo_tp_sl.py` - Stop-loss/take-profit
   - `test_demo_sentiment.py` - Sentiment hub
   - `test_demo_errors.py` - Error scenarios
2. Test all execution paths
3. Test concurrent operations
4. Test failure scenarios (API down, RPC timeout, etc.)
5. Achieve 80%+ coverage on demo handlers

**Deliverables:**
- Integration test suite (50+ test cases)
- Coverage report (80%+ target)
- Failure scenario test results

**Verification:**
- All critical flows tested
- 80%+ code coverage
- All tests passing

---

### Task 11: Documentation
**Owner:** scribe agent
**Effort:** 1 day

**Steps:**
1. Document new module structure
2. Create developer guide for demo bot
3. Document all execution paths
4. Create troubleshooting guide
5. Update API documentation

**Deliverables:**
- `docs/demo_bot_architecture.md`
- `docs/demo_bot_developer_guide.md`
- `docs/demo_bot_troubleshooting.md`
- Inline code documentation

**Verification:**
- Documentation complete
- Developer guide clear
- Troubleshooting guide helpful

---

## Success Criteria

- [ ] 100% trade execution success rate (no failures)
- [ ] Message handler registered in tg_bot/bot.py
- [ ] demo.py broken into ≤5 modules (each <350 lines)
- [ ] trading.py broken into ≤5 modules (each <500 lines)
- [ ] No files >1000 lines
- [ ] All execution paths have error handling and retry logic
- [ ] 80%+ test coverage on demo handlers
- [ ] All integration tests passing
- [ ] User-friendly error messages (no raw exceptions)
- [ ] Documentation complete

---

## Risks & Mitigation

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Refactoring breaks existing functionality | High | Critical | Comprehensive tests, gradual rollout, feature flags |
| New bugs introduced during refactoring | High | High | 80%+ test coverage, code review, rollback plan |
| Circular dependencies in new modules | Medium | Medium | Clear module boundaries, dependency injection |
| Performance regression | Low | Medium | Performance tests before/after, profiling |

---

## Dependencies

**Blockers:** None (can start immediately)

**Parallel Work:** Can run alongside Phase 1 (Database Consolidation)

**Downstream:** Phase 3 (Vibe), Phase 4 (bags.fm), Phase 5 (Solana) depend on this

---

## Timeline

```
Week 1:
├─ Task 1: Analyze Implementation (2 days)
├─ Task 2: Register Message Handler (1 hour - CRITICAL)
├─ Task 3: Extract demo_core.py (1 day)
├─ Task 4: Extract demo_trading.py (2 days)
└─ Task 9: Error Handling (start)

Week 2:
├─ Task 5: Extract demo_ui.py (1 day)
├─ Task 6: Extract demo_sentiment.py (1 day)
├─ Task 7: Extract demo_orders.py (1 day)
├─ Task 8: Refactor trading.py (3 days)
└─ Task 9: Error Handling (finish)

Week 3:
├─ Task 10: Integration Testing (3 days)
├─ Task 11: Documentation (1 day)
└─ Final verification and cleanup
```

**Total:** 2-3 weeks (with parallel work)

---

## Verification Steps

After completion:
1. Run `wc -l tg_bot/handlers/demo/*.py` - all files <350 lines
2. Run `wc -l bots/treasury/trading/*.py` - all files <500 lines
3. Run integration tests - 100% pass rate
4. Test buy flow end-to-end - works
5. Test sell flow end-to-end - works
6. Test error scenarios - recovery works
7. Check coverage report - ≥80%

---

## Next Phase

After Phase 2 complete → Start Phase 3 (Vibe Command) and Phase 4 (bags.fm + TP/SL)

---

**Plan Version:** 1.0
**Created:** 2026-01-24
**Status:** Pending Execution
**Ready to Execute:** Yes (no blockers)
