---
phase: v2-01-core-trading
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/trading_web.py
  - web/requirements.txt
autonomous: true

must_haves:
  truths:
    - "WebSocket connection establishes and emits price_update events every 5s"
    - "All 7 API endpoints return valid JSON responses"
    - "Flask app serves static React build from web/static/"
  artifacts:
    - path: "web/trading_web.py"
      provides: "Flask + Flask-SocketIO backend with all endpoints and WebSocket"
      contains: "socketio"
  key_links:
    - from: "web/trading_web.py"
      to: "tg_bot/handlers/demo/"
      via: "import demo engine"
      pattern: "demo_trading|demo_sentiment|demo_core"
---

<objective>
Add Flask-SocketIO WebSocket support to existing web/trading_web.py and verify all 7 API endpoints work correctly.

Purpose: The Flask backend already has 6 REST endpoints. We need to add real-time WebSocket price feeds and ensure all endpoints are production-ready.
Output: Working Flask+SocketIO backend serving REST API + WebSocket on port 5001.
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/v2-01-core-trading/V2-01-RESEARCH.md
@web/trading_web.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Flask-SocketIO and WebSocket price feed</name>
  <files>web/trading_web.py, web/requirements.txt</files>
  <action>
  1. Create web/requirements.txt if missing. Include: flask, flask-cors, flask-socketio, eventlet.

  2. In web/trading_web.py:
     - Import: `from flask_socketio import SocketIO, emit` and `import os` and `from flask import send_from_directory`
     - Initialize: `socketio = SocketIO(app, cors_allowed_origins="*", async_mode="threading")`
     - Add WebSocket event handlers:
       - `@socketio.on('connect')` - log connection, emit `connection_status` with `{"status": "connected"}`
       - `@socketio.on('disconnect')` - log disconnection
       - `@socketio.on('subscribe_prices')` - accept list of token mints to track
     - Create background price polling:
       - `def price_poll_loop()` - runs every 5s via `socketio.start_background_task`
       - Fetches prices for all active position token mints using Jupiter price API (https://api.jup.ag/price/v2?ids=MINT1,MINT2)
       - Emits `price_update` event with `{mint: {price, change_24h}}` dict to all connected clients
       - Emits `position_update` event with recalculated P&L for each position
     - Start polling on first client connect, stop when no clients connected

  3. Change the `app.run()` at bottom to `socketio.run(app, host="0.0.0.0", port=5001, debug=True)`

  4. Add `GET /api/health` endpoint returning `{"status": "ok", "websocket": true, "endpoints": 7}`

  5. Add static file serving for React SPA:
     - Set `static_folder='static'` and `static_url_path=''` on Flask app
     - Add catch-all route AFTER all /api/ routes:
       ```python
       @app.route('/', defaults={'path': ''})
       @app.route('/<path:path>')
       def serve_react(path):
           if path and os.path.exists(os.path.join(app.static_folder, path)):
               return send_from_directory(app.static_folder, path)
           return send_from_directory(app.static_folder, 'index.html')
       ```
  </action>
  <verify>
  Run: `cd "c:\Users\lucid\OneDrive\Desktop\Projects\Jarvis" && python -c "from web.trading_web import app, socketio; print('OK')"` succeeds.
  Verify socketio variable exists in trading_web.py via grep.
  </verify>
  <done>
  Flask-SocketIO initialized, WebSocket handlers defined, price polling background task created, static file serving configured, health endpoint returns correct response.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify and harden all 7 API endpoints</name>
  <files>web/trading_web.py</files>
  <action>
  Read the full web/trading_web.py and verify each endpoint exists and handles errors properly. For each:

  1. `GET /api/status` - Must return `{wallet_address, sol_balance, usd_value, position_count, market_regime}`. Wrap in try/except returning 500 with `{"error": str(e)}`.

  2. `GET /api/positions` - Must return array of position objects. Add `?sort=pnl` query param support (default: entry_time desc). Wrap in try/except.

  3. `POST /api/token/sentiment` - Accepts `{token_address}`. Returns `{sentiment, score, signal, reasoning}`. Validate token_address present (400 if missing).

  4. `POST /api/trade/buy` - Accepts `{token_address, amount_sol, tp_pct, sl_pct}`. Validate: amount_sol > 0, tp_pct and sl_pct REQUIRED (400 if missing with message "TP and SL are mandatory"). Returns `{success, tx_hash, position_id, error}`.

  5. `POST /api/trade/sell` - Accepts `{position_id, percentage}` where percentage is 25/50/100. Validate both fields present. Returns `{success, tx_hash, pnl_sol, pnl_pct, fee_sol, error}`.

  6. `GET /api/market/regime` - Returns `{regime, confidence, description}`.

  7. `GET /api/health` - (from Task 1).

  For EXISTING working endpoints: only add error handling wrappers if missing. Do NOT rewrite logic.
  For MISSING endpoints: implement by importing from existing demo handlers in tg_bot/handlers/demo/.
  </action>
  <verify>
  Grep web/trading_web.py for all 7 route decorators: `/api/status`, `/api/positions`, `/api/token/sentiment`, `/api/trade/buy`, `/api/trade/sell`, `/api/market/regime`, `/api/health`. All must exist.
  Each endpoint must have try/except error handling.
  </verify>
  <done>
  All 7 endpoints exist with proper error handling. Invalid inputs return 400. Server errors return 500 with error message.
  </done>
</task>

</tasks>

<verification>
- `python -c "from web.trading_web import app, socketio"` imports without error
- All 7 `/api/*` routes present in source
- SocketIO event handlers for connect/disconnect defined
- Background price polling function exists
- Static file serving configured
</verification>

<success_criteria>
- Flask-SocketIO backend ready on port 5001
- All 7 REST endpoints verified with error handling
- WebSocket infrastructure ready for frontend connection
- Static file serving ready for React build
</success_criteria>

<output>
After completion, create `.planning/phases/v2-01-core-trading/v2-01-01-SUMMARY.md`
</output>
