---
phase: v2.1
plan: 1
wave: 1
name: Core Trading MVP
status: pending
created: 2026-02-01
---

# V2 Phase 1.1: Core Trading MVP

**Goal:** Build minimum viable web trading interface with all P0 features (portfolio, buy, sell, sentiment, real-time updates)

**Requirements:** REQ-V2-001 to REQ-V2-006
**Priority:** P0
**Estimated Effort:** 2-3 weeks

---

## Problem Statement

Current state:
- Trading functionality only available via Telegram `/demo` bot
- No web interface for trading
- Users must use Telegram for all trading operations
- No real-time web updates for positions

**Target:**
- Full trading capability in a modern React web dashboard
- Real-time position monitoring via WebSocket
- Mobile-responsive dark mode design
- Reuse 85% of existing trading logic

---

## Solution Design

### Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    React Frontend (Port 5001)                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │  Portfolio  │ │  Positions  │ │  Buy/Sell   │            │
│  │  Dashboard  │ │    List     │ │   Modals    │            │
│  └─────────────┘ └─────────────┘ └─────────────┘            │
│                                                              │
│  WebSocket ───────────────────────────────────▶ Price Feed  │
└─────────────────────────┬───────────────────────────────────┘
                          │ HTTP + WS
                          ▼
┌─────────────────────────────────────────────────────────────┐
│              Flask + Flask-SocketIO (Port 5001)             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                    API Endpoints                     │    │
│  │  /api/status  /api/positions  /api/trade/buy|sell   │    │
│  │  /api/token/sentiment  /api/market/regime           │    │
│  └─────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                   WebSocket Events                   │    │
│  │  price_update  position_update  connection_status   │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                   Existing Trading Logic                     │
│  tg_bot/handlers/demo/  │  core/trading/bags_client.py     │
│  core/exit_intents.py   │  bots/treasury/trading.py        │
└─────────────────────────────────────────────────────────────┘
```

### Component Breakdown

**Backend (Flask + Flask-SocketIO):**
- `/api/status` - GET wallet balance, SOL price, position count
- `/api/positions` - GET all positions with real-time P&L
- `/api/token/sentiment` - POST token address, return AI sentiment
- `/api/trade/buy` - POST buy order with mandatory TP/SL
- `/api/trade/sell` - POST sell order (partial or full)
- `/api/market/regime` - GET current market regime
- WebSocket `/ws/prices` - Real-time price updates

**Frontend (React + TailwindCSS):**
- PortfolioHeader - Balance, P&L, position count
- PositionsList - All positions with sort/filter
- PositionCard - Individual position with actions
- BuyModal - Token input, amount, TP/SL
- SellModal - Position sell with preview
- SentimentPanel - AI analysis display
- ConnectionIndicator - WebSocket status

---

## Implementation Plan

### Task 1: Backend API Setup
**Owner:** kraken agent
**Effort:** 2 days

**Steps:**
1. Create `web/trading_api.py` extending existing `web/trading_web.py`
2. Add Flask-SocketIO for WebSocket support
3. Implement `/api/status` endpoint
   - Import from `tg_bot/handlers/demo/` wallet utilities
   - Return `{wallet_address, sol_balance, usd_value, position_count}`
4. Implement `/api/positions` endpoint
   - Import from `core/exit_intents.py`
   - Return array of positions with P&L calculated
5. Wire Flask-SocketIO for real-time events
6. Add CORS configuration for local development

**Verification:**
- [ ] `/api/status` returns wallet data
- [ ] `/api/positions` returns position array
- [ ] WebSocket connection establishes

---

### Task 2: Trading Endpoints
**Owner:** kraken agent
**Effort:** 2 days

**Steps:**
1. Implement `/api/trade/buy` endpoint
   - Validate mandatory TP/SL (default: TP=50%, SL=20%)
   - Import `execute_buy_with_tpsl` from demo trading
   - Connect to bags.fm (primary) + Jupiter (fallback)
   - Return `{success, tx_hash, position_id, error}`
2. Implement `/api/trade/sell` endpoint
   - Support partial sells (25%, 50%, 100%)
   - Import sell logic from demo callbacks
   - Calculate 0.5% success fee on profits
   - Return `{success, tx_hash, pnl, error}`
3. Implement `/api/token/sentiment` endpoint
   - Import Grok sentiment from `demo_sentiment.py`
   - Return `{sentiment, score, signal, reasoning}`
4. Implement `/api/market/regime` endpoint
   - Import regime detection logic
   - Return `{regime, confidence, volatility}`

**Verification:**
- [ ] Buy endpoint creates position with TP/SL
- [ ] Sell endpoint closes position correctly
- [ ] Sentiment returns valid analysis
- [ ] Market regime updates

---

### Task 3: WebSocket Price Feed
**Owner:** spark agent
**Effort:** 1 day

**Steps:**
1. Create price polling service (5s interval)
   - Import Jupiter price API
   - Cache prices for active positions
2. Emit `price_update` events via SocketIO
   - Include position P&L recalculation
3. Add connection/disconnection handling
4. Implement reconnection logic

**Verification:**
- [ ] Price updates every 5 seconds
- [ ] P&L recalculates on price change
- [ ] Reconnection works after disconnect

---

### Task 4: React Frontend Setup
**Owner:** kraken agent
**Effort:** 2 days

**Steps:**
1. Extend existing `frontend/` structure
2. Add TailwindCSS configuration
   - Dark mode as default
   - Mobile-first breakpoints
3. Create page layout
   - Header with wallet info
   - Main trading area
   - Sidebar for navigation
4. Configure Socket.IO client
5. Set up state management (React Context or Zustand)

**Verification:**
- [ ] React app loads at http://localhost:5001
- [ ] Dark mode styling applied
- [ ] WebSocket connects on load

---

### Task 5: Portfolio Components
**Owner:** spark agent
**Effort:** 2 days

**Steps:**
1. Create PortfolioHeader component
   - Display SOL balance
   - Display USD value
   - Show total P&L (with color coding)
   - Show position count
2. Create PositionsList component
   - Fetch from `/api/positions`
   - Display sortable table/grid
   - Implement P&L color coding
3. Create PositionCard component
   - Token symbol + logo
   - Entry/current price
   - P&L percentage
   - TP/SL indicators
   - Quick sell buttons

**Verification:**
- [ ] Portfolio header shows correct balance
- [ ] Positions list renders all positions
- [ ] Position cards display accurate P&L

---

### Task 6: Trading Modals
**Owner:** kraken agent
**Effort:** 2 days

**Steps:**
1. Create BuyModal component
   - Token address input with validation
   - Quick buy buttons (0.05, 0.1, 0.25, 0.5, 1, 2 SOL)
   - Custom amount input
   - TP/SL sliders (default: TP=50%, SL=20%)
   - Get sentiment before buy
   - Submit to `/api/trade/buy`
   - Show success/error toast
2. Create SellModal component
   - Select position to sell
   - Partial sell buttons (25%, 50%, 100%)
   - P&L preview before confirm
   - Submit to `/api/trade/sell`
   - Show success/error toast
3. Create SentimentPanel component
   - Display sentiment analysis
   - Color-coded signal indicator
   - AI reasoning display

**Verification:**
- [ ] Buy modal validates TP/SL
- [ ] Buy modal executes trade
- [ ] Sell modal shows preview
- [ ] Sell modal executes trade
- [ ] Sentiment displays correctly

---

### Task 7: Real-Time Updates
**Owner:** spark agent
**Effort:** 1 day

**Steps:**
1. Connect Socket.IO to React state
2. Update positions on `price_update` event
3. Add ConnectionIndicator component
   - Green: connected
   - Yellow: reconnecting
   - Red: disconnected
4. Implement auto-refresh fallback (30s HTTP poll)

**Verification:**
- [ ] Positions update in real-time
- [ ] Connection indicator shows status
- [ ] Fallback works if WebSocket fails

---

### Task 8: Mobile Responsiveness
**Owner:** spark agent
**Effort:** 1 day

**Steps:**
1. Configure TailwindCSS breakpoints
   - sm: 640px
   - md: 768px
   - lg: 1024px
2. Adjust layout for mobile
   - Stack components vertically
   - Hide sidebar on mobile (hamburger menu)
   - Larger touch targets
3. Test on mobile viewport

**Verification:**
- [ ] Works on 375px width (iPhone)
- [ ] Works on 768px width (tablet)
- [ ] Touch targets are accessible

---

### Task 9: Integration Testing
**Owner:** arbiter agent
**Effort:** 2 days

**Steps:**
1. Test buy flow end-to-end
   - Enter token → Set TP/SL → Execute → Verify position
2. Test sell flow end-to-end
   - Select position → Choose % → Execute → Verify close
3. Test real-time updates
   - Open position → Wait for price change → Verify P&L update
4. Test error handling
   - Invalid token → Verify error message
   - Insufficient balance → Verify error message
   - Network failure → Verify graceful degradation
5. Test mobile experience

**Verification:**
- [ ] All happy paths work
- [ ] Error states handled gracefully
- [ ] Mobile experience acceptable

---

## Dependencies

| Dependency | Source | Status |
|------------|--------|--------|
| Trading logic | `tg_bot/handlers/demo/` | Available |
| bags.fm client | `core/trading/bags_client.py` | Available |
| Jupiter client | `core/jupiter_client.py` | Available |
| Exit intents | `core/exit_intents.py` | Available |
| Grok sentiment | `demo_sentiment.py` | Available |

---

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| WebSocket instability | Reconnection logic + HTTP fallback |
| Port conflict with task_web | Use port 5001 (task_web uses 5000) |
| Trading logic coupling | Import modules, don't copy code |
| Mobile responsiveness | TailwindCSS responsive utilities |

---

## Success Criteria

- [ ] Portfolio dashboard shows accurate balance and P&L
- [ ] Buy flow works with mandatory TP/SL
- [ ] Sell flow works (25%, 50%, 100%)
- [ ] AI sentiment displays for any token
- [ ] Real-time prices update via WebSocket
- [ ] Mobile-responsive layout
- [ ] All error states have friendly messages
- [ ] <500ms API response time

---

## Next Phase Preview

**Phase 2: Discovery Features** will add:
- Trending tokens (Bags.fm top 15)
- TP/SL adjustment
- Trailing stops
- Watchlist
- Price alerts

---

**Document Version:** 1.0
**Created:** 2026-02-01
**Author:** Claude Code (Opus 4.5)
