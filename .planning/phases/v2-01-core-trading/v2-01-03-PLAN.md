---
phase: v2-01-core-trading
plan: 03
type: execute
wave: 2
depends_on: ["v2-01-01", "v2-01-02"]
files_modified:
  - web/static/src/components/BuyModal.jsx
  - web/static/src/components/SellModal.jsx
  - web/static/src/components/SentimentPanel.jsx
  - web/static/src/components/PositionCard.jsx
  - web/static/src/App.jsx
  - web/static/src/hooks/useTrading.js
autonomous: false

must_haves:
  truths:
    - "User can buy a token with mandatory TP/SL via the web UI"
    - "User can sell a position (25/50/100%) via the web UI"
    - "AI sentiment analysis displays before buying"
    - "Real-time prices update positions without page refresh"
    - "Mobile layout works on 375px width"
  artifacts:
    - path: "web/static/src/components/BuyModal.jsx"
      provides: "Buy token flow with TP/SL and sentiment"
      min_lines: 60
    - path: "web/static/src/components/SellModal.jsx"
      provides: "Sell position flow with P&L preview"
      min_lines: 40
    - path: "web/static/src/hooks/useTrading.js"
      provides: "Buy and sell API calls"
      min_lines: 20
  key_links:
    - from: "web/static/src/hooks/useTrading.js"
      to: "/api/trade/buy"
      via: "fetch POST"
      pattern: "fetch.*api/trade/buy"
    - from: "web/static/src/hooks/useTrading.js"
      to: "/api/trade/sell"
      via: "fetch POST"
      pattern: "fetch.*api/trade/sell"
    - from: "web/static/src/components/BuyModal.jsx"
      to: "/api/token/sentiment"
      via: "fetch POST"
      pattern: "fetch.*api/token/sentiment"
---

<objective>
Wire trading modals (buy/sell), sentiment panel, and verify the full end-to-end flow works.

Purpose: Complete the interactive trading features - buy tokens, sell positions, view AI sentiment.
Output: Fully functional web trading interface with all P0 features working end-to-end.
</objective>

<execution_context>
@C:\Users\lucid\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lucid\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/v2-01-core-trading/v2-01-01-SUMMARY.md
@.planning/phases/v2-01-core-trading/v2-01-02-SUMMARY.md
@web/trading_web.py
@web/static/src/App.jsx
@web/static/src/store.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Buy modal, sell modal, and sentiment panel</name>
  <files>web/static/src/components/BuyModal.jsx, web/static/src/components/SellModal.jsx, web/static/src/components/SentimentPanel.jsx, web/static/src/hooks/useTrading.js, web/static/src/components/PositionCard.jsx, web/static/src/App.jsx</files>
  <action>
  1. src/hooks/useTrading.js:
     - `buyToken({token_address, amount_sol, tp_pct, sl_pct})` - POST /api/trade/buy, returns result
     - `sellPosition({position_id, percentage})` - POST /api/trade/sell, returns result
     - `getSentiment(token_address)` - POST /api/token/sentiment, returns sentiment data
     - All functions: handle loading state, error state, return {data, error, loading}
     - After successful buy/sell, trigger position refresh from store

  2. src/components/BuyModal.jsx:
     - Trigger: floating "Buy" button (bottom-right, green, fixed position)
     - Modal overlay (dark backdrop)
     - Token address input (paste Solana mint address)
     - "Get Sentiment" button -> calls getSentiment, shows SentimentPanel inline
     - Quick amount buttons: 0.05, 0.1, 0.25, 0.5, 1, 2 SOL (highlight selected)
     - Custom amount input
     - TP slider: 10-200% (default 50%) with numeric display
     - SL slider: 5-50% (default 20%) with numeric display
     - "Buy" submit button (disabled until token + amount + TP + SL set)
     - Loading spinner during trade execution
     - Success: green toast "Bought [symbol]! TX: [hash]", close modal, refresh positions
     - Error: red toast with error message
     - Close button (X) and click-outside-to-close

  3. src/components/SellModal.jsx:
     - Trigger: sell buttons on PositionCard (passed position object as prop)
     - Shows position details: symbol, entry price, current price, P&L
     - Percentage buttons: 25%, 50%, 100% (highlight selected)
     - P&L preview: "Estimated P&L: +0.05 SOL (+12.5%)" (calculate from current data)
     - Fee note: "0.5% success fee on profits"
     - "Confirm Sell" button
     - Loading spinner during execution
     - Success/error toasts same as buy

  4. src/components/SentimentPanel.jsx:
     - Receives sentiment data as prop
     - Display: Score (0-100 with color gradient), Signal (STRONG_BUY/BUY/NEUTRAL/SELL/STRONG_SELL as colored pill)
     - Sentiment text (1-2 lines)
     - AI reasoning (collapsible, shows full analysis)
     - Loading skeleton while fetching

  5. Update PositionCard.jsx:
     - Wire 25/50/100% sell buttons to open SellModal with position data
     - Add onClick handler prop

  6. Update App.jsx:
     - Add BuyModal (always rendered, visibility controlled by state)
     - Add SellModal (rendered when position selected)
     - Simple toast system: array of {message, type, id} in state, auto-dismiss after 3s
     - Toast renders as fixed bottom-left stack

  Mobile: All modals must be full-screen on mobile (< 640px), centered card on desktop.
  </action>
  <verify>
  Run `cd "c:\Users\lucid\OneDrive\Desktop\Projects\Jarvis\web\static" && npm run build` succeeds.
  BuyModal.jsx contains fetch to /api/trade/buy.
  SellModal.jsx contains fetch to /api/trade/sell.
  BuyModal.jsx contains fetch to /api/token/sentiment.
  </verify>
  <done>
  Buy modal with token input, quick amounts, TP/SL sliders, and sentiment preview. Sell modal with percentage selection and P&L preview. Toast notifications for success/error. All modals mobile-responsive.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete web trading dashboard with portfolio view, position list, buy/sell modals, AI sentiment, and real-time WebSocket updates.</what-built>
  <how-to-verify>
  1. Start backend: `cd "c:\Users\lucid\OneDrive\Desktop\Projects\Jarvis" && python -m web.trading_web`
  2. Build frontend: `cd "c:\Users\lucid\OneDrive\Desktop\Projects\Jarvis\web\static" && npm run build`
  3. Copy build to Flask static: copy dist/* contents to be served by Flask
  4. Open http://localhost:5001 in browser
  5. Verify:
     a. Portfolio header shows SOL balance, USD value, P&L, position count
     b. Position cards display with P&L color coding (green/red)
     c. Connection indicator shows green dot (WebSocket connected)
     d. Click "Buy" button -> modal opens with token input, amount buttons, TP/SL sliders
     e. Paste a token address -> click "Get Sentiment" -> sentiment panel displays
     f. Click sell button on a position -> sell modal shows P&L preview
     g. Resize browser to 375px width -> layout stacks vertically, modals go full-screen
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- npm run build succeeds in web/static/
- All trading flows wired: buy -> API -> refresh, sell -> API -> refresh
- Sentiment fetched before buy
- WebSocket updates positions in real-time
- Mobile responsive at 375px
- Toast notifications for success/error
</verification>

<success_criteria>
- User can view portfolio with real-time P&L
- User can buy a token with mandatory TP/SL
- User can sell a position (25/50/100%)
- AI sentiment displays for any token
- Real-time prices update via WebSocket
- Mobile-responsive dark mode layout
- All REQ-V2-001 through REQ-V2-006 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/v2-01-core-trading/v2-01-03-SUMMARY.md`
</output>
