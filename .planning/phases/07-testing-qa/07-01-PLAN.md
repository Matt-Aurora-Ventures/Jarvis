# Phase 7: Testing & QA

**Phase**: 7 of 8
**Timeline**: 1-2 weeks
**Priority**: P1 (Quality Bar for V1)
**Status**: Planning
**Dependencies**: Phases 1-6 complete

---

## Objective

Achieve 80%+ test coverage and validate all critical user flows.

**Success Criteria:**
- 80%+ code coverage on critical paths
- All V1 features tested end-to-end
- Performance benchmarks met
- Zero P0/P1 bugs remaining
- Load testing passed

---

## Test Strategy

### Test Pyramid

```
         E2E Tests (10%)
       ↗
   Integration Tests (30%)
 ↗
Unit Tests (60%)
```

---

## Tasks Breakdown

### Task 1: Unit Tests (3-4 days)

**Target Coverage**: 80%+ on:
- `core/trading/bags_client.py` (876 lines)
- `tg_bot/handlers/demo/demo_trading.py` (403 lines)
- `tg_bot/handlers/demo/demo_orders.py` (432 lines)
- `tg_bot/handlers/demo/demo_sentiment.py` (484 lines)
- `bots/treasury/trading.py` (after refactor)

**Framework**: pytest + pytest-asyncio

**Example Tests**:
```python
# tests/unit/test_bags_client.py
import pytest
from core.trading.bags_client import BagsAPIClient

@pytest.mark.asyncio
async def test_get_quote_success():
    """Test successful quote retrieval."""
    client = BagsAPIClient()
    quote = await client.get_quote(
        from_token="SOL",
        to_token="USDC",
        amount=0.1
    )
    assert quote is not None
    assert quote.from_amount == 0.1
    assert quote.to_amount > 0

@pytest.mark.asyncio
async def test_swap_with_priority_fee():
    """Test swap includes priority fee."""
    # Mock implementation
    pass
```

**Success Criteria:**
- 80%+ coverage
- All critical functions tested
- Edge cases covered

**Risk**: MEDIUM

---

### Task 2: Integration Tests (2-3 days)

**Test Flows:**
1. **bags.fm → Jupiter Fallback**
2. **TP/SL Trigger → Auto-Exit**
3. **WebSocket → Price Update → Alert**
4. **Transaction Simulation → Send → Confirm**

**Framework**: pytest + testcontainers (for DB)

**Example**:
```python
# tests/integration/test_bags_jupiter_flow.py
@pytest.mark.asyncio
async def test_bags_failure_jupiter_success():
    """Test Jupiter fallback when bags.fm fails."""
    # Mock bags.fm to fail
    with mock.patch("core.trading.bags_client.BagsAPIClient.swap") as mock_swap:
        mock_swap.side_effect = Exception("Bags down")

        # Execute trade
        result = await execute_buy_with_tpsl(
            token_address="test",
            amount_sol=0.01,
            wallet_address="test",
            tp_percent=50.0,
            sl_percent=20.0
        )

        # Verify Jupiter was used
        assert result["via"] == "jupiter"
        assert result["success"] == True
```

**Success Criteria:**
- All critical flows tested
- Failure modes covered
- Database transactions tested

**Risk**: MEDIUM

---

### Task 3: End-to-End Tests (2-3 days)

**User Flows:**
1. `/demo` → buy → TP hit → sell
2. `/vibe` → code change → verification
3. `/demo` → sentiment analysis → trade decision
4. bags.fm partnership fee collection

**Framework**: playwright + Telegram Bot API testing

**Example**:
```python
# tests/e2e/test_demo_bot_flow.py
async def test_full_trade_cycle():
    """Test complete /demo trade cycle."""
    # 1. Send /demo command
    # 2. Click buy button
    # 3. Confirm trade
    # 4. Wait for TP trigger
    # 5. Verify auto-exit
    pass
```

**Success Criteria:**
- All V1 user flows tested
- Telegram interactions validated
- Real Solana transactions tested (Devnet)

**Risk**: HIGH (complexity)

---

### Task 4: Performance Testing (1-2 days)

**Benchmarks:**
- Transaction confirmation: <500ms (p95)
- API response time: <200ms (p95)
- WebSocket latency: <50ms
- Database query time: <50ms (p95)

**Tools**: locust, pytest-benchmark

**Example**:
```python
# tests/performance/test_api_latency.py
def test_bags_api_latency(benchmark):
    """Benchmark bags.fm API calls."""
    result = benchmark(lambda: asyncio.run(client.get_quote(...)))
    assert result < 0.2  # 200ms
```

**Success Criteria:**
- All benchmarks met
- No performance regressions
- Load test: 100 concurrent users

**Risk**: LOW

---

### Task 5: Regression Testing (1 day)

**Test Matrix:**
- All existing features still work
- No breaking changes
- Backward compatibility maintained

**Success Criteria:**
- Zero regressions
- All old tests pass

**Risk**: LOW

---

## Phase Exit Criteria

- [ ] 80%+ unit test coverage
- [ ] All integration tests passing
- [ ] E2E tests for V1 features passing
- [ ] Performance benchmarks met
- [ ] Zero P0/P1 bugs

---

**Timeline**: 1-2 weeks (60-80 hours)
**Risk Level**: MEDIUM (comprehensive testing takes time)

**Document Version**: 1.0
**Created**: 2026-01-24
