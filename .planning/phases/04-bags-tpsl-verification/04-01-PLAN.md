# Phase 4: bags.fm + TP/SL Verification & Enhancement

**Phase**: 4 of 8
**Timeline**: 1-2 weeks
**Priority**: P0 (Must-Have for V1)
**Status**: Planning
**Dependencies**: None (can run parallel)

---

## Objective

Verify and enhance bags.fm API integration with mandatory TP/SL enforcement on ALL trades.

**Success Criteria:**
- bags.fm API verified working with configured keys
- TP/SL monitoring confirmed running in production
- 100% of trades have mandatory TP/SL (no bypassing)
- bags.fm used as primary execution, Jupiter as fallback
- Partner fees being collected and tracked
- Comprehensive test coverage for integration

---

## Current State Assessment (âœ“ VERIFIED)

### Existing Implementation

**File**: `core/trading/bags_client.py` (876 lines)

**Components Found**:
1. **BagsAPIClient** (lines 77-559):
   - âœ“ API key + partner key configuration (lines 87-111)
   - âœ“ get_quote() method (lines 168-213)
   - âœ“ swap() method with partner fee (lines 215-310)
   - âœ“ get_token_info() (lines 312-351)
   - âœ“ Rate limiting (60 req/min) (lines 138-153)
   - âœ“ Success/failure tracking (lines 280, 300)

2. **BagsTradeRouter** (lines 562-686):
   - âœ“ Bags.fm primary, Jupiter fallback pattern (lines 600-646)
   - âœ“ Trade statistics tracking (lines 671-685)

3. **SuccessFeeManager** (lines 688-805):
   - âœ“ 0.5% fee on profitable trades (line 696)
   - âœ“ calculate_success_fee() (lines 703-746)
   - âœ“ collect_fee() (lines 748-795)

**File**: `core/treasury/bags_integration.py` (463 lines)

**Components Found**:
1. **TreasuryBagsIntegration** (lines 59-398):
   - âœ“ Automated fee collection scheduling (lines 261-296)
   - âœ“ Fee distribution: 50% staking, 30% ops, 20% dev (lines 22-26)
   - âœ“ Revenue analytics (lines 332-397)

**File**: `tg_bot/handlers/demo/demo_orders.py` (432 lines)

**TP/SL Components Found** (âœ“ VERIFIED lines 1-150):
1. **_check_demo_exit_triggers()** (lines 71-155):
   - âœ“ Take-profit checking (lines 116-122)
   - âœ“ Stop-loss checking (lines 124-130)
   - âœ“ Trailing stop updating (lines 132-150)

2. **Configuration**:
   - DEMO_EXIT_CHECKS env var (line 32)
   - DEMO_TPSL_AUTO_EXECUTE env var (line 37)
   - DEMO_EXIT_CHECK_INTERVAL_SECONDS env var (line 44)

**File**: `tg_bot/handlers/demo/demo_trading.py` (403 lines)

**Expected**: execute_buy_with_tpsl() function integrating bags.fm + TP/SL

**Environment Variables** (âœ“ VERIFIED in .env):
```bash
BAGS_API_KEY=REDACTED_BAGS_KEY
BAGS_PARTNER_KEY=REDACTED_BAGS_KEY
USE_BAGS_TRADING=true
BITQUERY_API_KEY=ory_at_mADUB8f4saK_4KhuiasXPRPWUJP4ifLzStiZLnd4-f4.Cvur9LsTET8ZxsXxnnj7qOO5TEhW_Q_NXQmRL7K9W20
```

---

## Gaps Analysis

### Critical Gaps (Blockers for V1)

1. **API Key Validation**: Unknown if keys are valid and working
   - **Impact**: Integration may be non-functional despite configuration
   - **Fix**: Live API test with real calls
   - **Risk**: HIGH if keys invalid/expired

2. **TP/SL Enforcement**: Unknown if TP/SL is truly mandatory
   - **Impact**: Users could execute trades without risk management
   - **Fix**: Code audit + enforcement at entry points
   - **Risk**: HIGH for user safety

3. **Integration Testing**: No evidence of E2E bags.fm â†’ TP/SL flow
   - **Impact**: Unknown if full flow works in production
   - **Fix**: Comprehensive integration tests
   - **Risk**: MEDIUM

### Medium Gaps (Quality)

4. **Monitoring Status**: Unknown if TP/SL background monitoring is running
   - **Impact**: TP/SL may be configured but not actively checked
   - **Fix**: Verify background job in supervisor
   - **Risk**: MEDIUM

5. **Fallback Testing**: Unknown if Jupiter fallback actually works
   - **Impact**: Trades could fail if bags.fm down and fallback broken
   - **Fix**: Simulate bags.fm failure, test Jupiter execution
   - **Risk**: MEDIUM

6. **Partner Fee Tracking**: Unknown if fees are actually being collected
   - **Impact**: Lost revenue if integration incomplete
   - **Fix**: Check partner stats, verify fee collection
   - **Risk**: LOW (revenue, not critical functionality)

### Low Gaps (Nice-to-Have)

7. **Error Messages**: May not be user-friendly for API failures
8. **Metrics/Logging**: bags.fm vs Jupiter ratio not tracked
9. **Documentation**: Integration flow not documented

---

## Tasks Breakdown

### Task 1: Verify bags.fm API Keys (30 min)

**Objective**: Confirm API keys are valid and working

**Actions**:
1. Read demo_trading.py execute_buy_with_tpsl implementation
2. Create test script: `scripts/test_bags_api.py`
3. Test quote fetching (read-only, no risk)
4. Test token info API
5. Check partner stats endpoint
6. Document API response format

**Test Script**:
```python
# scripts/test_bags_api.py
"""Test bags.fm API connectivity and key validity."""
import asyncio
from core.trading.bags_client import get_bags_client

async def test_bags_api():
    client = get_bags_client()

    # Test 1: Get SOL/USDC quote (read-only)
    print("Test 1: Get quote...")
    quote = await client.get_quote(
        from_token="So11111111111111111111111111111111111111112",  # SOL
        to_token="EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",  # USDC
        amount=0.1
    )
    if quote:
        print(f"âœ“ Quote: {quote.from_amount} SOL -> {quote.to_amount} USDC")
        print(f"  Price: {quote.price}")
        print(f"  Fee: {quote.fee}")
    else:
        print("âœ— Quote failed")

    # Test 2: Get token info
    print("\nTest 2: Get token info...")
    token = await client.get_token_info("So11111111111111111111111111111111111111112")
    if token:
        print(f"âœ“ Token: {token.symbol} ({token.name})")
        print(f"  Price: ${token.price_usd:.4f}")
    else:
        print("âœ— Token info failed")

    # Test 3: Get partner stats
    print("\nTest 3: Get partner stats...")
    stats = await client.get_partner_stats()
    if "error" not in stats:
        print(f"âœ“ Partner stats:")
        print(f"  Total volume: {stats.get('total_volume', 0):.2f} SOL")
        print(f"  Total fees earned: {stats.get('total_fees_earned', 0):.6f} SOL")
        print(f"  Pending fees: {stats.get('pending_fees', 0):.6f} SOL")
    else:
        print(f"âœ— Partner stats failed: {stats.get('error')}")

    # Test 4: Check client stats
    print("\nTest 4: Client stats...")
    client_stats = client.get_client_stats()
    print(f"  Success rate: {client_stats['success_rate']*100:.1f}%")
    print(f"  Requests in last minute: {client_stats['requests_in_last_minute']}")

    await client.close()

if __name__ == "__main__":
    asyncio.run(test_bags_api())
```

**Success Criteria**:
- All 4 tests pass
- No authentication errors
- Valid data returned

**Risk**: LOW (read-only operations)

---

### Task 2: Audit TP/SL Enforcement (3-4 hours)

**Objective**: Ensure TP/SL is mandatory on ALL trade entry points

**Entry Points to Audit**:

1. **demo_trading.py::execute_buy_with_tpsl()**
   - âœ“ Already has TP/SL in signature
   - Verify defaults are set (tp_percent=50.0, sl_percent=20.0)
   - Ensure no way to bypass

2. **Telegram handlers**:
   - `/demo` command flows
   - Button callbacks
   - Message handlers
   - Check for any direct trade execution

3. **API endpoints** (if exposed):
   - Check api/fastapi_app.py
   - Ensure all trade endpoints require TP/SL

4. **Treasury trading** (bots/treasury/trading.py):
   - Separate system, but should also have TP/SL
   - Document if treasury has different rules

**Code Pattern to Check**:
```python
# GOOD: TP/SL is required
async def execute_buy(
    token: str,
    amount: float,
    tp_percent: float,  # Required parameter
    sl_percent: float,  # Required parameter
):
    if tp_percent <= 0 or sl_percent <= 0:
        raise ValueError("TP/SL required")
    # ...

# BAD: TP/SL is optional
async def execute_buy(
    token: str,
    amount: float,
    tp_percent: Optional[float] = None,  # âŒ Optional
    sl_percent: Optional[float] = None,  # âŒ Optional
):
    # ...
```

**Enforcement Additions**:

Add to `demo_trading.py`:
```python
def _validate_tpsl_required(tp_percent: Optional[float], sl_percent: Optional[float]):
    """Ensure TP/SL are provided and valid."""
    if tp_percent is None or sl_percent is None:
        raise ValueError(
            "Take-profit and stop-loss are mandatory. "
            "Example: tp_percent=50.0 (50% profit target), sl_percent=20.0 (20% max loss)"
        )
    if tp_percent <= 0:
        raise ValueError(f"Take-profit must be positive, got {tp_percent}")
    if sl_percent <= 0:
        raise ValueError(f"Stop-loss must be positive, got {sl_percent}")
    if sl_percent >= 100:
        raise ValueError(f"Stop-loss cannot be >= 100%, got {sl_percent}")
    if tp_percent >= 500:  # Reasonable upper limit
        raise ValueError(f"Take-profit seems unrealistic: {tp_percent}%")

# Call at start of execute_buy_with_tpsl
async def execute_buy_with_tpsl(...):
    _validate_tpsl_required(tp_percent, sl_percent)
    # ... rest of implementation
```

**Success Criteria**:
- No code path allows trades without TP/SL
- Validation errors are clear and actionable
- 100% coverage at all entry points

**Risk**: MEDIUM (requires thorough audit)

---

### Task 3: Verify TP/SL Monitoring Active (2 hours)

**Objective**: Confirm background TP/SL monitoring is running in production

**Check Points**:

1. **Supervisor Integration** (bots/supervisor.py):
   - Search for TP/SL job registration
   - Verify it's not commented out
   - Check startup logs

2. **Background Job** (demo_orders.py):
   - Verify `_background_tp_sl_monitor` exists
   - Check interval configuration
   - Ensure it's actually called

3. **Telegram Bot** (tg_bot/bot.py or tg_bot/bot_core.py):
   - Check for job_queue.run_repeating
   - Verify exit check handler is registered
   - Test with real position

**Expected Pattern**:
```python
# In bot initialization
application.job_queue.run_repeating(
    _background_tp_sl_monitor,
    interval=30,  # Every 30 seconds
    first=10,     # Start after 10 seconds
    name="demo_tp_sl_monitor"
)
```

**Verification Test**:
```python
# scripts/test_tpsl_monitoring.py
"""Test TP/SL monitoring is active."""
import asyncio
from telegram.ext import Application
from tg_bot.bot import create_application

async def test_monitoring():
    app = create_application()

    # Check if TP/SL job is registered
    jobs = app.job_queue.jobs()
    tpsl_jobs = [j for j in jobs if "tp_sl" in j.name.lower()]

    if tpsl_jobs:
        print(f"âœ“ Found {len(tpsl_jobs)} TP/SL monitoring jobs")
        for job in tpsl_jobs:
            print(f"  - {job.name}: interval={job.interval}s")
    else:
        print("âœ— No TP/SL monitoring jobs found!")
        print("Available jobs:")
        for job in jobs:
            print(f"  - {job.name}")

    await app.shutdown()

if __name__ == "__main__":
    asyncio.run(test_monitoring())
```

**Success Criteria**:
- TP/SL monitoring job found in job queue
- Interval is reasonable (10-60 seconds)
- Job is active (not paused)

**Risk**: LOW (verification only)

---

### Task 4: Integration Testing (4-5 hours)

**Objective**: Test full bags.fm â†’ TP/SL flow end-to-end

**Test Scenarios**:

**Scenario 1: bags.fm Successful Trade with TP Hit**
```python
# tests/integration/test_bags_tpsl_flow.py
async def test_bags_buy_tp_trigger():
    """Test bags.fm buy + TP trigger flow."""
    # 1. Execute buy via bags.fm
    result = await execute_buy_with_tpsl(
        token_address="<test-token>",
        amount_sol=0.01,  # Small test amount
        wallet_address="<test-wallet>",
        tp_percent=10.0,  # 10% profit target
        sl_percent=5.0,   # 5% max loss
    )

    assert result["success"] == True
    assert result["via"] == "bags"  # Verify bags.fm was used

    # 2. Simulate price increase to TP level
    position = result["position"]
    position["current_price"] = position["entry_price"] * 1.11  # +11%

    # 3. Run exit check
    alerts = await _check_demo_exit_triggers(user_data, [position])

    # 4. Verify TP triggered
    assert len(alerts) == 1
    assert alerts[0]["type"] == "take_profit"
```

**Scenario 2: bags.fm Fails, Jupiter Fallback**
```python
async def test_bags_failure_jupiter_fallback():
    """Test Jupiter fallback when bags.fm fails."""
    # Mock bags.fm to fail
    with patch("core.trading.bags_client.BagsAPIClient.swap") as mock_swap:
        mock_swap.side_effect = Exception("Bags API down")

        result = await execute_buy_with_tpsl(
            token_address="<test-token>",
            amount_sol=0.01,
            wallet_address="<test-wallet>",
            tp_percent=50.0,
            sl_percent=20.0,
        )

        # Verify fallback worked
        assert result["success"] == True
        assert result["via"] == "jupiter"  # Fell back to Jupiter

        # Verify TP/SL still configured
        assert result["position"]["tp_percent"] == 50.0
        assert result["position"]["sl_percent"] == 20.0
```

**Scenario 3: SL Trigger + Auto-Exit**
```python
async def test_sl_trigger_auto_exit():
    """Test stop-loss trigger + automatic exit."""
    # 1. Create position
    position = {
        "address": "<token>",
        "entry_price": 1.0,
        "current_price": 0.79,  # -21% (below 20% SL)
        "sl_percent": 20.0,
        "amount_sol": 0.01,
    }

    # 2. Enable auto-exit
    context.user_data["ai_auto_trade"] = True

    # 3. Run exit check
    alerts = await _check_demo_exit_triggers(context, [position])

    # 4. Verify SL alert
    assert len(alerts) == 1
    assert alerts[0]["type"] == "stop_loss"

    # 5. Process exit (would auto-sell)
    # (Implementation depends on demo_orders.py _process_demo_exit_checks)
```

**Scenario 4: Trailing Stop**
```python
async def test_trailing_stop():
    """Test trailing stop updates and triggers."""
    position = {
        "id": "test-pos-1",
        "address": "<token>",
        "entry_price": 1.0,
        "current_price": 1.5,  # +50%
        "amount_sol": 0.01,
    }

    # Create trailing stop (10% trail)
    trailing_stop = {
        "position_id": "test-pos-1",
        "trail_percent": 10,
        "highest_price": 1.5,
        "current_stop_price": 1.35,  # 10% below highest
        "active": True,
    }

    user_data = {"trailing_stops": [trailing_stop]}

    # Price goes up - stop should update
    position["current_price"] = 1.8
    await _check_demo_exit_triggers(user_data, [position])
    assert trailing_stop["highest_price"] == 1.8
    assert trailing_stop["current_stop_price"] == 1.62  # 10% below 1.8

    # Price drops below stop - should trigger
    position["current_price"] = 1.6
    alerts = await _check_demo_exit_triggers(user_data, [position])
    assert len(alerts) == 1
    assert alerts[0]["type"] == "trailing_stop"
```

**Success Criteria**:
- All 4 scenarios pass
- bags.fm used when available
- Jupiter fallback works
- TP/SL triggers correctly
- Auto-exit executes (when enabled)

**Risk**: MEDIUM (integration complexity)

---

### Task 5: Add Metrics & Logging (2 hours)

**Objective**: Track bags.fm vs Jupiter usage and TP/SL trigger rates

**Metrics to Add**:

```python
# core/trading/bags_metrics.py
"""Metrics tracking for bags.fm integration."""
from dataclasses import dataclass
from datetime import datetime
from typing import Dict, Any

@dataclass
class BagsMetrics:
    """bags.fm usage metrics."""
    bags_trades: int = 0
    jupiter_trades: int = 0
    bags_failures: int = 0
    jupiter_failures: int = 0
    total_volume_sol: float = 0.0
    partner_fees_earned: float = 0.0

    tp_triggers: int = 0
    sl_triggers: int = 0
    trailing_triggers: int = 0

    def bags_success_rate(self) -> float:
        """Calculate bags.fm success rate."""
        total = self.bags_trades + self.bags_failures
        return self.bags_trades / total if total > 0 else 0.0

    def jupiter_success_rate(self) -> float:
        """Calculate Jupiter success rate."""
        total = self.jupiter_trades + self.jupiter_failures
        return self.jupiter_trades / total if total > 0 else 0.0

    def bags_usage_pct(self) -> float:
        """Percentage of trades via bags.fm."""
        total = self.bags_trades + self.jupiter_trades
        return (self.bags_trades / total * 100) if total > 0 else 0.0

    def to_dict(self) -> Dict[str, Any]:
        return {
            "bags_trades": self.bags_trades,
            "jupiter_trades": self.jupiter_trades,
            "bags_usage_pct": self.bags_usage_pct(),
            "bags_success_rate": self.bags_success_rate(),
            "jupiter_success_rate": self.jupiter_success_rate(),
            "total_volume_sol": self.total_volume_sol,
            "partner_fees_earned": self.partner_fees_earned,
            "tp_triggers": self.tp_triggers,
            "sl_triggers": self.sl_triggers,
            "trailing_triggers": self.trailing_triggers,
        }

# Singleton
_metrics = BagsMetrics()

def get_bags_metrics() -> BagsMetrics:
    return _metrics

def log_trade(via: str, success: bool, volume_sol: float = 0):
    """Log a trade execution."""
    if via == "bags":
        if success:
            _metrics.bags_trades += 1
            _metrics.total_volume_sol += volume_sol
        else:
            _metrics.bags_failures += 1
    elif via == "jupiter":
        if success:
            _metrics.jupiter_trades += 1
            _metrics.total_volume_sol += volume_sol
        else:
            _metrics.jupiter_failures += 1

def log_exit_trigger(trigger_type: str):
    """Log TP/SL/trailing trigger."""
    if trigger_type == "take_profit":
        _metrics.tp_triggers += 1
    elif trigger_type == "stop_loss":
        _metrics.sl_triggers += 1
    elif trigger_type == "trailing_stop":
        _metrics.trailing_triggers += 1
```

**Add to demo_trading.py**:
```python
from core.trading.bags_metrics import log_trade, log_exit_trigger

async def execute_buy_with_tpsl(...):
    # ... execute trade ...

    # Log trade execution
    log_trade(
        via=result.get("via", "unknown"),
        success=result["success"],
        volume_sol=amount_sol
    )

    return result
```

**Add to demo_orders.py**:
```python
from core.trading.bags_metrics import log_exit_trigger

async def _check_demo_exit_triggers(...):
    # ... check triggers ...

    for alert in alerts:
        log_exit_trigger(alert["type"])

    return alerts
```

**Add metrics endpoint** (api/fastapi_app.py):
```python
from core.trading.bags_metrics import get_bags_metrics

@app.get("/api/metrics/bags")
async def get_bags_trading_metrics():
    """Get bags.fm integration metrics."""
    return get_bags_metrics().to_dict()
```

**Success Criteria**:
- Metrics tracked on every trade
- API endpoint returns current stats
- Logs show bags vs Jupiter breakdown

**Risk**: LOW (non-critical feature)

---

### Task 6: Error Handling Enhancement (2 hours)

**Objective**: Improve error messages for bags.fm + TP/SL failures

**Error Scenarios**:

1. **bags.fm API Down**:
```python
# Before
"Swap failed: Connection error"

# After
"âš ï¸ bags.fm API temporarily unavailable. Retrying with Jupiter fallback..."
```

2. **Invalid API Key**:
```python
# Before
"HTTP 401 Unauthorized"

# After
"âŒ bags.fm API key invalid or expired. Check BAGS_API_KEY in settings. Trade cancelled for safety."
```

3. **TP/SL Not Provided**:
```python
# Before
"TypeError: 'NoneType' object..."

# After
"âŒ Take-profit and stop-loss are required for all trades.
Example: /demo buy SOL 0.1 tp:50 sl:20
(50% profit target, 20% max loss)"
```

4. **TP/SL Validation Failure**:
```python
# Before
"ValueError: Invalid TP"

# After
"âŒ Invalid take-profit: 500%
Reasonable range: 5-200%
Your entry: TP=500%, SL=20%
Suggestion: Try TP=50% for a 50% profit target"
```

**Implementation**:

Add to `demo_trading.py`:
```python
class TradingError(Exception):
    """Base for user-friendly trading errors."""
    def __init__(self, message: str, hint: str = None):
        self.message = message
        self.hint = hint
        super().__init__(message)

    def format_telegram(self) -> str:
        msg = f"âŒ {self.message}"
        if self.hint:
            msg += f"\n\nðŸ’¡ {self.hint}"
        return msg

class BagsAPIError(TradingError):
    """bags.fm API error."""
    pass

class TPSLValidationError(TradingError):
    """TP/SL validation error."""
    pass

# Use in execute_buy_with_tpsl
try:
    result = await bags_client.swap(...)
except httpx.HTTPError as e:
    if e.response.status_code == 401:
        raise BagsAPIError(
            "bags.fm API key invalid or expired",
            hint="Check BAGS_API_KEY configuration. Contact admin."
        )
    elif e.response.status_code >= 500:
        logger.warning(f"bags.fm server error, falling back to Jupiter: {e}")
        # Fall back to Jupiter
    else:
        raise BagsAPIError(
            f"bags.fm API error: {e}",
            hint="The trade could not be executed. Try again in a moment."
        )
```

**Success Criteria**:
- All error messages are user-actionable
- Hints guide users to fix issues
- Technical details logged (not shown to user)

**Risk**: LOW (UX improvement)

---

### Task 7: Documentation (1-2 hours)

**Objective**: Document bags.fm + TP/SL integration

**Create**: `docs/bags-integration.md`

```markdown
# bags.fm Integration

## Overview
Jarvis uses bags.fm as the primary trade execution platform with Jupiter as a fallback.

## Features
- **Partner Fee Collection**: 0.25% of trade volume (25% of 1% platform fee)
- **Automatic Fallback**: If bags.fm fails, trades execute via Jupiter
- **TP/SL Integration**: All trades include take-profit and stop-loss

## Architecture

```
User Trade Request
    â†“
execute_buy_with_tpsl()
    â†“
Try bags.fm (BagsTradeRouter)
    â”œâ”€ Success â†’ Record position with TP/SL
    â””â”€ Failure â†’ Fallback to Jupiter
            â†“
    Background Monitor (every 30s)
        â†“
    Check TP/SL triggers
        â”œâ”€ TP hit â†’ Alert + Auto-exit (if enabled)
        â”œâ”€ SL hit â†’ Alert + Auto-exit (if enabled)
        â””â”€ Trailing stop hit â†’ Alert + Auto-exit
```

## Configuration

### Required Environment Variables
```bash
BAGS_API_KEY=bags_prod_...          # bags.fm API key
BAGS_PARTNER_KEY=bags_prod_...      # Partner code for fee collection
USE_BAGS_TRADING=true               # Enable bags.fm (vs Jupiter-only)
```

### Optional Environment Variables
```bash
DEMO_EXIT_CHECKS=1                  # Enable TP/SL monitoring (default: 1)
DEMO_TPSL_AUTO_EXECUTE=1            # Auto-exit on TP/SL trigger (default: 1)
DEMO_EXIT_CHECK_INTERVAL_SECONDS=30 # Check interval (default: 30)
```

## Usage

### Execute Trade with TP/SL
```python
from tg_bot.handlers.demo.demo_trading import execute_buy_with_tpsl

result = await execute_buy_with_tpsl(
    token_address="...",
    amount_sol=0.1,
    wallet_address="...",
    tp_percent=50.0,  # 50% profit target
    sl_percent=20.0,  # 20% max loss
    slippage_bps=100  # 1% slippage
)

# result contains:
# {
#     "success": True,
#     "via": "bags",  # or "jupiter"
#     "tx_hash": "...",
#     "position": {
#         "entry_price": 1.0,
#         "tp_percent": 50.0,
#         "sl_percent": 20.0,
#         ...
#     }
# }
```

### Check TP/SL Triggers
```python
from tg_bot.handlers.demo.demo_orders import _check_demo_exit_triggers

alerts = await _check_demo_exit_triggers(context, positions)
for alert in alerts:
    if alert["type"] == "take_profit":
        print(f"TP hit for {alert['position']['symbol']}")
    elif alert["type"] == "stop_loss":
        print(f"SL hit for {alert['position']['symbol']}")
```

## Metrics

View metrics via API:
```bash
GET /api/metrics/bags
```

Response:
```json
{
    "bags_trades": 142,
    "jupiter_trades": 8,
    "bags_usage_pct": 94.7,
    "bags_success_rate": 0.99,
    "total_volume_sol": 45.3,
    "partner_fees_earned": 0.113,
    "tp_triggers": 67,
    "sl_triggers": 31,
    "trailing_triggers": 12
}
```

## Troubleshooting

### "bags.fm API temporarily unavailable"
- bags.fm may be experiencing downtime
- Trade automatically falls back to Jupiter
- No action needed

### "bags.fm API key invalid"
- Check BAGS_API_KEY in .env
- Verify key has not expired
- Contact bags.fm support if needed

### "TP/SL required"
- All trades must include TP and SL
- Add `tp_percent` and `sl_percent` to trade request
- Example: `tp:50 sl:20` (50% profit, 20% max loss)

## Partner Fee Distribution

| Allocation | Percentage |
|------------|------------|
| Staking Rewards | 50% |
| Operations | 30% |
| Development | 20% |

Fees are collected hourly and distributed automatically.
```

**Success Criteria**:
- Documentation covers all key aspects
- Examples are copy-pasteable
- Troubleshooting addresses common issues

**Risk**: NONE

---

## Phase Completion Checklist

- [ ] Task 1: bags.fm API keys verified working
- [ ] Task 2: TP/SL enforcement audited (100% coverage)
- [ ] Task 3: TP/SL monitoring confirmed active
- [ ] Task 4: Integration tests passing (4/4 scenarios)
- [ ] Task 5: Metrics tracking added
- [ ] Task 6: Error messages enhanced
- [ ] Task 7: Documentation complete

**Phase Exit Criteria**:
- bags.fm API keys valid and tested
- TP/SL mandatory on all entry points
- Background monitoring active
- Integration tests 100% pass rate
- Metrics endpoint operational
- Documentation published

---

## Risks & Mitigation

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| API keys invalid | Low | High | Test immediately (Task 1) |
| TP/SL not enforced | Medium | Critical | Comprehensive audit (Task 2) |
| Monitoring not running | Low | High | Verification test (Task 3) |
| bags.fm API unreliable | Medium | Medium | Jupiter fallback working |
| Integration broken | Low | High | E2E tests (Task 4) |

---

## Timeline Estimate

**Optimistic**: 1 week (40 hours)
**Realistic**: 1-2 weeks (48-64 hours)
**Pessimistic**: 2 weeks (80 hours) if major issues found

**Critical Path**: Task 1 â†’ Task 2 â†’ Task 3 (verification before enhancement)

---

## Dependencies

**Upstream (must complete first)**:
- None (independent phase)

**Downstream (blocks)**:
- Phase 8 (V1 Launch) - bags.fm must be verified for launch

**Parallel Compatible**:
- Phase 1 (Database Consolidation)
- Phase 2 (Demo Bot Fixes)
- Phase 3 (Vibe Command)
- Phase 5 (Solana Fixes)

---

## Success Metrics

**Functional**:
- 100% of trades have TP/SL configured
- bags.fm usage >80% (vs Jupiter fallback)
- TP/SL triggers <2s detection latency
- 0 trades executed without risk management

**Quality**:
- Integration test coverage >90%
- Partner fees collected and tracked
- Error messages user-actionable

**Performance**:
- bags.fm API response time <500ms (p95)
- TP/SL monitoring overhead <1% CPU
- No missed triggers in production

---

**Document Version**: 1.0
**Created**: 2026-01-24
**Author**: Claude Sonnet 4.5 (Ralph Wiggum Loop)
**Next Review**: After Task 3 completion
