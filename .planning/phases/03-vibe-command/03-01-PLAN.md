# Phase 3: Vibe Command Implementation

**Phase**: 3 of 8
**Timeline**: 3-5 days
**Priority**: P0 (Must-Have for V1)
**Status**: Planning
**Dependencies**: None (can run parallel with Phase 1-2)

---

## Objective

Complete and verify the `/vibe` command implementation to enable Telegram-based vibe coding with Claude CLI integration.

**Success Criteria:**
- `/vibe` command fully functional from Telegram
- Claude CLI integration working with console bridge
- Real-time streaming of Claude responses back to Telegram
- Error handling and timeout protection
- End-to-end testing with real coding tasks
- Documentation and examples

---

## Current State Assessment

### Existing Implementation (‚úì VERIFIED)

**File**: `tg_bot/bot_core.py` (lines 1970-2019)

**Handler Registration**: ‚úì EXISTS
```python
# Line 1971
async def vibe(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle /vibe command - quick vibe coding with Claude (admin only)."""
```

**Core Components Found**:
1. **Admin Authorization**: Uses `@admin_only` decorator (line 1970)
2. **Command Parsing**: Extracts request from message (line 1986)
3. **Claude CLI Handler**: Imports from `tg_bot/services/claude_cli_handler` (line 1983)
4. **Console Bridge**: Imports from `core/telegram_console_bridge` (line 1984)
5. **Response Streaming**: Sends chunks back to Telegram (lines 1997-2006)

**Implementation Pattern**:
```python
async def vibe(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # 1. Parse request
    vibe_request = " ".join(context.args)

    # 2. Get handlers
    cli_handler = get_claude_cli_handler()
    bridge = get_console_bridge()

    # 3. Execute via Claude CLI
    result = await cli_handler.execute_vibe_request(vibe_request)

    # 4. Stream response back
    for chunk in bridge.get_output_chunks():
        await update.message.reply_text(chunk)
```

### Dependencies to Verify

**File**: `tg_bot/services/claude_cli_handler.py`
- **Status**: ? UNCERTAIN (needs verification)
- **Expected**: ClaudeCliHandler class with execute_vibe_request method

**File**: `core/telegram_console_bridge.py`
- **Status**: ? UNCERTAIN (needs verification)
- **Expected**: ConsoleBridge class bridging Claude CLI output to Telegram

**Environment Variables**:
- `ANTHROPIC_CLI_OAUTH_TOKEN`: ‚úì VERIFIED in .env
- `ANTHROPIC_API_KEY`: ‚úì VERIFIED in .env
- `CLAUDE_CLI_ENABLED`: Set to 0 (needs investigation - should be 1?)

---

## Gaps Analysis

### Critical Gaps (Blockers)

1. **CLAUDE_CLI_ENABLED=0**: Currently disabled in .env
   - **Impact**: Vibe command may be non-functional
   - **Fix**: Change to 1 after verification

2. **Integration Layer Completeness**: Unknown status of:
   - `claude_cli_handler.py` - CLI execution wrapper
   - `telegram_console_bridge.py` - Output bridging
   - **Impact**: Cannot assess without file reads

3. **Error Handling**: Incomplete coverage for:
   - Claude CLI timeouts (>60s tasks)
   - API rate limits
   - Network failures mid-execution
   - **Impact**: Poor UX, potential crashes

### Medium Gaps (Quality)

4. **Response Chunking**: Current implementation may have issues:
   - Large outputs (>4096 chars) need splitting
   - Code blocks may be truncated mid-syntax
   - **Impact**: Broken formatting in Telegram

5. **Concurrency**: No evidence of:
   - Multiple users using /vibe simultaneously
   - Request queuing or locking
   - **Impact**: Race conditions possible

6. **Logging/Monitoring**: Unclear if vibe requests are:
   - Logged for debugging
   - Tracked for usage metrics
   - **Impact**: Difficult to debug production issues

### Low Gaps (Nice-to-Have)

7. **Progress Indicators**: No "thinking..." or streaming dots
8. **Cancel Command**: Cannot abort long-running vibe requests
9. **Context Persistence**: Each /vibe is stateless (no memory)

---

## Tasks Breakdown

### Task 1: Verify Core Integration Files (1 hour)

**Objective**: Confirm claude_cli_handler and telegram_console_bridge exist and are functional

**Actions**:
1. Read `tg_bot/services/claude_cli_handler.py`
2. Read `core/telegram_console_bridge.py`
3. Check for `execute_vibe_request()` method
4. Check for `get_output_chunks()` streaming
5. Document findings in verification report

**Success Criteria**:
- Both files exist with expected methods
- Code review shows no obvious bugs
- Dependencies (claude CLI) are importable

**Risk**: HIGH if files missing or incomplete

---

### Task 2: Enable Claude CLI Integration (30 min)

**Objective**: Set CLAUDE_CLI_ENABLED=1 and verify Claude CLI accessible

**Actions**:
1. Read current .env CLAUDE_CLI_ENABLED value
2. If 0, investigate why disabled (check git history/comments)
3. Test Claude CLI availability: `which claude` or `claude --version`
4. Set CLAUDE_CLI_ENABLED=1 in .env
5. Verify ANTHROPIC_CLI_OAUTH_TOKEN valid

**Success Criteria**:
- CLAUDE_CLI_ENABLED=1
- Claude CLI responds to version check
- OAuth token authenticated

**Risk**: MEDIUM if Claude CLI not installed or token expired

---

### Task 3: Add Robust Error Handling (3-4 hours)

**Objective**: Handle all failure modes gracefully

**Changes to `tg_bot/bot_core.py::vibe()`**:

```python
async def vibe(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Enhanced vibe with comprehensive error handling."""
    try:
        # 1. Validate request
        if not context.args:
            await update.message.reply_text(
                "‚ùå Usage: /vibe <your request>\n"
                "Example: /vibe add error handling to sentiment.py"
            )
            return

        vibe_request = " ".join(context.args)

        # 2. Send acknowledgement
        status_msg = await update.message.reply_text(
            "ü§ñ Processing your vibe request...\n"
            "‚è≥ This may take 30-120 seconds."
        )

        # 3. Execute with timeout
        cli_handler = get_claude_cli_handler()

        try:
            result = await asyncio.wait_for(
                cli_handler.execute_vibe_request(vibe_request),
                timeout=300.0  # 5 min max
            )
        except asyncio.TimeoutError:
            await status_msg.edit_text(
                "‚è±Ô∏è Request timed out after 5 minutes.\n"
                "Try breaking into smaller tasks."
            )
            return
        except ClaudeAPIError as e:
            await status_msg.edit_text(
                f"‚ùå Claude API error: {e}\n"
                "Check API key and rate limits."
            )
            logger.error(f"Vibe API error: {e}", exc_info=True)
            return
        except Exception as e:
            await status_msg.edit_text(
                f"‚ùå Unexpected error: {type(e).__name__}\n"
                "Check logs for details."
            )
            logger.error(f"Vibe execution error: {e}", exc_info=True)
            return

        # 4. Stream response with chunking
        bridge = get_console_bridge()
        chunks = list(bridge.get_output_chunks(max_size=3800))  # Leave margin

        if not chunks:
            await status_msg.edit_text("‚úÖ Task complete (no output)")
            return

        # Delete status, send first chunk
        await status_msg.delete()

        for i, chunk in enumerate(chunks):
            prefix = f"üìù Part {i+1}/{len(chunks)}\n\n" if len(chunks) > 1 else ""
            await update.message.reply_text(prefix + chunk)
            await asyncio.sleep(0.5)  # Rate limit protection

        # 5. Log usage
        logger.info(f"Vibe request completed: {vibe_request[:50]}... ({len(chunks)} chunks)")

    except Exception as e:
        # Catchall for handler-level errors
        logger.error(f"Vibe handler error: {e}", exc_info=True)
        await update.message.reply_text(
            "‚ùå Critical error in vibe handler.\n"
            "This has been logged for investigation."
        )
```

**New Error Classes** (add to `core/exceptions.py` if needed):
```python
class ClaudeAPIError(Exception):
    """Raised when Claude CLI/API fails."""
    pass

class VibeBridgeError(Exception):
    """Raised when console bridge fails."""
    pass
```

**Success Criteria**:
- All error paths tested
- User-friendly error messages
- Comprehensive logging
- No unhandled exceptions

**Risk**: LOW (straightforward implementation)

---

### Task 4: Implement Response Chunking (2 hours)

**Objective**: Handle large outputs (>4096 chars) without breaking code formatting

**Add to `core/telegram_console_bridge.py`**:

```python
def get_output_chunks(self, max_size: int = 3800) -> List[str]:
    """Split output into Telegram-safe chunks.

    Args:
        max_size: Max chunk size (default 3800, leaving margin under 4096 limit)

    Returns:
        List of chunks with preserved code block formatting
    """
    output = self.get_full_output()

    if len(output) <= max_size:
        return [output]

    chunks = []
    current_chunk = ""
    in_code_block = False
    code_block_lang = ""

    for line in output.split('\n'):
        # Detect code block boundaries
        if line.strip().startswith('```'):
            if not in_code_block:
                # Opening code block
                in_code_block = True
                code_block_lang = line.strip()[3:]  # Extract language
            else:
                # Closing code block
                in_code_block = False

        # Check if adding this line would exceed limit
        if len(current_chunk) + len(line) + 1 > max_size:
            # Close code block if open
            if in_code_block:
                current_chunk += "\n```"
            chunks.append(current_chunk)

            # Start new chunk
            current_chunk = ""

            # Reopen code block if we were in one
            if in_code_block:
                current_chunk = f"```{code_block_lang}\n"

        current_chunk += line + "\n"

    # Add final chunk
    if current_chunk.strip():
        if in_code_block:
            current_chunk += "\n```"
        chunks.append(current_chunk)

    return chunks
```

**Test Cases**:
1. Small output (<3800 chars) ‚Üí 1 chunk
2. Large output (10,000 chars) ‚Üí multiple chunks
3. Output with code blocks ‚Üí preserved across chunks
4. Output with long lines ‚Üí truncated gracefully

**Success Criteria**:
- No Telegram "message too long" errors
- Code blocks never broken mid-syntax
- All chunks valid markdown

**Risk**: LOW (well-defined problem)

---

### Task 5: Add Concurrency Protection (2 hours)

**Objective**: Prevent race conditions when multiple users use /vibe

**Add to `tg_bot/services/claude_cli_handler.py`**:

```python
import asyncio
from collections import defaultdict

class ClaudeCliHandler:
    def __init__(self):
        self._user_locks = defaultdict(asyncio.Lock)
        self._active_requests = {}

    async def execute_vibe_request(
        self,
        request: str,
        user_id: int
    ) -> Dict[str, Any]:
        """Execute vibe request with per-user locking."""

        # Check if user already has active request
        async with self._user_locks[user_id]:
            if user_id in self._active_requests:
                raise VibeConcurrencyError(
                    "You already have a vibe request running. "
                    "Please wait for it to complete."
                )

            # Mark as active
            self._active_requests[user_id] = {
                'request': request,
                'started_at': time.time()
            }

        try:
            # Execute actual request
            result = await self._execute_claude_cli(request)
            return result
        finally:
            # Always clean up
            async with self._user_locks[user_id]:
                del self._active_requests[user_id]
```

**Update vibe handler** to pass user_id:
```python
result = await cli_handler.execute_vibe_request(
    vibe_request,
    user_id=update.effective_user.id
)
```

**Success Criteria**:
- User A and User B can run /vibe simultaneously
- User A cannot run 2 /vibe requests at once
- Lock automatically released on error/timeout

**Risk**: LOW (standard async pattern)

---

### Task 6: Add Progress Indicators (1 hour)

**Objective**: Show user that request is processing (UX improvement)

**Implementation**:

```python
async def vibe(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # ... (validation) ...

    # Animated progress message
    status_msg = await update.message.reply_text("ü§ñ Processing")

    async def update_progress():
        """Animate status message while processing."""
        animations = ["ü§ñ Processing", "ü§ñ Processing.", "ü§ñ Processing..", "ü§ñ Processing..."]
        i = 0
        while True:
            await asyncio.sleep(2)
            i = (i + 1) % len(animations)
            try:
                await status_msg.edit_text(animations[i])
            except:
                break  # Message deleted or error

    # Start animation task
    progress_task = asyncio.create_task(update_progress())

    try:
        result = await cli_handler.execute_vibe_request(...)
        # ... (handle result) ...
    finally:
        progress_task.cancel()
        await status_msg.delete()
```

**Success Criteria**:
- Progress indicator updates every 2 seconds
- Stops when request completes
- No errors if user deletes message

**Risk**: LOW (UX enhancement only)

---

### Task 7: Add Usage Logging (1 hour)

**Objective**: Track vibe usage for debugging and analytics

**Add to `core/db/` (or use existing LLM costs DB)**:

```sql
-- Add to jarvis_analytics.db (from Phase 1)
CREATE TABLE IF NOT EXISTS vibe_requests (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    request TEXT NOT NULL,
    started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,
    status TEXT CHECK(status IN ('success', 'error', 'timeout')),
    error_message TEXT,
    output_chars INTEGER,
    chunks_sent INTEGER,
    claude_api_tokens INTEGER,
    FOREIGN KEY (user_id) REFERENCES users(telegram_id)
);

CREATE INDEX idx_vibe_requests_user ON vibe_requests(user_id);
CREATE INDEX idx_vibe_requests_status ON vibe_requests(status);
```

**Logging Code**:
```python
async def log_vibe_request(
    user_id: int,
    request: str,
    status: str,
    output_chars: int = 0,
    chunks_sent: int = 0,
    error_message: str = None
):
    """Log vibe request to analytics DB."""
    async with get_db_connection("analytics") as conn:
        await conn.execute(
            """
            INSERT INTO vibe_requests
            (user_id, request, status, output_chars, chunks_sent, error_message, completed_at)
            VALUES (?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
            """,
            (user_id, request, status, output_chars, chunks_sent, error_message)
        )
```

**Success Criteria**:
- All requests logged (success + error)
- Can query usage by user
- Can identify common error patterns

**Risk**: LOW (DB operations)

---

### Task 8: End-to-End Testing (3-4 hours)

**Objective**: Verify vibe command works for real coding tasks

**Test Scenarios**:

1. **Simple Code Change**:
   ```
   /vibe add a docstring to core/trading/bags_client.py BagsAPIClient class
   ```
   - Expected: Docstring added, code unchanged otherwise

2. **Multi-File Refactor**:
   ```
   /vibe extract the sentiment logic from demo_sentiment.py into a new sentiment_analyzer.py
   ```
   - Expected: New file created, imports updated

3. **Bug Fix**:
   ```
   /vibe fix the TypeError in tg_bot/handlers/demo/demo_orders.py line 142
   ```
   - Expected: Bug identified and fixed with explanation

4. **Error Handling**:
   ```
   /vibe (with no arguments)
   ```
   - Expected: Usage message shown

5. **Timeout Test**:
   ```
   /vibe refactor the entire codebase to use async/await everywhere
   ```
   - Expected: Timeout message after 5 min (or completion if fast)

6. **Large Output**:
   ```
   /vibe write a comprehensive test suite for demo_trading.py
   ```
   - Expected: Multiple chunks sent, code blocks preserved

7. **Concurrent Requests** (2 users):
   - User A: `/vibe <task 1>`
   - User B: `/vibe <task 2>` (simultaneously)
   - Expected: Both complete successfully
   - User A: `/vibe <task 3>` (while task 1 running)
   - Expected: Error "already running"

**Test Process**:
1. Deploy to test Telegram bot
2. Run all scenarios manually
3. Check logs for errors
4. Verify DB entries created
5. Document any issues found

**Success Criteria**:
- 100% of test scenarios pass
- No unhandled exceptions in logs
- Response time <2 min for simple tasks

**Risk**: MEDIUM (integration testing always reveals edge cases)

---

### Task 9: Documentation (1 hour)

**Objective**: Document vibe command usage and troubleshooting

**Create**: `docs/vibe-command.md`

```markdown
# Vibe Command Usage

## Overview
The `/vibe` command enables quick AI-powered coding tasks directly from Telegram.

## Usage
```
/vibe <your coding request>
```

## Examples

### Add Documentation
```
/vibe add docstrings to all public methods in core/trading/bags_client.py
```

### Fix Bugs
```
/vibe fix the AttributeError in demo_orders.py line 142
```

### Refactor Code
```
/vibe extract the database logic from demo_sentiment.py into a new db module
```

### Add Tests
```
/vibe write unit tests for the execute_buy_with_tpsl function
```

## Limitations
- 5 minute timeout per request
- One active request per user
- Admin-only (requires TELEGRAM_ADMIN_IDS)
- Requires Claude CLI installed and configured

## Troubleshooting

### "Request timed out"
- Break task into smaller sub-tasks
- Check that Claude CLI is responsive

### "You already have a vibe request running"
- Wait for current request to complete
- Restart bot if stuck

### "Claude API error"
- Check ANTHROPIC_CLI_OAUTH_TOKEN validity
- Check API rate limits at https://console.anthropic.com

## Architecture
- Handler: `tg_bot/bot_core.py::vibe()`
- CLI Integration: `tg_bot/services/claude_cli_handler.py`
- Console Bridge: `core/telegram_console_bridge.py`
- Logging: `jarvis_analytics.db::vibe_requests`
```

**Success Criteria**:
- Documentation covers all usage patterns
- Troubleshooting section has solutions
- Examples are copy-pasteable

**Risk**: NONE

---

## Phase Completion Checklist

- [ ] Task 1: Core integration files verified (claude_cli_handler, console_bridge)
- [ ] Task 2: CLAUDE_CLI_ENABLED=1 set and tested
- [ ] Task 3: Robust error handling added
- [ ] Task 4: Response chunking implemented
- [ ] Task 5: Concurrency protection added
- [ ] Task 6: Progress indicators working
- [ ] Task 7: Usage logging to DB
- [ ] Task 8: All E2E test scenarios pass
- [ ] Task 9: Documentation complete

**Phase Exit Criteria**:
- `/vibe` command functional for all admin users
- Error handling prevents crashes
- Concurrent usage supported
- Large outputs handled gracefully
- All tests passing
- Documentation complete

---

## Risks & Mitigation

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Claude CLI not installed | Low | High | Add installation check to startup |
| OAuth token expired | Medium | High | Add token refresh mechanism |
| Large outputs break Telegram | Medium | Medium | Chunking implementation (Task 4) |
| Concurrent requests corrupt state | Low | High | Per-user locking (Task 5) |
| Timeout on complex tasks | High | Low | Clear timeout messaging, user guidance |

---

## Timeline Estimate

**Optimistic**: 2 days (16 hours)
**Realistic**: 3-4 days (24-32 hours)
**Pessimistic**: 5 days (40 hours) if Claude CLI integration incomplete

**Critical Path**: Tasks 1-2 (verification + enablement) must complete before testing

---

## Dependencies

**Upstream (must complete first)**:
- None (independent phase)

**Downstream (blocks)**:
- None (independent phase)

**Parallel Compatible**:
- Phase 1 (Database Consolidation)
- Phase 2 (Demo Bot Fixes)
- Phase 4 (bags.fm + TP/SL verification)

---

## Success Metrics

**Functional**:
- 100% test scenario pass rate
- <2 min average response time for simple tasks
- 0 unhandled exceptions in production

**Quality**:
- Error messages are user-actionable
- Logs capture all necessary debug info
- Code coverage >80% for new code

**UX**:
- Users understand command without docs
- Progress feedback prevents "is it working?" questions
- Timeout guidance helps users break down tasks

---

**Document Version**: 1.0
**Created**: 2026-01-24
**Author**: Claude Sonnet 4.5 (Ralph Wiggum Loop)
**Next Review**: After Task 2 completion
