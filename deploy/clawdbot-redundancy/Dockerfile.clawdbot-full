# ClawdBot Golden Image v2026.2.4
# Complete multi-agent infrastructure with shared memory
# Base: node:22-slim
#
# Agents supported:
# - Friday (CMO): Claude Opus 4 - Port 18789
# - Matt (COO): Claude Sonnet 4.5 - Port 18800
# - Jarvis (CTO): Grok 4.1 - Port 18801
# - Yoda (CIO): Kimi 2.5 - Port 18792 (Hetzner)
# - Squishy (CRO): Gemini 3 - Port 18793 (Mac/Tailscale)
#
# Key features:
# - Tailscale mesh networking for cross-node communication
# - Supermemory shared memory (clawdbot_shared tag)
# - All essential tools pre-installed (no apt-get on restart)
# - MSW Protocol support (NotebookLM integration)
# - Multi-provider AI (Anthropic, XAI, NVIDIA, Google)

FROM node:22-slim

# Set environment
ENV DEBIAN_FRONTEND=noninteractive
ENV DOCKER_API_VERSION=1.44
ENV TAILSCALE_STATE_DIR=/root/.clawdbot/tailscale

# Install comprehensive package set
RUN apt-get update -qq && \
    apt-get install -y -qq --no-install-recommends \
    # Essential networking & transfer
    openssh-client \
    curl \
    wget \
    rsync \
    ca-certificates \
    # Version control
    git \
    # JSON processing
    jq \
    # Process management
    procps \
    cron \
    # Network/firewall (required for Tailscale)
    iptables \
    # Editors
    nano \
    vim \
    # Monitoring & utilities
    htop \
    tree \
    less \
    # Session persistence
    tmux \
    # Python for scripting
    python3 \
    python3-pip \
    # Media processing
    ffmpeg \
    # Docker CLI for peer-to-peer healing
    docker.io \
    && \
    # Install Tailscale
    curl -fsSL https://tailscale.com/install.sh | sh && \
    # Install clawdbot (the actual package name)
    npm install -g clawdbot@latest && \
    # =========================================================================
    # AI Provider SDKs - Multi-provider support
    # =========================================================================
    # Google AI SDK for Gemini (Squishy)
    npm install -g @google/generative-ai@latest && \
    # Install UI-TARS-desktop (native GUI agent for computer control)
    npm install -g @agent-tars/cli@latest && \
    # Install BrowserOS CLI tools (MCP server + automation)
    npm install -g @browseros/cli@latest 2>/dev/null || \
    npm install -g @browseros/mcp-server@latest 2>/dev/null || \
    echo "BrowserOS: Desktop app available at https://browseros.ai/download" && \
    # =========================================================================
    # MCP Servers - Model Context Protocol for enhanced capabilities
    # =========================================================================
    npm install -g @modelcontextprotocol/server-filesystem@latest && \
    npm install -g @modelcontextprotocol/server-memory@latest && \
    npm install -g @modelcontextprotocol/server-github@latest && \
    npm install -g @modelcontextprotocol/server-brave-search@latest && \
    npm install -g @modelcontextprotocol/server-postgres@latest && \
    npm install -g @modelcontextprotocol/server-sequential-thinking@latest && \
    npm install -g @anthropics/claude-code-mcp-server@latest 2>/dev/null || true && \
    # Cleanup to reduce image size
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Create required directories (Tailscale state in persistent path)
RUN mkdir -p /root/.clawdbot/tailscale \
             /root/.clawdbot/telegram-sessions \
             /root/.clawdbot/cron \
             /root/clawd \
             /root/.ssh \
             /root/scripts \
             /var/run/tailscale

# Copy startup scripts and config templates
COPY tailscale-start.sh /root/scripts/tailscale-start.sh
COPY entrypoint.sh /root/scripts/entrypoint.sh
COPY scripts/peer-health-monitor.sh /root/scripts/peer-health-monitor.sh
COPY scripts/solana-wallet-init.sh /root/scripts/solana-wallet-init.sh
COPY mcp-servers-template.json /root/.clawdbot/mcp-servers-template.json
COPY auth-profiles-template.json /root/.clawdbot/auth-profiles-template.json
COPY openclaw-config-template.json /root/.clawdbot/openclaw-config-template.json
RUN chmod +x /root/scripts/*.sh

# Pre-install Solana CLI for trading capabilities
RUN sh -c "$(curl -sSfL https://release.solana.com/stable/install)" 2>/dev/null && \
    echo 'export PATH="/root/.local/share/solana/install/active_release/bin:$PATH"' >> /root/.bashrc

# Set up peer health monitoring cron job (runs every 2 minutes)
RUN echo "*/2 * * * * /root/scripts/peer-health-monitor.sh >> /var/log/peer-monitor.log 2>&1" > /etc/cron.d/peer-monitor && \
    chmod 0644 /etc/cron.d/peer-monitor && \
    crontab /etc/cron.d/peer-monitor

# Docker-native health check (pings gateway canvas endpoint)
# Retries every 30s, 3 failures = unhealthy, 60s startup grace
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:${GATEWAY_PORT:-18789}/__clawdbot__/canvas/ || exit 1

# Default command (can be overridden in docker run)
CMD ["/root/scripts/entrypoint.sh"]
