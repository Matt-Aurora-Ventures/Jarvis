# ClawdBot Docker Compose Configuration
# Complete setup with Tailscale support and volume persistence
#
# Usage:
#   docker compose -f docker-compose.clawdbots.yml up -d
#   docker compose -f docker-compose.clawdbots.yml logs -f friday
#
# Prerequisites:
#   - Build clawdbot-ready:latest image first
#   - Set TAILSCALE_AUTHKEY in environment (optional)
#   - Create config directories with clawdbot.json and auth-profiles.json

x-clawdbot-common: &clawdbot-common
  image: clawdbot-golden:2026.2.4
  restart: always
  cap_add:
    - NET_ADMIN
    - NET_RAW
  devices:
    - /dev/net/tun:/dev/net/tun
  environment:
    - TAILSCALE_STATE_DIR=/root/.clawdbot/tailscale
    - NODE_OPTIONS=--max-old-space-size=1536
    - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
    - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
    - NVIDIA_NIM_API_KEY=${NVIDIA_NIM_API_KEY:-}
    # Shared memory bus (Redis)
    - REDIS_HOST=jarvis-redis
    - REDIS_PORT=6379
    # Supermemory plugin for OpenClaw (long-term memory)
    - SUPERMEMORY_OPENCLAW_API_KEY=${SUPERMEMORY_API_KEY:-}
  deploy:
    resources:
      limits:
        memory: 2G
      reservations:
        memory: 512M
  # Enable peer-to-peer healing via docker socket
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock

services:
  redis:
    image: redis:7-alpine
    container_name: jarvis-redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - /root/clawd/infra/redis:/data

  friday:
    <<: *clawdbot-common
    container_name: clawdbot-friday
    hostname: clawdbot-friday
    ports:
      - "18789:18789"
    environment:
      - BOT_NAME=friday
      - PROFILE=friday
      - GATEWAY_PORT=18789
      - DOCKER_API_VERSION=1.44
      - REDIS_HOST=jarvis-redis
      - REDIS_PORT=6379
      # Friday: Claude Opus 4
      - AI_PROVIDER=anthropic
      - AI_MODEL=claude-opus-4-20250514
      - ANTHROPIC_OAUTH_ACCESS=${ANTHROPIC_OAUTH_ACCESS:-}
      - ANTHROPIC_OAUTH_REFRESH=${ANTHROPIC_OAUTH_REFRESH:-}
      # Infrastructure
      - TAILSCALE_AUTHKEY=${TAILSCALE_AUTHKEY:-}
      - NVIDIA_NIM_API_KEY=${NVIDIA_NIM_API_KEY:-}
    volumes:
      # Config (read-write for Tailscale state persistence)
      - /root/.clawdbot:/root/.clawdbot
      # CRITICAL: Workspace persistence (prevents state loss on restart)
      - /root/clawd/workspaces/friday:/root/clawd
      # Memory and skills
      - /root/clawd/data/friday/memory:/root/.clawdbot/memory
      - /root/clawd/data/friday/skills:/root/.clawdbot/skills
      # SSH keys
      - /root/.ssh:/root/.ssh:ro
      # Shared memory database
      - /root/clawdbots/data:/root/clawdbots/data
      # Docker socket for peer healing
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18789/__clawdbot__/canvas/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  matt:
    <<: *clawdbot-common
    container_name: clawdbot-matt
    hostname: clawdbot-matt
    ports:
      - "18800:18800"
    environment:
      - BOT_NAME=matt
      - PROFILE=matt
      - GATEWAY_PORT=18800
      - DOCKER_API_VERSION=1.44
      - REDIS_HOST=jarvis-redis
      - REDIS_PORT=6379
      # Matt: Claude Sonnet 4.5
      - AI_PROVIDER=anthropic
      - AI_MODEL=claude-sonnet-4-20250514
      - ANTHROPIC_OAUTH_ACCESS=${ANTHROPIC_OAUTH_ACCESS:-}
      - ANTHROPIC_OAUTH_REFRESH=${ANTHROPIC_OAUTH_REFRESH:-}
      # Infrastructure
      - TAILSCALE_AUTHKEY=${TAILSCALE_AUTHKEY:-}
      - NVIDIA_NIM_API_KEY=${NVIDIA_NIM_API_KEY:-}
    volumes:
      # Config (read-write for Tailscale state persistence)
      - /docker/clawdbot-gateway/config-matt:/root/.clawdbot
      # CRITICAL: Workspace persistence (prevents state loss on restart)
      - /root/clawd/workspaces/matt:/root/clawd
      # Memory and skills
      - /root/clawd/data/matt/memory:/root/.clawdbot/memory
      - /root/clawd/data/matt/skills:/root/.clawdbot/skills
      # SSH keys
      - /root/.ssh:/root/.ssh:ro
      # Shared memory database
      - /root/clawdbots/data:/root/clawdbots/data
      # Docker socket for peer healing
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18800/__clawdbot__/canvas/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  jarvis:
    <<: *clawdbot-common
    container_name: clawdbot-jarvis
    hostname: clawdbot-jarvis
    ports:
      - "18801:18801"
    environment:
      - BOT_NAME=jarvis
      - PROFILE=jarvis
      - GATEWAY_PORT=18801
      - DOCKER_API_VERSION=1.44
      - REDIS_HOST=jarvis-redis
      - REDIS_PORT=6379
      # Jarvis: Grok 4.1 (xai/grok-beta)
      - AI_PROVIDER=xai
      - AI_MODEL=grok-beta
      - XAI_API_KEY=${XAI_API_KEY:-}
      # Fallback AI provider (resilient chain)
      - ANTHROPIC_OAUTH_ACCESS=${ANTHROPIC_OAUTH_ACCESS:-}
      - ANTHROPIC_OAUTH_REFRESH=${ANTHROPIC_OAUTH_REFRESH:-}
      # Infrastructure
      - TAILSCALE_AUTHKEY=${TAILSCALE_AUTHKEY:-}
      - NVIDIA_NIM_API_KEY=${NVIDIA_NIM_API_KEY:-}
    volumes:
      # Config (read-write for Tailscale state persistence)
      - /root/.clawdbot-jarvis:/root/.clawdbot
      # CRITICAL: Workspace persistence (prevents state loss on restart)
      - /root/clawd/workspaces/jarvis:/root/clawd
      # Memory and skills
      - /root/clawd/data/jarvis/memory:/root/.clawdbot/memory
      - /root/clawd/data/jarvis/skills:/root/.clawdbot/skills
      # SSH keys
      - /root/.ssh:/root/.ssh:ro
      # Shared memory database
      - /root/clawdbots/data:/root/clawdbots/data
      # Docker socket for peer healing
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18801/__clawdbot__/canvas/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Health API (external monitoring endpoint)
  health-api:
    # Avoid runtime package installs (apk DNS failures cause restart flapping).
    # netshoot ships with curl+jq+socat+bash already.
    image: nicolaka/netshoot:latest
    container_name: clawdbot-health-api
    restart: always
    ports:
      - "18888:18888"
    volumes:
      - /root/clawd/infra:/infra:ro
      - /var/run/docker.sock:/var/run/docker.sock
    command: >
      sh -lc "socat TCP-LISTEN:18888,reuseaddr,fork EXEC:/infra/health-api-handler.sh"
    depends_on:
      - friday
      - matt
      - jarvis

# No separate tailscale volumes needed - state persists in /root/.clawdbot/tailscale/

# =============================================================================
# DISTRIBUTED ARCHITECTURE NOTES
# =============================================================================
# This compose file runs on VPS (KVM8 or Hetzner)
#
# Additional bots on other nodes (via Tailscale mesh):
#   - Yoda (CIO): Hetzner Helsinki - 100.101.157.14 - Port 18792 - Kimi 2.5
#   - Squishy (CRO): Mac - via Tailscale - Port 18793 - Gemini 3
#
# All bots share memory via:
#   - clawdbot_shared (Supermemory tag - cross-node)
#   - /root/clawdbots/data/supermemory.db (local fallback)
# =============================================================================
