name: Canonical Surface Guard

on:
  pull_request:
    branches: [main, develop]

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect non-canonical surface changes
        id: changed
        uses: tj-actions/changed-files@v45
        with:
          files: |
            jarvis-web-terminal/**
            web/templates/trading.html
            web_demo/**
            web/trading_web.py
            start_trading_ui.ps1

      - name: Require override label for non-canonical changes
        if: steps.changed.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const changed = `${{ steps.changed.outputs.all_changed_files }}`.split(/\s+/).filter(Boolean);
            const labels = (context.payload.pull_request?.labels || []).map((l) => String(l.name || ''));
            const required = 'allow-non-canonical-surface-change';
            if (!labels.includes(required)) {
              core.setFailed(
                [
                  'Non-canonical surfaces changed without required override label.',
                  `Required label: ${required}`,
                  `Changed files: ${changed.join(', ')}`,
                ].join('\n'),
              );
            }
