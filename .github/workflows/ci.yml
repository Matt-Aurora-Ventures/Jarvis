name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  python-validation:
    name: Python Validation Matrix
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio torch pandas optuna web3 solders anchorpy pyarrow
      - name: Run Python validation matrix
        run: |
          export PYTHONPATH="."
          pytest core/open_claw/tests/ \
                 core/backtest/data_ingestion/tests/ \
                 bots/tradfi_sniper/tests/ \
                 core/intel/tests/ \
                 tests/backtesting/ \
                 -q

  web-validation:
    name: Web Validation Matrix
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: jarvis-sniper
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install --no-audit --no-fund
          fi
      - name: Lint
        run: npm run lint

      - name: Test (phase core suites)
        run: |
          npm run test -- \
            src/lib/__tests__/cache-provider.test.ts \
            src/lib/__tests__/rate-limit-provider.test.ts \
            src/lib/__tests__/server-cache.test.ts \
            src/stores/__tests__/useSniperStore.test.ts \
            src/app/api/health/__tests__/route.test.ts \
            src/hooks/__tests__/useBacktest-transport.test.ts \
            src/lib/__tests__/backtest-cors.test.ts

      - name: Build
        run: npm run build

  backtest-validation:
    name: Backtest Contract Matrix
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: jarvis-sniper
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install --no-audit --no-fund
          fi
      - name: Run backtest realism contract tests
        run: |
          npm run test -- \
            src/__tests__/backtest-route-execution-realism.test.ts \
            src/__tests__/rpc-and-backtest-regressions.test.ts

  prod-dependency-risk:
    name: Production Dependency Risk
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: jarvis-sniper
    env:
      PROD_AUDIT_HIGH_BASELINE: "19"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install --no-audit --no-fund
          fi
      - name: Capture production audit
        run: npm audit --omit=dev --json > npm-audit-prod.json || true
      - name: Enforce non-regressive production risk gate
        run: |
          node -e "const fs=require('fs'); const d=JSON.parse(fs.readFileSync('npm-audit-prod.json','utf8')); const v=d.metadata?.vulnerabilities||{}; const high=Number(v.high||0); const critical=Number(v.critical||0); const baseline=Number(process.env.PROD_AUDIT_HIGH_BASELINE||19); if (critical>0){ console.error('Critical vulnerabilities present in production dependencies:', critical); process.exit(1);} if (high>baseline){ console.error('High vulnerability count regressed. high=',high,' baseline=',baseline); process.exit(1);} console.log('Production audit gate passed. high=',high,' critical=',critical,' baseline=',baseline);"
