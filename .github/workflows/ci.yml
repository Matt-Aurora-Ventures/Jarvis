name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  perps-ingress-contract:
    name: Perps Ingress Contract
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
      - name: Run canonical ingress tests
        run: |
          python -m pytest \
            tests/test_execution_intent.py \
            tests/test_runner_external_queue.py \
            tests/test_perps_api_ingress.py \
            -q

  jarvis-sniper-readiness:
    name: Jarvis Sniper Readiness
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: jarvis-sniper
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install --no-audit --no-fund
          fi
      - name: Run distributed-state + store tests
        run: |
          npm run test -- \
            src/lib/__tests__/cache-provider.test.ts \
            src/lib/__tests__/rate-limit-provider.test.ts \
            src/lib/__tests__/server-cache.test.ts \
            src/stores/__tests__/useSniperStore.test.ts
      - name: Build canonical frontend
        run: npm run build

  prod-dependency-risk:
    name: Production Dependency Risk
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: jarvis-sniper
    env:
      PROD_AUDIT_HIGH_BASELINE: "19"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install --no-audit --no-fund
          fi
      - name: Capture production audit
        run: npm audit --omit=dev --json > npm-audit-prod.json || true
      - name: Enforce non-regressive production risk gate
        run: |
          node -e "const fs=require('fs'); const d=JSON.parse(fs.readFileSync('npm-audit-prod.json','utf8')); const v=d.metadata?.vulnerabilities||{}; const high=Number(v.high||0); const critical=Number(v.critical||0); const baseline=Number(process.env.PROD_AUDIT_HIGH_BASELINE||19); if (critical>0){ console.error('Critical vulnerabilities present in production dependencies:', critical); process.exit(1);} if (high>baseline){ console.error('High vulnerability count regressed. high=',high,' baseline=',baseline); process.exit(1);} console.log('Production audit gate passed. high=',high,' critical=',critical,' baseline=',baseline);"
