"""
Security Penetration Tests for Claude CLI Integration.

Tests both Telegram and X/Twitter handlers for:
- Authorization bypass attempts
- Secret exposure in outputs
- Command injection attacks
- Rate limiting enforcement
- Input sanitization
"""

import asyncio
import pytest
import re
from unittest.mock import Mock, AsyncMock, patch

# Test the Telegram handler
from tg_bot.services.claude_cli_handler import ClaudeCLIHandler, get_claude_cli_handler

# Test the X handler
from bots.twitter.x_claude_cli_handler import XClaudeCLIHandler, get_x_claude_cli_handler


class TestTelegramSecurityPentest:
    """Security tests for Telegram Claude CLI handler."""
    
    def setup_method(self):
        """Setup for each test."""
        self.handler = ClaudeCLIHandler()
        # Set a known admin ID for testing
        self.handler.admin_ids = [123456789]
    
    # ===== AUTHORIZATION TESTS =====
    
    def test_unauthorized_user_blocked(self):
        """Non-admin users should be blocked."""
        assert not self.handler.is_admin(999999999)
        assert not self.handler.is_admin(0)
        assert not self.handler.is_admin(-1)
    
    def test_authorized_user_allowed(self):
        """Admin users should be allowed."""
        assert self.handler.is_admin(123456789)
    
    @pytest.mark.asyncio
    async def test_unauthorized_execution_rejected(self):
        """Unauthorized users cannot execute commands."""
        success, summary, output = await self.handler.execute(
            "echo test",
            user_id=999999999  # Not admin
        )
        assert not success
        assert "denied" in output.lower() or "admin" in output.lower()
    
    # ===== SECRET SANITIZATION TESTS =====
    
    def test_api_keys_redacted(self):
        """API keys should be redacted."""
        test_cases = [
            ("sk-ant-abc123def456ghi789", "[REDACTED"),
            ("xai-abc123def456ghi789jkl012", "[REDACTED"),
            ("sk-1234567890abcdefghijklmnop", "[REDACTED"),
            ("ghp_abcdefghijklmnopqrstuvwxyz123456", "[REDACTED"),
        ]
        
        for secret, expected_pattern in test_cases:
            result = self.handler.sanitize_output(f"API key: {secret}")
            assert secret not in result, f"Secret not redacted: {secret}"
            assert expected_pattern in result or "[KEY]" in result or "[REDACTED" in result
    
    def test_bot_tokens_redacted(self):
        """Telegram bot tokens should be redacted."""
        token = "123456789:ABCdefGHIjklMNOpqrSTUvwxYZ123456789"
        result = self.handler.sanitize_output(f"Bot token: {token}")
        assert token not in result
        assert "REDACTED" in result or "TOKEN" in result
    
    def test_private_keys_redacted(self):
        """Crypto private keys should be redacted."""
        # 88-char base58 (Solana keypair)
        fake_key = "5" + "A" * 86  # 87 chars
        result = self.handler.sanitize_output(f"Key: {fake_key}")
        assert fake_key not in result
    
    def test_database_urls_redacted(self):
        """Database connection strings should be redacted."""
        urls = [
            "postgresql://user:password@host:5432/db",
            "mongodb+srv://user:pass@cluster.mongodb.net",
            "redis://default:secret@redis-host:6379",
        ]
        
        for url in urls:
            result = self.handler.sanitize_output(f"DB: {url}")
            assert url not in result
            assert "REDACTED" in result or "DB_URL" in result
    
    def test_env_vars_redacted(self):
        """Environment variable assignments should be redacted."""
        test_cases = [
            "PASSWORD=supersecret123",
            "SECRET_KEY=abc123xyz",
            "API_TOKEN=mytokenvalue",
        ]
        
        for env_var in test_cases:
            result = self.handler.sanitize_output(env_var)
            # The value part should be redacted
            assert "supersecret123" not in result
            assert "abc123xyz" not in result
            assert "mytokenvalue" not in result
    
    def test_long_secrets_redacted(self):
        """Long alphanumeric strings should be caught."""
        long_secret = "A" * 50  # 50 char string
        result = self.handler.sanitize_output(f"Secret: {long_secret}")
        assert long_secret not in result
    
    # ===== COMMAND INJECTION TESTS =====
    
    def test_output_html_escaped(self):
        """HTML in output should be escaped for Telegram."""
        malicious = "<script>alert('xss')</script>"
        result = self.handler.format_for_telegram(malicious)
        assert "<script>" not in result
        assert "&lt;script&gt;" in result
    
    def test_output_truncated(self):
        """Long output should be truncated."""
        long_output = "A" * 10000
        result = self.handler.format_for_telegram(long_output)
        assert len(result) <= 4000
        assert "truncated" in result.lower()


class TestXTwitterSecurityPentest:
    """Security tests for X/Twitter Claude CLI handler."""
    
    def setup_method(self):
        """Setup for each test."""
        self.handler = XClaudeCLIHandler()
    
    # ===== AUTHORIZATION TESTS =====
    
    def test_unauthorized_username_blocked(self):
        """Non-admin usernames should be blocked."""
        assert not self.handler.is_admin("random_user")
        assert not self.handler.is_admin("hacker123")
        assert not self.handler.is_admin("")
        assert not self.handler.is_admin(None)
    
    def test_authorized_username_allowed(self):
        """Admin usernames should be allowed."""
        assert self.handler.is_admin("aurora_ventures")
        assert self.handler.is_admin("Aurora_Ventures")  # Case insensitive
        assert self.handler.is_admin("@aurora_ventures")  # With @
        assert self.handler.is_admin("matthaynes88")
    
    def test_admin_list_not_empty(self):
        """Admin list should have entries."""
        from bots.twitter.x_claude_cli_handler import ADMIN_USERNAMES
        assert len(ADMIN_USERNAMES) > 0
    
    # ===== CODING REQUEST DETECTION =====
    
    def test_coding_keywords_detected(self):
        """Coding requests should be detected."""
        coding_requests = [
            "fix the bug in autonomous_engine.py",
            "add a new endpoint for /holders",
            "create a function for sentiment analysis",
            "debug the twitter client",
            "please code a new feature",
            "run this on ralph wiggum loop",
        ]
        
        for request in coding_requests:
            assert self.handler.is_coding_request(request), f"Not detected: {request}"
    
    def test_non_coding_ignored(self):
        """Non-coding messages should not trigger."""
        non_coding = [
            "hello jarvis",
            "what's the price of SOL?",
            "good morning",
        ]
        
        for msg in non_coding:
            assert not self.handler.is_coding_request(msg), f"False positive: {msg}"
    
    # ===== SECRET SANITIZATION =====
    
    def test_secrets_sanitized(self):
        """Secrets should be sanitized in X output."""
        # Test API keys (these should be fully replaced)
        api_keys = [
            "sk-ant-secret123key456",
            "ghp_abcdefghijklmnopqrstuvwxyz123456",
        ]
        
        for secret in api_keys:
            result = self.handler.sanitize_output(f"Output: {secret}")
            assert secret not in result, f"API key not redacted: {secret}"
            assert "REDACTED" in result
        
        # Test password patterns (value should be redacted)
        password_input = "password=mysecret"
        result = self.handler.sanitize_output(f"Output: {password_input}")
        # Either the whole thing is redacted, or the value is replaced
        assert "mysecret" not in result or "REDACTED" in result, f"Password not sanitized: {result}"
    
    # ===== TWEET FORMATTING =====
    
    def test_tweet_length_limit(self):
        """Tweets should be truncated to fit."""
        long_text = "A" * 500
        result = self.handler.format_for_tweet(long_text)
        assert len(result) <= 280  # Twitter limit
        assert "..." in result
    
    def test_result_summary_concise(self):
        """Result summaries should be concise."""
        long_output = "Created file test.py\nModified utils.py\n" + "Details " * 100
        summary = self.handler.summarize_result(long_output)
        # Should have action items but be concise
        assert len(summary) < 500
    
    # ===== RATE LIMITING =====
    
    def test_daily_limit_enforced(self):
        """Daily command limit should be enforced."""
        self.handler.state.commands_executed_today = self.handler.MAX_COMMANDS_PER_DAY
        self.handler.state.last_reset_date = None  # Force no reset
        
        # After hitting limit, should be at max
        assert self.handler.state.commands_executed_today >= self.handler.MAX_COMMANDS_PER_DAY


class TestCrossHandlerSecurity:
    """Tests for security consistency across handlers."""
    
    def test_both_handlers_use_sanitization(self):
        """Both handlers should sanitize output."""
        tg_handler = ClaudeCLIHandler()
        x_handler = XClaudeCLIHandler()
        
        secret = "sk-ant-supersecretkey12345"
        
        tg_result = tg_handler.sanitize_output(secret)
        x_result = x_handler.sanitize_output(secret)
        
        assert secret not in tg_result
        assert secret not in x_result
    
    def test_both_handlers_have_admin_checks(self):
        """Both handlers should verify admin status."""
        tg_handler = ClaudeCLIHandler()
        x_handler = XClaudeCLIHandler()
        
        # Both should have is_admin method
        assert hasattr(tg_handler, 'is_admin')
        assert hasattr(x_handler, 'is_admin')
        
        # Both should reject unknown users
        assert not tg_handler.is_admin(999)  # Unknown Telegram ID
        assert not x_handler.is_admin("unknown_user")  # Unknown username


def run_pentest():
    """Run all penetration tests and report."""
    print("=" * 60)
    print("SECURITY PENETRATION TEST SUITE")
    print("=" * 60)
    
    # Telegram tests
    print("\n--- Telegram Handler Security ---")
    tg_tests = TestTelegramSecurityPentest()
    tg_tests.setup_method()
    
    tests_passed = 0
    tests_failed = 0
    
    test_methods = [m for m in dir(tg_tests) if m.startswith('test_')]
    for method_name in test_methods:
        try:
            method = getattr(tg_tests, method_name)
            if asyncio.iscoroutinefunction(method):
                asyncio.get_event_loop().run_until_complete(method())
            else:
                method()
            print(f"  ✅ {method_name}")
            tests_passed += 1
        except Exception as e:
            print(f"  ❌ {method_name}: {e}")
            tests_failed += 1
    
    # X/Twitter tests
    print("\n--- X/Twitter Handler Security ---")
    x_tests = TestXTwitterSecurityPentest()
    x_tests.setup_method()
    
    test_methods = [m for m in dir(x_tests) if m.startswith('test_')]
    for method_name in test_methods:
        try:
            method = getattr(x_tests, method_name)
            method()
            print(f"  ✅ {method_name}")
            tests_passed += 1
        except Exception as e:
            print(f"  ❌ {method_name}: {e}")
            tests_failed += 1
    
    # Cross-handler tests
    print("\n--- Cross-Handler Security ---")
    cross_tests = TestCrossHandlerSecurity()
    
    test_methods = [m for m in dir(cross_tests) if m.startswith('test_')]
    for method_name in test_methods:
        try:
            method = getattr(cross_tests, method_name)
            method()
            print(f"  ✅ {method_name}")
            tests_passed += 1
        except Exception as e:
            print(f"  ❌ {method_name}: {e}")
            tests_failed += 1
    
    print("\n" + "=" * 60)
    print(f"RESULTS: {tests_passed} passed, {tests_failed} failed")
    print("=" * 60)
    
    return tests_failed == 0


if __name__ == "__main__":
    import sys
    success = run_pentest()
    sys.exit(0 if success else 1)
