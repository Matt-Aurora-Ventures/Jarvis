# ============================================================================
# Jarvis LifeOS - Full Stack Docker Compose
# ============================================================================
# Services:
#   - jarvis-supervisor: Main Python orchestrator (trading, telegram, X)
#   - redis: State hydration and hot cache
#   - watchtower: Automatic image updates
#
# ClawdBots (separate stack): docker/clawdbot-gateway/docker-compose.yml
#   - clawdbot-friday (CMO) - Claude Opus 4.5
#   - clawdbot-matt (COO)   - Codex CLI
#   - clawdbot-jarvis (CTO) - Grok
#
# Usage:
#   docker compose up -d                    # Start full stack
#   docker compose up -d jarvis-supervisor  # Start main bot only
#   docker compose logs -f jarvis-supervisor
#   docker compose restart jarvis-supervisor
#
# Recovery:
#   docker compose down && docker compose up -d  # Full restart (~5s)
#   docker compose pull && docker compose up -d  # Update to latest
# ============================================================================

version: "3.8"

services:
  # ---------------------------------------------------------------------------
  # Jarvis Supervisor - Main Trading & AI Bot Orchestrator
  # ---------------------------------------------------------------------------
  jarvis-supervisor:
    build:
      context: .
      dockerfile: Dockerfile
    image: ghcr.io/lucid-labs/jarvis:${JARVIS_VERSION:-latest}
    container_name: jarvis-supervisor
    restart: unless-stopped
    env_file:
      - lifeos/config/.env
    environment:
      - JARVIS_HOME=/home/jarvis/Jarvis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      # Persistent state (survives container restarts)
      - ./data:/home/jarvis/Jarvis/data
      - ./bots/data:/home/jarvis/Jarvis/bots/data
      - ./bots/treasury/.positions.json:/home/jarvis/Jarvis/bots/treasury/.positions.json
      - ./bots/twitter/.grok_state.json:/home/jarvis/Jarvis/bots/twitter/.grok_state.json
      - ./logs:/home/jarvis/Jarvis/logs
      - ./backups:/home/jarvis/Jarvis/backups
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8080/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
        reservations:
          memory: 512M
          cpus: "0.5"
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    networks:
      - jarvis-network

  # ---------------------------------------------------------------------------
  # Redis - Hot State Cache & Hydration Store
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: jarvis-redis
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 300M
    networks:
      - jarvis-network

  # ---------------------------------------------------------------------------
  # Watchtower - Automatic Image Updates (Optional)
  # ---------------------------------------------------------------------------
  watchtower:
    image: containrrr/watchtower
    container_name: jarvis-watchtower
    restart: unless-stopped
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=3600  # Check every hour
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_ROLLING_RESTART=true
      - WATCHTOWER_NOTIFICATION_URL=${WATCHTOWER_NOTIFICATION_URL:-}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    profiles:
      - auto-update  # Only starts with: docker compose --profile auto-update up -d
    networks:
      - jarvis-network

  # ---------------------------------------------------------------------------
  # Health Dashboard (Optional) - Simple status page
  # ---------------------------------------------------------------------------
  health-dashboard:
    image: nginx:alpine
    container_name: jarvis-health-dashboard
    restart: unless-stopped
    ports:
      - "8888:80"
    volumes:
      - ./web/health_dashboard:/usr/share/nginx/html:ro
    profiles:
      - dashboard
    networks:
      - jarvis-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  redis-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/redis

# =============================================================================
# Networks
# =============================================================================
networks:
  jarvis-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
